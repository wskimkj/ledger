<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CSV 업로드 (Supabase · No SDK)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
    h1 { margin: 0 0 8px; }
    .muted { color:#666; font-size:12px; }
    .card { border:1px solid #e7e7e7; border-radius:16px; padding:14px; margin:12px 0; }
    input, button, select { padding:10px; border:1px solid #ccc; border-radius:12px; font-size:14px; }
    button { cursor:pointer; background:#f6f6f6; }
    button.primary { background:#111; color:#fff; border-color:#111; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    pre { white-space:pre-wrap; }
  </style>

  <script>
    // ✅ 너 프로젝트 값
    const SUPABASE_URL = "https://cqxpmfxwgrpdtxomxfiz.supabase.co";
    const SUPABASE_KEY = "sb_publishable_srN_e_EFhBbMEnPHSyu2Eg_03Mw37jS";

    const DEFAULT_LEDGER_NAME = "우리집";
    const DEFAULT_START_DATE = "2026-01-01";

    // 여러 페이지에서 공유되도록 localStorage 사용
    const LS_KEY = "ledger_session_v1";
    let session = null;     // { access_token, refresh_token, user }
    let ledgerId = null;

    const $ = (id) => document.getElementById(id);

    function setStatus(msg){ $("status").textContent = msg || ""; }
    function setError(msg){ $("error").textContent = msg || ""; }
    function log(msg){
      $("log").textContent += msg + "\n";
      $("log").scrollTop = $("log").scrollHeight;
    }

    function saveSession(s){
      session = s;
      if(s) localStorage.setItem(LS_KEY, JSON.stringify(s));
      else localStorage.removeItem(LS_KEY);
    }
    function loadSession(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    async function apiFetch(path, { method="GET", query=null, body=null, auth=true, preferReturn=true } = {}){
      const url = new URL(SUPABASE_URL + path);
      if(query){
        for(const [k,v] of Object.entries(query)){
          if(v === undefined || v === null) continue;
          url.searchParams.append(k, v); // 같은 키 중복을 위해 append
        }
      }

      const headers = { "apikey": SUPABASE_KEY };
      if(body) headers["Content-Type"] = "application/json";
      if(auth && session?.access_token) headers["Authorization"] = "Bearer " + session.access_token;
      if(preferReturn && (method==="POST" || method==="PATCH")) headers["Prefer"] = "return=representation";

      const res = await fetch(url.toString(), {
        method,
        headers,
        body: body ? JSON.stringify(body) : undefined
      });

      const text = await res.text();
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch { data = text || null; }

      if(!res.ok){
        const msg = (data && typeof data === "object")
          ? (data.message || data.error_description || JSON.stringify(data))
          : String(data);
        throw new Error(msg || `HTTP ${res.status}`);
      }
      return data;
    }

    // ---- Auth (No SDK) ----
    function parseTokensFromUrl(){
      const hash = window.location.hash || "";
      if(!hash.startsWith("#")) return null;
      const params = new URLSearchParams(hash.slice(1));
      const access_token = params.get("access_token");
      const refresh_token = params.get("refresh_token");
      if(!access_token) return null;
      return { access_token, refresh_token };
    }

    async function fetchUser(){
      return await apiFetch("/auth/v1/user", { method:"GET", auth:true, preferReturn:false });
    }

    async function sendMagicLink(email){
      const redirectTo = window.location.origin + window.location.pathname; // upload.html로 돌아옴
      await apiFetch("/auth/v1/otp", {
        method:"POST",
        auth:false,
        preferReturn:false,
        body: { email, create_user:true, options:{ emailRedirectTo: redirectTo } }
      });
    }

    async function logout(){
      saveSession(null);
      await refreshUI();
    }

    // ---- Ledger bootstrap ----
    async function ensureLedger(){
      const ledgers = await apiFetch("/rest/v1/ledgers", {
        query: { select:"id,name,created_at", order:"created_at.asc" }
      });

      if(ledgers?.length){
        ledgerId = ledgers[0].id;
        $("ledger").textContent = ledgers[0].name;
        return;
      }

      const createdArr = await apiFetch("/rest/v1/ledgers", {
        method:"POST",
        body: { name: DEFAULT_LEDGER_NAME, created_by: session.user.id }
      });
      const created = createdArr?.[0];
      if(!created?.id) throw new E
