
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>우리집 가계부</title>

  <!-- Tailwind (UI) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- xlsx -->
  <script src="./xlsx.full.min.js"></script>

  <style>

    :root{
      --bg0:#070816;
      --bg1:#0b0f22;
      --glass: rgba(255,255,255,.08);
      --glass2: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.16);
      --border2: rgba(255,255,255,.12);
      --textDim: rgba(255,255,255,.72);
      --accent: rgba(167,139,250,1); /* violet-300 */
      --accent2: rgba(236,72,153,1); /* pink-500 */
      --accent3: rgba(125,211,252,1); /* sky-300 */
    }

    body{
      background:
        radial-gradient(900px 520px at 12% 0%, rgba(167,139,250,0.18), transparent 60%),
        radial-gradient(760px 440px at 88% 8%, rgba(236,72,153,0.12), transparent 60%),
        radial-gradient(900px 520px at 70% 92%, rgba(125,211,252,0.10), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      min-height: 100vh;
    }

    /* Glass system */
    .glass{
      background: var(--glass);
      border: 1px solid var(--border);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
    }
    .glass2{
      background: var(--glass2);
      border: 1px solid var(--border2);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    /* Soft gradient border (luxury-ish) */
    .g-border{
      position: relative;
      overflow: hidden;
      border-radius: 1rem;
    }
    .g-border:before{
      content:"";
      position:absolute; inset:0;
      padding:1px;
      border-radius: 1rem;
      background: linear-gradient(135deg, rgba(167,139,250,.55), rgba(236,72,153,.30), rgba(125,211,252,.30));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
              mask-composite: exclude;
      pointer-events:none;
    }

    /* Scroll */
    .thin-scroll::-webkit-scrollbar{ height:10px; width:10px; }
    .thin-scroll::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.18); border-radius: 999px; }
    .thin-scroll::-webkit-scrollbar-track{ background: rgba(255,255,255,.06); border-radius: 999px; }

    /* Buttons */
    .btn{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .btn:hover{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.22); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px); }

    .btn-primary{
      border-color: rgba(167,139,250,.65);
      background: linear-gradient(135deg, rgba(167,139,250,.95), rgba(236,72,153,.68));
    }
    .btn-primary:hover{ filter: brightness(1.05); }

    .btn-danger{
      background: rgba(248,113,113,.18);
      border-color: rgba(248,113,113,.32);
    }
    .btn-danger:hover{ background: rgba(248,113,113,.26); }

    .pill{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
    }

    .tab-btn[data-active="true"]{
      border-color: rgba(167,139,250,.55);
      background: rgba(167,139,250,.18);
    }

    input, select{
      background: rgba(255,255,255,.06) !important;
      border-color: rgba(255,255,255,.18) !important;
      color: white !important;
      outline: none !important;
    }
    input:focus, select:focus{
      border-color: rgba(167,139,250,.65) !important;
      box-shadow: 0 0 0 3px rgba(167,139,250,.18);
    }
    option{ color:#111; }

    table th, table td { border-color: rgba(255,255,255,.10); }
    thead th{ position: sticky; top:0; backdrop-filter: blur(10px); background: rgba(10,12,28,.65); z-index: 2; }

    /* subtle row hover */
    tbody tr:hover td{ background: rgba(255,255,255,.03); }

  </style>
</head>

<body class="text-white">
  <div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div>
        <h1 class="text-3xl font-bold tracking-tight">가계부</h1>
        <div class="text-white/60 text-sm mt-1">
          Supabase 동기화 · 커버 대시보드 + 기록/수정 + 대량 업로드(템플릿) · 공란 스킵=기존값 유지 · 덮어쓰기=금액이 있을 때만 업데이트
        </div>
      </div>
      <div class="flex items-center gap-2">
        <div id="whoPill" class="pill rounded-full px-3 py-2 text-sm text-white/80 hidden"></div>
        <button id="btnLogout" class="btn btn-danger rounded-xl px-4 py-2 text-sm hidden">
          <i class="fa-solid fa-right-from-bracket mr-2"></i>로그아웃
        </button>
      </div>
    </div>

    <!-- Status -->
    <div class="mt-4 glass rounded-2xl p-4">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div class="text-sm text-white/70">
          <div>현재 장부: <span id="ledgerName" class="font-semibold text-white"></span></div>
          <div id="status" class="text-white/70 mt-1"></div>
          <div id="error" class="text-red-300 mt-1"></div>
        </div>

        <!-- Auth box -->
        <div id="authBox" class="glass2 rounded-2xl p-4 w-full md:w-[520px]">
          <div class="text-sm font-semibold mb-2">로그인</div>
          <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
            <input id="email" class="md:col-span-2 rounded-xl px-3 py-2 text-sm" type="email" placeholder="이메일" />
            <input id="password" class="md:col-span-2 rounded-xl px-3 py-2 text-sm" type="password" placeholder="비밀번호" />
            <button id="btnLogin" class="btn btn-primary rounded-xl px-3 py-2 text-sm">
              로그인
            </button>
            <button id="btnSignUp" class="btn rounded-xl px-3 py-2 text-sm md:col-span-5">
              처음이면 회원가입(메일 인증 필요할 수 있음)
            </button>
          </div>
          <div class="text-xs text-white/60 mt-2">
            * Supabase 설정에서 <b>Confirm email</b>이 켜져있으면, 가입 후 메일 인증을 해야 로그인돼.
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div id="appWrap" class="mt-5 hidden">
      <div class="flex flex-wrap gap-2">
        <button class="tab-btn btn rounded-xl px-4 py-2 text-sm" data-tab="dash" data-active="true">
          <i class="fa-solid fa-chart-line mr-2"></i>커버 대시보드
        </button>
        <button class="tab-btn btn rounded-xl px-4 py-2 text-sm" data-tab="edit" data-active="false">
          <i class="fa-solid fa-pen-to-square mr-2"></i>기록/수정
        </button>
        <button class="tab-btn btn rounded-xl px-4 py-2 text-sm" data-tab="bulk" data-active="false">
          <i class="fa-solid fa-file-arrow-up mr-2"></i>대량 업로드
        </button>
        <button class="tab-btn btn rounded-xl px-4 py-2 text-sm" data-tab="all" data-active="false">
          <i class="fa-solid fa-table mr-2"></i>전체 데이터/수정
        </button>
      </div>

      <!-- DASHBOARD -->
      <section id="tab-dash" class="mt-4">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
          <!-- slicers -->
          <div class="glass g-border rounded-2xl p-4 lg:col-span-3">
            <div class="flex items-center justify-between mb-3">
              <div class="text-sm font-semibold">슬라이서</div>
              <div class="text-[11px] text-white/60">선택 즉시 반영</div>
            </div>

            <div class="space-y-3">
              <div>
                <div class="text-xs text-white/60 mb-1">구분</div>
                <select id="slMember" class="w-full rounded-xl px-3 py-2 text-sm">
                  <option value="all">전체</option>
                </select>
              </div>

              <div class="grid grid-cols-2 gap-2">
                <div>
                  <div class="text-xs text-white/60 mb-1">연도</div>
                  <select id="slYear" class="w-full rounded-xl px-3 py-2 text-sm"></select>
                </div>
                <div>
                  <div class="text-xs text-white/60 mb-1">월</div>
                  <select id="slMonth" class="w-full rounded-xl px-3 py-2 text-sm">
                    <option value="all">전체</option>
                    <option value="01">1월</option><option value="02">2월</option><option value="03">3월</option>
                    <option value="04">4월</option><option value="05">5월</option><option value="06">6월</option>
                    <option value="07">7월</option><option value="08">8월</option><option value="09">9월</option>
                    <option value="10">10월</option><option value="11">11월</option><option value="12">12월</option>
                  </select>
                </div>
              </div>

              <div>
                <div class="text-xs text-white/60 mb-1">대분류</div>
                <select id="slCategory" class="w-full rounded-xl px-3 py-2 text-sm">
                  <option value="all">전체</option>
                </select>
              </div>

              <div>
                <div class="text-xs text-white/60 mb-1">소분류</div>
                <select id="slSubcategory" class="w-full rounded-xl px-3 py-2 text-sm">
                  <option value="all">전체</option>
                </select>
              </div>

              <div class="flex gap-2 pt-1">
                <button id="btnDashReset" class="btn rounded-xl px-4 py-2 text-sm w-full">
                  <i class="fa-solid fa-broom mr-2"></i>초기화
                </button>
              </div>

              <div class="text-xs text-white/60">
                * 모든 카드/그래프가 같이 바뀜 (커버 대시보드 느낌)
              </div>
            </div>
          </div>

          <!-- main dashboard -->
          <div class="lg:col-span-9 grid grid-cols-1 md:grid-cols-12 gap-4">
            <!-- KPI row -->
            <div class="md:col-span-12 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
              <div class="glass g-border rounded-2xl p-4">
                <div class="text-xs text-white/60 flex items-center gap-2"><i class="fa-regular fa-credit-card"></i>지출</div>
                <div class="text-2xl font-bold mt-1"><span id="kpiExpense">0</span><span class="text-base font-medium text-white/60 ml-1">원</span></div>
                <div class="text-xs text-white/55 mt-2">월평균 <span id="kpiExpenseAvg">0</span>원</div>
              </div>
              <div class="glass g-border rounded-2xl p-4">
                <div class="text-xs text-white/60 flex items-center gap-2"><i class="fa-solid fa-arrow-trend-up"></i>수입</div>
                <div class="text-2xl font-bold mt-1"><span id="kpiIncome">0</span><span class="text-base font-medium text-white/60 ml-1">원</span></div>
                <div class="text-xs text-white/55 mt-2">월평균 <span id="kpiIncomeAvg">0</span>원</div>
              </div>
              <div class="glass g-border rounded-2xl p-4">
                <div class="text-xs text-white/60 flex items-center gap-2"><i class="fa-solid fa-piggy-bank"></i>저축</div>
                <div class="text-2xl font-bold mt-1"><span id="kpiSaving">0</span><span class="text-base font-medium text-white/60 ml-1">원</span></div>
                <div class="text-xs text-white/55 mt-2">월평균 <span id="kpiSavingAvg">0</span>원</div>
              </div>
              <div class="glass g-border rounded-2xl p-4">
                <div class="text-xs text-white/60 flex items-center gap-2"><i class="fa-solid fa-wave-square"></i>순현금흐름</div>
                <div class="text-2xl font-bold mt-1"><span id="kpiNet">0</span><span class="text-base font-medium text-white/60 ml-1">원</span></div>
                <div class="text-xs text-white/55 mt-2">수입-지출-저축</div>
              </div>
              <div class="glass g-border rounded-2xl p-4">
                <div class="text-xs text-white/60 flex items-center gap-2"><i class="fa-solid fa-percent"></i>저축률</div>
                <div class="text-2xl font-bold mt-1"><span id="kpiSavingRate">0</span><span class="text-base font-medium text-white/60 ml-1">%</span></div>
                <div class="text-xs text-white/55 mt-2">저축/수입</div>
              </div>
              <div class="glass g-border rounded-2xl p-4">
                <div class="text-xs text-white/60 flex items-center gap-2"><i class="fa-regular fa-calendar"></i>최근월 지출</div>
                <div class="text-2xl font-bold mt-1"><span id="kpiThisMonthExp">0</span><span class="text-base font-medium text-white/60 ml-1">원</span></div>
                <div class="text-xs text-white/55 mt-2">전월대비 <span id="kpiMoMExp">0</span></div>
              </div>
            </div>

            <!-- Monthly mixed -->
            <div class="glass g-border rounded-2xl p-4 md:col-span-8">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold"><i class="fa-regular fa-chart-bar mr-2"></i>월별 흐름(스택) + 순현금흐름</div>
                <div class="text-xs text-white/50">필터 기준 / 최대 48개월</div>
              </div>
              <div class="mt-3 h-[290px]">
                <canvas id="chartMonthlyMixed"></canvas>
              </div>
            </div>

            <!-- Flow donut -->
            <div class="glass g-border rounded-2xl p-4 md:col-span-4">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold"><i class="fa-solid fa-chart-pie mr-2"></i>흐름 비중</div>
                <div class="text-xs text-white/50">필터 기준</div>
              </div>
              <div class="mt-3 h-[290px]">
                <canvas id="chartFlowDonut"></canvas>
              </div>
            </div>

            <!-- Category bar -->
            <div class="glass g-border rounded-2xl p-4 md:col-span-7">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold"><i class="fa-regular fa-chart-bar mr-2"></i>지출 요약 (대분류)</div>
                <div class="text-xs text-white/50">Top 12</div>
              </div>
              <div class="mt-3 h-[260px]">
                <canvas id="chartCategory"></canvas>
              </div>
            </div>

            <!-- Top10 -->
            <div class="glass g-border rounded-2xl p-4 md:col-span-5">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold"><i class="fa-solid fa-list-ol mr-2"></i>지출 Top 10</div>
                <div class="text-xs text-white/50">소분류·설명</div>
              </div>
              <div class="mt-3 h-[260px]">
                <canvas id="chartTop10"></canvas>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- EDIT -->
      <section id="tab-edit" class="mt-4 hidden">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
          <div class="glass rounded-2xl p-4 lg:col-span-4">
            <div class="text-sm font-semibold mb-3">거래 입력/수정</div>
            <form id="entryForm" class="space-y-3">
              <input type="hidden" id="editId" value="" />
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <div class="text-xs text-white/60 mb-1">날짜</div>
                  <input id="entryDate" type="date" class="w-full rounded-xl px-3 py-2 text-sm" required />
                </div>
                <div>
                  <div class="text-xs text-white/60 mb-1">구분</div>
                  <select id="memberSelect" class="w-full rounded-xl px-3 py-2 text-sm" required></select>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-2">
                <div>
                  <div class="text-xs text-white/60 mb-1">흐름</div>
                  <select id="flowType" class="w-full rounded-xl px-3 py-2 text-sm">
                    <option value="expense">지출</option>
                    <option value="income">수입</option>
                    <option value="saving">저축</option>
                  </select>
                </div>
                <div>
                  <div class="text-xs text-white/60 mb-1">금액</div>
                  <input id="amount" type="number" min="0" step="1" class="w-full rounded-xl px-3 py-2 text-sm" required />
                </div>
              </div>

              <div>
                <div class="text-xs text-white/60 mb-1">대분류</div>
                <input id="category" class="w-full rounded-xl px-3 py-2 text-sm" placeholder="예: 식비" />
              </div>

              <div>
                <div class="text-xs text-white/60 mb-1">소분류</div>
                <input id="subcategory" class="w-full rounded-xl px-3 py-2 text-sm" placeholder="예: 외식" />
              </div>

              <div>
                <div class="text-xs text-white/60 mb-1">설명/상세</div>
                <input id="detail" class="w-full rounded-xl px-3 py-2 text-sm" placeholder="예: 점심" required />
              </div>

              <div>
                <div class="text-xs text-white/60 mb-1">메모(선택)</div>
                <input id="memo" class="w-full rounded-xl px-3 py-2 text-sm" placeholder="선택" />
              </div>

              <div class="flex gap-2">
                <button id="btnSubmit" type="submit" class="btn btn-primary rounded-xl px-4 py-2 text-sm w-full">추가</button>
                <button id="btnCancelEdit" type="button" class="btn rounded-xl px-4 py-2 text-sm w-full hidden">수정 취소</button>
              </div>
            </form>
          </div>

          <div class="glass rounded-2xl p-4 lg:col-span-8">
            <div class="flex flex-wrap gap-2 items-end justify-between">
              <div>
                <div class="text-sm font-semibold">거래 목록</div>
                <div class="text-xs text-white/60 mt-1">필터로 빠르게 찾고 수정/삭제</div>
              </div>
              <div class="flex flex-wrap gap-2 items-center">
                <input id="filterFrom" type="date" class="rounded-xl px-3 py-2 text-sm" />
                <input id="filterTo" type="date" class="rounded-xl px-3 py-2 text-sm" />
                <select id="filterFlow" class="rounded-xl px-3 py-2 text-sm">
                  <option value="all">전체 흐름</option>
                  <option value="expense">지출</option>
                  <option value="income">수입</option>
                  <option value="saving">저축</option>
                </select>
                <select id="filterMember" class="rounded-xl px-3 py-2 text-sm">
                  <option value="all">전체 구분</option>
                </select>
                <input id="filterQ" class="rounded-xl px-3 py-2 text-sm" placeholder="검색(상세/메모)" />
                <button id="btnApplyFilter" class="btn btn-primary rounded-xl px-4 py-2 text-sm">적용</button>
                <button id="btnReload" class="btn rounded-xl px-4 py-2 text-sm">새로고침</button>
              </div>
            </div>

            <div class="mt-4 overflow-auto thin-scroll">
              <table class="w-full text-sm border-separate border-spacing-0">
                <thead class="text-white/70">
                  <tr>
                    <th class="text-left py-3 px-3 border-b">날짜</th>
                    <th class="text-left py-3 px-3 border-b">구분</th>
                    <th class="text-left py-3 px-3 border-b">흐름</th>
                    <th class="text-left py-3 px-3 border-b">대분류</th>
                    <th class="text-left py-3 px-3 border-b">소분류</th>
                    <th class="text-left py-3 px-3 border-b">설명</th>
                    <th class="text-right py-3 px-3 border-b">금액</th>
                    <th class="text-left py-3 px-3 border-b">메모</th>
                    <th class="text-left py-3 px-3 border-b">관리</th>
                  </tr>
                </thead>
                <tbody id="entriesTbody"></tbody>
              </table>
            </div>
            <div class="text-xs text-white/60 mt-3">총 <span id="count">0</span></div>
          </div>
        </div>
      </section>

      <!-- BULK -->
      <section id="tab-bulk" class="mt-4 hidden">
        <div class="glass rounded-2xl p-4">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <div class="text-sm font-semibold">대량 업로드</div>
              <div class="text-xs text-white/60 mt-1">
                템플릿(기록 시트) 다운로드 → 금액만 채우기 → 업로드.
                <b>날짜(A열)</b> 공란이면 선택한 월(YYYY-MM)로 자동 반영.
                <b>금액(E/F/G)</b> 공란은 스킵(기존값 유지). 금액이 있으면 덮어쓰기(upsert).
              </div>
            </div>
            <div class="flex flex-wrap gap-2 items-center">
              <div class="text-xs text-white/60">기본 월</div>
              <input id="bulkYm" type="month" class="rounded-xl px-3 py-2 text-sm" />
              <button id="btnDownloadTemplate" class="btn btn-primary rounded-xl px-4 py-2 text-sm">
                <i class="fa-solid fa-download mr-2"></i>기록 템플릿 다운로드
              </button>
            </div>
          </div>

          <div class="mt-4 glass2 rounded-2xl p-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
              <div class="flex items-center gap-3">
                <input id="bulkFile" type="file" accept=".xlsx,.xls" class="text-sm" />
                <button id="btnBulkUpload" class="btn btn-primary rounded-xl px-4 py-2 text-sm">
                  <i class="fa-solid fa-file-arrow-up mr-2"></i>업로드 실행
                </button>
              </div>
              <div class="text-xs text-white/60">
                * 업로드는 <b>entries</b> 테이블에 기록돼. (멤버=돌프/천사/공통)
              </div>
            </div>

            <div class="mt-3 text-xs text-white/60">
              업로드 규칙(중요):
              <ul class="list-disc ml-5 mt-1 space-y-1">
                <li>키(덮어쓰기 기준): ledger_id + entry_date + member_id + category + subcategory + detail + flow_type</li>
                <li>같은 키로 다시 업로드하면 <b>금액</b>만 업데이트(=덮어쓰기). 금액 공란이면 건드리지 않음.</li>
                <li>대분류가 <b>수입</b>이면 flow=income, <b>금융·저축/저축</b>이면 flow=saving, 그 외 expense</li>
              </ul>
            </div>
          </div>
        </div>
      </section>

      <!-- ALL DATA GRID -->
      <section id="tab-all" class="mt-4 hidden">
        <div class="glass rounded-2xl p-4">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <div class="text-sm font-semibold">전체 데이터(축적) + 빠른 수정</div>
              <div class="text-xs text-white/60 mt-1">
                엑셀의 DB 시트처럼 전체를 쭉 보면서, 필요한 행을 찾아 수정/삭제할 수 있어.
              </div>
            </div>
            <button id="btnAllReload" class="btn rounded-xl px-4 py-2 text-sm">
              <i class="fa-solid fa-rotate mr-2"></i>새로고침
            </button>
          </div>

          <div class="mt-4 overflow-auto thin-scroll">
            <table class="w-full text-sm border-separate border-spacing-0">
              <thead class="text-white/70">
                <tr>
                  <th class="text-left py-3 px-3 border-b">날짜</th>
                  <th class="text-left py-3 px-3 border-b">구분</th>
                  <th class="text-left py-3 px-3 border-b">흐름</th>
                  <th class="text-left py-3 px-3 border-b">대분류</th>
                  <th class="text-left py-3 px-3 border-b">소분류</th>
                  <th class="text-left py-3 px-3 border-b">설명</th>
                  <th class="text-right py-3 px-3 border-b">금액</th>
                  <th class="text-left py-3 px-3 border-b">메모</th>
                  <th class="text-left py-3 px-3 border-b">관리</th>
                </tr>
              </thead>
              <tbody id="allTbody"></tbody>
            </table>
          </div>
          <div class="text-xs text-white/60 mt-3">총 <span id="allCount">0</span></div>
        </div>
      </section>
    </div>
  </div>

<script>
/** =========================
 * 0) Project config
 * ========================= */
    // --- XLSX 로더 가드 ---
    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
    async function waitForXLSX(timeoutMs = 8000){
      const t0 = Date.now();
      while(Date.now() - t0 < timeoutMs){
        if (window.XLSX && window.XLSX.utils && window.XLSX.writeFile) return true;
        await sleep(50);
      }
      return false;
    }

const SUPABASE_URL = "https://cqxpmfxwgrpdtxomxfiz.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNxeHBtZnh3Z3JwZHR4b214Zml6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MTQ1NzAsImV4cCI6MjA4MzQ5MDU3MH0.YUGKXlqNpltt_JI_tyvgE-FhLXRILq0v7-gpLpQgo0M";

const DEFAULT_LEDGER_NAME = "우리집";
const DEFAULT_START_DATE = "2026-01-01";
const SS_KEY = "ledger_session_v2";

let session = null; // { access_token, refresh_token, user }
let currentLedgerId = null;
let membersCache = []; // {id,name,kind}
let memberNameToId = new Map();

const byId = (id) => document.getElementById(id);
const fmt = (n) => Number(n||0).toLocaleString("ko-KR");

function setStatus(msg){ byId("status").textContent = msg || ""; }
function setError(msg){ byId("error").textContent = msg || ""; }
function todayISO(){
  const d = new Date();
  const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
  return z.toISOString().slice(0,10);
}
function ymFromInput(){
  const v = (byId("bulkYm").value || "").trim();
  if(!v) return "";
  return v; // YYYY-MM
}

function saveSession(s){
  session = s;
  if(s) localStorage.setItem(SS_KEY, JSON.stringify(s));
  else localStorage.removeItem(SS_KEY);
}
function loadSession(){
  const raw = localStorage.getItem(SS_KEY);
  if(!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
}

async function apiFetch(path, { method="GET", query=null, body=null, auth=true, preferReturn=true, extraHeaders=null } = {}){
  const url = new URL(SUPABASE_URL + path);
  if(query){
    for(const [k,v] of Object.entries(query)){
      if(v === undefined || v === null) continue;
      url.searchParams.set(k, v);
    }
  }

  const headers = {
    "apikey": SUPABASE_KEY,
    "Content-Type": "application/json",
    ...(extraHeaders || {})
  };
  if(auth && session?.access_token){
    headers["Authorization"] = "Bearer " + session.access_token;
  }
  if(preferReturn && (method==="POST" || method==="PATCH")){
    headers["Prefer"] = headers["Prefer"] ? headers["Prefer"] + ", return=representation" : "return=representation";
  }

  const res = await fetch(url.toString(), {
    method,
    headers,
    body: body ? JSON.stringify(body) : undefined
  });

  const text = await res.text();
  let data = null;
  try { data = text ? JSON.parse(text) : null; } catch { data = text || null; }

  if(!res.ok){
    const msg = typeof data === "object" && data ? (data.message || data.msg || data.error_description || JSON.stringify(data)) : String(data);
    throw new Error(msg || `HTTP ${res.status}`);
  }
  return data;
}

/** =========================
 * 1) Auth (email+password)
 * ========================= */
async function loginWithPassword(email, password){
  const data = await apiFetch("/auth/v1/token", {
    method:"POST",
    auth:false,
    preferReturn:false,
    query:{ grant_type:"password" },
    body:{ email, password }
  });
  const access_token = data?.access_token;
  const refresh_token = data?.refresh_token;
  if(!access_token) throw new Error("로그인 실패: 토큰이 없어");
  saveSession({ access_token, refresh_token, user:null });
  const user = await fetchUser();
  saveSession({ ...session, user });
}

async function signUp(email, password){
  await apiFetch("/auth/v1/signup", {
    method:"POST",
    auth:false,
    preferReturn:false,
    body:{ email, password }
  });
  // 바로 로그인 시도 (confirm email이 켜져있으면 여기서 실패할 수 있음)
  await loginWithPassword(email, password);
}

async function fetchUser(){
  return await apiFetch("/auth/v1/user", { method:"GET", auth:true, preferReturn:false });
}
async function logout(){
  saveSession(null);
}

/** =========================
 * 2) DB bootstrap (ledger + members)
 * ========================= */
async function ensureDefaultLedger(){
  const ledgers = await apiFetch("/rest/v1/ledgers", {
    query: { select:"id,name,created_at", order:"created_at.asc" }
  });

  if(ledgers?.length){
    currentLedgerId = ledgers[0].id;
    byId("ledgerName").textContent = ledgers[0].name;
    return;
  }

  // ledger create
  const createdArr = await apiFetch("/rest/v1/ledgers", {
    method:"POST",
    body:{ name: DEFAULT_LEDGER_NAME, created_by: session.user.id }
  });
  const created = createdArr?.[0];
  if(!created?.id) throw new Error("장부 생성 실패");
  currentLedgerId = created.id;
  byId("ledgerName").textContent = DEFAULT_LEDGER_NAME;

  // 트리거가 있다면 owner+공통 생성됨. 없다면 아래가 필요.
  // 안전상: 시도만 하고 실패해도 무시 (이미 존재할 수 있음)
  try{
    await apiFetch("/rest/v1/ledger_members", {
      method:"POST",
      body:{ ledger_id: currentLedgerId, user_id: session.user.id, role:"owner" },
      preferReturn:false
    });
  }catch(e){}

  try{
    await apiFetch("/rest/v1/members", {
      method:"POST",
      body:{ ledger_id: currentLedgerId, name:"공통", kind:"common" },
      preferReturn:false
    });
  }catch(e){}
}

/** =========================
 * 3) Members
 * ========================= */
async function loadMembers(){
  const members = await apiFetch("/rest/v1/members", {
    query:{
      select:"id,name,kind,is_active",
      ledger_id:`eq.${currentLedgerId}`,
      is_active:"eq.true",
      order:"kind.desc,name.asc"
    }
  });

  membersCache = members || [];
  memberNameToId = new Map(membersCache.map(m => [m.name, m.id]));

  // edit form select
  const sel = byId("memberSelect");
  sel.innerHTML = "";
  for(const m of membersCache){
    const opt = document.createElement("option");
    opt.value = m.id;
    opt.textContent = `${m.name}${m.kind==="common" ? " (공통)" : ""}`;
    sel.appendChild(opt);
  }

  // filter member
  const filterMember = byId("filterMember");
  const prev = filterMember.value || "all";
  filterMember.innerHTML = `<option value="all">전체 구분</option>`;
  for(const m of membersCache){
    const opt = document.createElement("option");
    opt.value = m.id;
    opt.textContent = `${m.name}${m.kind==="common" ? " (공통)" : ""}`;
    filterMember.appendChild(opt);
  }
  filterMember.value = prev;

  // dashboard slicer member
  const slMember = byId("slMember");
  const prevM = slMember.value || "all";
  slMember.innerHTML = `<option value="all">전체</option>`;
  for(const m of membersCache){
    // 대시보드에서는 공통도 보여야 함
    const opt = document.createElement("option");
    opt.value = m.id;
    opt.textContent = m.name;
    slMember.appendChild(opt);
  }
  slMember.value = prevM;
}

/** =========================
 * 4) Entries CRUD
 * ========================= */
function getFilters(){
  return {
    from: byId("filterFrom").value || DEFAULT_START_DATE,
    to: byId("filterTo").value || todayISO(),
    flow: byId("filterFlow").value,
    memberId: byId("filterMember").value,
    q: (byId("filterQ").value || "").trim(),
  };
}

async function loadEntries(){
  const f = getFilters();
  const url = new URL(SUPABASE_URL + "/rest/v1/entries");
  url.searchParams.set("select", "id,entry_date,flow_type,amount,detail,subcategory,category,memo,member_id,created_at");
  url.searchParams.set("ledger_id", `eq.${currentLedgerId}`);
  url.searchParams.set("entry_date", `gte.${f.from}`);
  url.searchParams.append("entry_date", `lte.${f.to}`);
  if(f.flow !== "all") url.searchParams.set("flow_type", `eq.${f.flow}`);
  if(f.memberId !== "all") url.searchParams.set("member_id", `eq.${f.memberId}`);
  url.searchParams.set("order", "entry_date.desc,created_at.desc");

  const headers = {
    "apikey": SUPABASE_KEY,
    "Authorization": "Bearer " + session.access_token,
  };

  const res = await fetch(url.toString(), { headers });
  const data = await res.json();
  if(!res.ok) throw new Error(data?.message || JSON.stringify(data));

  const rows = (f.q)
    ? data.filter(r => (r.detail||"").includes(f.q) || (r.memo||"").includes(f.q))
    : data;

  renderEntries(rows);
  byId("count").textContent = `${rows.length}건`;
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function memberNameById(id){
  const m = membersCache.find(x=>x.id===id);
  return m ? m.name : "";
}

function renderEntries(rows){
  const tbody = byId("entriesTbody");
  tbody.innerHTML = "";
  for(const r of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="py-2 px-3 border-b text-white/80">${escapeHtml(r.entry_date)}</td>
      <td class="py-2 px-3 border-b text-white/80">${escapeHtml(memberNameById(r.member_id))}</td>
      <td class="py-2 px-3 border-b text-white/80">${escapeHtml(r.flow_type)}</td>
      <td class="py-2 px-3 border-b text-white/80">${escapeHtml(r.category || "")}</td>
      <td class="py-2 px-3 border-b text-white/80">${escapeHtml(r.subcategory || "")}</td>
      <td class="py-2 px-3 border-b text-white/80">${escapeHtml(r.detail || "")}</td>
      <td class="py-2 px-3 border-b text-right font-semibold">${fmt(r.amount)}</td>
      <td class="py-2 px-3 border-b text-white/70">${escapeHtml(r.memo || "")}</td>
      <td class="py-2 px-3 border-b">
        <div class="flex gap-2">
          <button class="btn rounded-lg px-3 py-1 text-xs" data-act="edit"><i class="fa-regular fa-pen-to-square mr-1"></i>수정</button>
          <button class="btn btn-danger rounded-lg px-3 py-1 text-xs" data-act="del"><i class="fa-regular fa-trash-can mr-1"></i>삭제</button>
        </div>
      </td>
    `;
    tr.querySelector('[data-act="edit"]').addEventListener("click", () => startEdit(r));
    tr.querySelector('[data-act="del"]').addEventListener("click", async () => {
      if(!confirm("삭제할까?")) return;
      await apiFetch("/rest/v1/entries", { method:"DELETE", query:{ id:`eq.${r.id}` }, preferReturn:false });
      await refreshEverything();
    });
    tbody.appendChild(tr);
  }
}

function startEdit(r){
  byId("editId").value = r.id;
  byId("entryDate").value = r.entry_date;
  byId("flowType").value = r.flow_type;
  byId("amount").value = r.amount;
  byId("detail").value = r.detail || "";
  byId("memo").value = r.memo || "";
  byId("category").value = r.category || "";
  byId("subcategory").value = r.subcategory || "";
  byId("memberSelect").value = r.member_id;
  byId("btnSubmit").textContent = "수정 저장";
  byId("btnCancelEdit").classList.remove("hidden");
}

function cancelEdit(){
  byId("editId").value = "";
  byId("btnSubmit").textContent = "추가";
  byId("btnCancelEdit").classList.add("hidden");
}

async function upsertEntryFromForm(){
  const id = byId("editId").value || null;
  const entry_date = byId("entryDate").value;
  const member_id = byId("memberSelect").value;
  const flow_type = byId("flowType").value;
  const amount = Number(byId("amount").value || 0);
  const detail = (byId("detail").value || "").trim();
  const memo = (byId("memo").value || "").trim();
  const category = (byId("category").value || "").trim();
  const subcategory = (byId("subcategory").value || "").trim();

  if(!entry_date) throw new Error("날짜를 선택해줘");
  if(!member_id) throw new Error("구분을 선택해줘");
  if(!detail) throw new Error("설명을 입력해줘");
  if(!Number.isFinite(amount) || amount < 0) throw new Error("금액을 확인해줘");

  const payload = {
    ledger_id: currentLedgerId,
    entry_date,
    member_id,
    flow_type,
    amount,
    detail,
    category: category || null,
    subcategory: subcategory || null,
    created_by: session.user.id
  };
  if(memo) payload.memo = memo;

  if(!id){
    await apiFetch("/rest/v1/entries", { method:"POST", body: payload });
  }else{
    await apiFetch("/rest/v1/entries", { method:"PATCH", query:{ id:`eq.${id}` }, body: payload });
  }

  byId("entryForm").reset();
  byId("entryDate").value = todayISO();
  cancelEdit();
}

/** =========================
 * 5) ALL DATA GRID
 * ========================= */
async function refreshAllDataGrid(){
  const url = new URL(SUPABASE_URL + "/rest/v1/entries");
  url.searchParams.set("select", "id,entry_date,flow_type,amount,detail,subcategory,category,memo,member_id,created_at");
  url.searchParams.set("ledger_id", `eq.${currentLedgerId}`);
  url.searchParams.set("order", "entry_date.desc,created_at.desc");
  url.searchParams.set("limit", "2000"); // safety

  const headers = { "apikey": SUPABASE_KEY, "Authorization": "Bearer " + session.access_token };
  const res = await fetch(url.toString(), { headers });
  const data = await res.json();
  if(!res.ok) throw new Error(data?.message || JSON.stringify(data));

  byId("allCount").textContent = `${data.length}건`;
  const tbody = byId("allTbody");
  tbody.innerHTML = "";
  for(const r of data){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="py-2 px-3 border-b text-white/80">${escapeHtml(r.entry_date)}</td>
      <td class="py-2 px-3 border-b text-white/80">${escapeHtml(memberNameById(r.member_id))}</td>
      <td class="py-2 px-3 border-b text-white/80">${escapeHtml(r.flow_type)}</td>
      <td class="py-2 px-3 border-b text-white/80">${escapeHtml(r.category||"")}</td>
      <td class="py-2 px-3 border-b text-white/80">${escapeHtml(r.subcategory||"")}</td>
      <td class="py-2 px-3 border-b text-white/80">${escapeHtml(r.detail||"")}</td>
      <td class="py-2 px-3 border-b text-right font-semibold">${fmt(r.amount)}</td>
      <td class="py-2 px-3 border-b text-white/70">${escapeHtml(r.memo||"")}</td>
      <td class="py-2 px-3 border-b">
        <div class="flex gap-2">
          <button class="btn rounded-lg px-3 py-1 text-xs" data-act="edit">수정</button>
          <button class="btn btn-danger rounded-lg px-3 py-1 text-xs" data-act="del">삭제</button>
        </div>
      </td>
    `;
    tr.querySelector('[data-act="edit"]').addEventListener("click", () => {
      // jump to edit tab with prefilled form
      switchTab("edit");
      startEdit(r);
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
    tr.querySelector('[data-act="del"]').addEventListener("click", async () => {
      if(!confirm("삭제할까?")) return;
      await apiFetch("/rest/v1/entries", { method:"DELETE", query:{ id:`eq.${r.id}` }, preferReturn:false });
      await refreshEverything();
    });
    tbody.appendChild(tr);
  }
}

/** =========================
 * 6) BULK TEMPLATE + UPLOAD (Multi-sheet)
 *    - Workbook may contain multiple sheets:
 *      * 기록_YYYY-MM  (권장)
 *      * 기록          (fallback to "기본 월" when 날짜가 비어있을 때만)
 *    - Headers must include: [날짜, 대분류, 소분류, 설명, 돌프, 천사, 공통]
 *    - 날짜 공란: 시트명(기록_YYYY-MM) → 기본 월 → (없으면 에러)
 *    - 금액 공란: 스킵(기존 값 유지)
 *    - 금액 있음: UPSERT(덮어쓰기)
 * ========================= */
const TEMPLATE_ROWS = [
  // category, subcategory, detail
  ["식비","식재료",""],
  ["식비","외식",""],
  ["식비","배달",""],
  ["식비","중식",""],
  ["식비","카페/간식",""],
  ["소비 생활","쇼핑","의류·잡화·화장품 등"],
  ["소비 생활","미용","미용실·네일·시술 등"],
  ["소비 생활","구독","넷플릭스·유튜브·멤버십 등"],
  ["소비 생활","생활편의","생필품·가전·인테리어 등"],
  ["문화여가","여행","항공·숙박·교통·입장권"],
  ["문화여가","문화생활","영화·공연·전시·도서·게임"],
  ["문화여가","운동","헬스·PT·요가·필라테스·수영"],
  ["건강·관리","보험","생명·건강·자동차"],
  ["건강·관리","병원·약국","진료·약·검진"],
  ["건강·관리","건강식품","비타민·보충제"],
  ["인간관계","회비","동호회·가족·동창"],
  ["인간관계","경조/선물","경조사·기념일"],
  ["인간관계","친목","모임·회식"],
  ["예비/기타","기부","후원"],
  ["예비/기타","기타","비정기 지출"],
  ["필수 생활","주거/통신","관리비·공과금·휴대폰·인터넷"],
  ["필수 생활","교통","대중교통·택시·차량유지"],
  ["필수 생활","공과금","세금·지방세·재활용"],
  ["금융·저축","저축","적금·CMA·청약"],
  ["금융·저축","투자","주식·ETF·코인"],
  ["금융·저축","부채상환","카드값·대출·이자"],
  ["수입","월급","월급"],
  ["수입","기타수입",""],
  ["수입","금융이자",""],
  ["수입","주식매도",""]
];

function makeGuideSheet(){
  const rows = [
    ["우리집 가계부 · 대량 업로드 가이드"],
    [""],
    ["1) 시트 이름 규칙 (추천)"],
    ["   - 기록_YYYY-MM  예) 기록_2026-06, 기록_2026-07 ..."],
    ["   - 같은 파일에 여러 달을 넣고 싶으면, 시트를 복사해서 이름만 바꾸면 끝!"],
    [""],
    ["2) 입력 규칙"],
    ["   - 헤더는 반드시: 날짜, 대분류, 소분류, 설명, 돌프, 천사, 공통"],
    ["   - 날짜(A열) 공란이면: 시트명(기록_YYYY-MM) → 기본 월(화면에서 선택) 순으로 적용"],
    ["   - 금액(E/F/G) 공란은 스킵(기존값 유지). 금액이 있으면 덮어쓰기(upsert)"],
    [""],
    ["3) 덮어쓰기(업서트) 기준 키"],
    ["   ledger_id + entry_date + member_id + category + subcategory + detail + flow_type"],
    [""],
    ["Tip) 엑셀에서 쓰기 맛깔나게"],
    ["   - 같은 행에서 돌프/천사/공통 중 필요한 칸만 입력해도 돼요"],
    ["   - ‘설명’은 거래를 구분하는 핵심 키라서 가능하면 구체적으로 써줘요 (예: 점심/마트/택시)"],
  ];

  const ws = XLSX.utils.aoa_to_sheet(rows);
  ws["!cols"] = [{wch:70}];
  ws["!merges"] = [{ s:{r:0,c:0}, e:{r:0,c:0} }];
  return ws;
}

function makeRecordSheet(ym){
  const rows = [];

  // Title / subtitle
  rows.push([`기록 템플릿 (${ym})`]);
  rows.push(["날짜 공란이면 이 시트의 월(YYYY-MM)로 자동 반영 · 금액 공란은 스킵(기존값 유지)"]);
  rows.push([""]);
  rows.push(["날짜","대분류","소분류","설명","돌프","천사","공통"]);

  for(const [cat, sub, desc] of TEMPLATE_ROWS){
    rows.push(["", cat, sub, desc || "", "", "", ""]);
  }

  const ws = XLSX.utils.aoa_to_sheet(rows);

  // column widths
  ws["!cols"] = [
    {wch:14},{wch:16},{wch:16},{wch:34},{wch:12},{wch:12},{wch:12}
  ];

  // merges for title/subtitle
  ws["!merges"] = [
    { s:{r:0,c:0}, e:{r:0,c:6} },
    { s:{r:1,c:0}, e:{r:1,c:6} },
    { s:{r:2,c:0}, e:{r:2,c:6} }
  ];

  return ws;
}

async function downloadMonthlyTemplate(){
  const ok = await waitForXLSX();
  if(!ok){
    setError("xlsx 라이브러리 로딩이 안 됐어. xlsx.full.min.js 파일이 index.html(이 파일)과 같은 폴더에 있는지 확인해줘.");
    return;
  }

  setError("");
  if(!window.XLSX) { setError("xlsx 라이브러리 로딩이 안 됐어. 인터넷 차단 여부 확인해줘."); return; }

  const ym = ymFromInput() || new Date().toISOString().slice(0,7);

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, makeGuideSheet(), "가이드");
  XLSX.utils.book_append_sheet(wb, makeRecordSheet(ym), `기록_${ym}`);

  const fname = `record_template_${ym.replace("-","")}.xlsx`;
  XLSX.writeFile(wb, fname);
}

function detectHeaderRow(rows){
  const needed = ["날짜","대분류","소분류","설명","돌프","천사","공통"];
  for(let i=0;i<Math.min(rows.length, 30);i++){
    const row = (rows[i] || []).map(v => String(v||"").trim());
    const ok = needed.every(h => row.includes(h));
    if(ok) return i;
  }
  return -1;
}

function flowFromCategory(cat){
  const c = (cat||"").trim();
  if(c === "수입") return "income";
  if(c === "금융·저축" || c === "저축" || c === "금융/저축") return "saving";
  return "expense";
}

function parseYmFromSheetName(name){
  // Accept: 기록_2026-06, 기록 2026-06, 기록-2026-06, 기록_2026.06
  const m = String(name||"").match(/기록(?:[_\s-])(\d{4})[-.](\d{2})/);
  if(!m) return "";
  return `${m[1]}-${m[2]}`;
}

function normalizeDate(v, fallbackYm){
  // 1) JS Date
  if (v instanceof Date && !isNaN(v)) {
    const z = new Date(v.getTime() - v.getTimezoneOffset()*60000);
    return z.toISOString().slice(0,10);
  }

  // 2) Excel serial number
  if (typeof v === "number" && Number.isFinite(v)) {
    const d = XLSX.SSF.parse_date_code(v);
    if(d) return `${d.y}-${String(d.m).padStart(2,"0")}-${String(d.d).padStart(2,"0")}`;
  }

  const s = String(v ?? "").trim();
  if(!s) return (fallbackYm ? fallbackYm + "-01" : "");

  // Full date patterns -> fallbackYm 무시
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  if(/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(s)){
    const [y,m,d] = s.split("/").map(Number);
    return `${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
  }
  if(/^\d{4}\.\d{1,2}\.\d{1,2}$/.test(s)){
    const [y,m,d] = s.split(".").map(Number);
    return `${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
  }

  // Partial date -> need fallbackYm
  if(fallbackYm){
    const y = fallbackYm.slice(0,4);

    // "MM-DD"
    if(/^\d{2}-\d{2}$/.test(s)) return `${y}-${s}`;

    // "M/D"
    if(/^\d{1,2}\/\d{1,2}$/.test(s)){
      const [m,d] = s.split("/").map(x=>String(Number(x)).padStart(2,"0"));
      return `${y}-${m}-${d}`;
    }
  }

  return fallbackYm ? fallbackYm + "-01" : "";
}

async function bulkUpload(){
  const ok = await waitForXLSX();
  if(!ok){
    setError("xlsx 라이브러리 로딩이 안 됐어. xlsx.full.min.js 파일이 index.html(이 파일)과 같은 폴더에 있는지 확인해줘.");
    return;
  }

  setError("");
  const file = byId("bulkFile").files?.[0];
  if(!file) throw new Error("엑셀 파일을 선택해줘");

  const defaultYm = ymFromInput(); // optional now
  if(!window.XLSX) throw new Error("xlsx 라이브러리 로딩이 안 됐어. (CDN 차단/오프라인)");

  setStatus("엑셀 읽는 중...");
  const data = await file.arrayBuffer();
  const wb = XLSX.read(data, { type:"array", cellDates:true });

  const sheetNames = wb.SheetNames.filter(n => n === "기록" || String(n).startsWith("기록_") || String(n).startsWith("기록 ") || String(n).startsWith("기록-"));
  if(!sheetNames.length) throw new Error("업로드할 시트를 찾을 수 없어. 시트 이름을 '기록_YYYY-MM' 형태로 만들어줘. (예: 기록_2026-06)");

  // ensure members exist
  const findMemberId = (name)=>{
    const list = membersCache.filter(m => m.name === name);
    if(!list.length) return null;
    if(name==="공통") return (list.find(m=>m.kind==="common") || list[0]).id;
    return list[0].id;
  };
  const dolId = findMemberId("돌프");
  const angId = findMemberId("천사");
  const comId = findMemberId("공통");
  if(!dolId || !angId || !comId){
    throw new Error("members에 '돌프/천사/공통'이 모두 있어야 해. (members 테이블에 추가/활성화 확인)");
  }

  const toUpsert = [];
  let scannedSheets = 0;

  for(const sheetName of sheetNames){
    const sheet = wb.Sheets[sheetName];
    if(!sheet) continue;

    const sheetYm = parseYmFromSheetName(sheetName);
    const fallbackYm = sheetYm || defaultYm || "";

    const rows = XLSX.utils.sheet_to_json(sheet, { header:1, defval:"" });
    if(rows.length < 2) continue;

    const headerRow = detectHeaderRow(rows);
    if(headerRow < 0) throw new Error(`시트 '${sheetName}'에서 헤더(날짜/대분류/소분류/설명/돌프/천사/공통)를 찾을 수 없어. 템플릿 형식을 그대로 써줘.`);

    const header = rows[headerRow].map(h => String(h).trim());
    const idx = (name)=> header.findIndex(h => h === name);

    const iDate = idx("날짜");
    const iCat = idx("대분류");
    const iSub = idx("소분류");
    const iDetail = idx("설명");
    const iDol = idx("돌프");
    const iAng = idx("천사");
    const iCom = idx("공통");

    const need = [iDate,iCat,iSub,iDetail,iDol,iAng,iCom];
    if(need.some(i => i < 0)) throw new Error(`시트 '${sheetName}'의 템플릿 헤더가 누락됨.`);

    scannedSheets++;

    for(let r=headerRow+1; r<rows.length; r++){
      const row = rows[r] || [];

      const dateCell = row[iDate];
      const hasDate = String(dateCell ?? "").trim() !== "";
      const entry_date = hasDate
        ? normalizeDate(dateCell, fallbackYm)
        : (fallbackYm ? (fallbackYm + "-01") : "");

      if(!entry_date){
        throw new Error(`시트 '${sheetName}'에 날짜 공란 행이 있는데 월 정보가 없어. (1) 시트명을 기록_YYYY-MM 로 바꾸거나 (2) 업로드 화면에서 '기본 월'을 선택해줘.`);
      }

      const category = String(row[iCat] ?? "").trim();
      const subcategory = String(row[iSub] ?? "").trim();
      const detail = String(row[iDetail] ?? "").trim();

      const dolRaw = row[iDol];
      const angRaw = row[iAng];
      const comRaw = row[iCom];

      const hasAny = [dateCell,category,subcategory,detail,dolRaw,angRaw,comRaw].some(v => String(v??"").trim() !== "");
      if(!hasAny) continue;

      if(!category && !subcategory && !detail) continue;

      const flow_type = flowFromCategory(category);

      const pushIfAmount = (member_id, amtRaw)=>{
        const s = String(amtRaw ?? "").trim();
        if(s === "") return; // 공란 스킵
        const amount = Number(s.replaceAll(",",""));
        if(!Number.isFinite(amount) || amount < 0) return;

        toUpsert.push({
          ledger_id: currentLedgerId,
          entry_date,
          member_id,
          flow_type,
          amount,
          detail: detail || "(미입력)",
          category: category || null,
          subcategory: subcategory || null,
          created_by: session.user.id
        });
      };

      pushIfAmount(dolId, dolRaw);
      pushIfAmount(angId, angRaw);
      pushIfAmount(comId, comRaw);
    }
  }

  if(!scannedSheets) throw new Error("업로드 가능한 '기록' 시트가 없어.");
  if(!toUpsert.length){
    setStatus("업로드할 유효 행이 없어(금액이 전부 공란이면 스킵됨).");
    return;
  }

  setStatus(`업로드 중... (${toUpsert.length}건 / ${scannedSheets}개 시트)`);

  const onConflict = "ledger_id,entry_date,member_id,flow_type,category,subcategory,detail";

  const chunk = 500;
  for(let i=0;i<toUpsert.length;i+=chunk){
    const part = toUpsert.slice(i, i+chunk);
    await apiFetch("/rest/v1/entries", {
      method:"POST",
      query:{ on_conflict: onConflict },
      body: part,
      preferReturn:false,
      extraHeaders:{ "Prefer":"resolution=merge-duplicates" }
    });
    await sleep(80);
  }

  setStatus("업로드 완료!");
  await refreshEverything();
}

/** =========================
 * 7) Dashboard (cover-like) - upgraded
 * ========================= */
let chartCategory = null;
let chartTop10 = null;
let chartMonthlyMixed = null;
let chartFlowDonut = null;

function dashFilters(){
  return {
    memberId: byId("slMember").value,
    year: byId("slYear").value,
    month: byId("slMonth").value,
    category: byId("slCategory").value,
    subcategory: byId("slSubcategory").value
  };
}

function buildDashPredicate(f){
  return (r)=>{
    const d = r.entry_date;
    const y = d.slice(0,4);
    const m = d.slice(5,7);

    if(f.memberId !== "all" && r.member_id !== f.memberId) return false;
    if(f.year !== "all" && y !== f.year) return false;
    if(f.month !== "all" && m !== f.month) return false;
    if(f.category !== "all" && (r.category||"") !== f.category) return false;
    if(f.subcategory !== "all" && (r.subcategory||"") !== f.subcategory) return false;
    return true;
  };
}

async function fetchAllEntriesForDash(){
  const url = new URL(SUPABASE_URL + "/rest/v1/entries");
  url.searchParams.set("select", "entry_date,flow_type,amount,category,subcategory,detail,member_id");
  url.searchParams.set("ledger_id", `eq.${currentLedgerId}`);
  url.searchParams.set("order", "entry_date.asc");
  url.searchParams.set("limit", "8000");

  const headers = { "apikey": SUPABASE_KEY, "Authorization": "Bearer " + session.access_token };
  const res = await fetch(url.toString(), { headers });
  const data = await res.json();
  if(!res.ok) throw new Error(data?.message || JSON.stringify(data));
  return data || [];
}

function computeMonthlyBuckets(rows, pred){
  const map = new Map(); // monthKey -> {expense,income,saving}
  for(const r of rows){
    if(!pred(r)) continue;
    const mk = r.entry_date.slice(0,7);
    const o = map.get(mk) || { expense:0, income:0, saving:0 };
    o[r.flow_type] = (o[r.flow_type] || 0) + Number(r.amount||0);
    map.set(mk, o);
  }
  const keys = [...map.keys()].sort();
  return { keys, map };
}

function computeKpis(rows, pred){
  let expense=0,income=0,saving=0;
  const monthsSet = new Set();
  for(const r of rows){
    if(!pred(r)) continue;
    monthsSet.add(r.entry_date.slice(0,7));
    if(r.flow_type==="expense") expense += Number(r.amount||0);
    else if(r.flow_type==="income") income += Number(r.amount||0);
    else if(r.flow_type==="saving") saving += Number(r.amount||0);
  }
  const months = Math.max(1, monthsSet.size);
  const net = income - expense - saving;
  const savingRate = income > 0 ? (saving / income) * 100 : 0;

  return {
    expense, income, saving, net,
    savingRate,
    expenseAvg: Math.round(expense/months),
    incomeAvg: Math.round(income/months),
    savingAvg: Math.round(saving/months),
  };
}

function computeCategoryExpense(rows, pred){
  const map = new Map();
  for(const r of rows){
    if(!pred(r)) continue;
    if(r.flow_type !== "expense") continue;
    const k = (r.category || "미분류");
    map.set(k, (map.get(k)||0) + Number(r.amount||0));
  }
  return [...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,12);
}

function computeTop10(rows, pred){
  const map = new Map();
  for(const r of rows){
    if(!pred(r)) continue;
    if(r.flow_type !== "expense") continue;
    const k = (r.subcategory || "미분류") + (r.detail ? ` · ${r.detail}` : "");
    map.set(k, (map.get(k)||0) + Number(r.amount||0));
  }
  return [...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
}

function updateDashDropdowns(rows){
  const years = [...new Set(rows.map(r => r.entry_date.slice(0,4)))].sort();
  const slYear = byId("slYear");
  const prev = slYear.value || "all";
  slYear.innerHTML = `<option value="all">전체</option>` + years.map(y=>`<option value="${y}">${y}년</option>`).join("");
  slYear.value = years.includes(prev) ? prev : "all";

  const cats = [...new Set(rows.map(r => (r.category||"").trim()).filter(Boolean))].sort();
  const slCategory = byId("slCategory");
  const prevC = slCategory.value || "all";
  slCategory.innerHTML = `<option value="all">전체</option>` + cats.map(c=>`<option value="${escapeHtmlAttr(c)}">${escapeHtmlText(c)}</option>`).join("");
  slCategory.value = cats.includes(prevC) ? prevC : "all";

  const subs = [...new Set(rows.map(r => (r.subcategory||"").trim()).filter(Boolean))].sort();
  const slSub = byId("slSubcategory");
  const prevS = slSub.value || "all";
  slSub.innerHTML = `<option value="all">전체</option>` + subs.map(s=>`<option value="${escapeHtmlAttr(s)}">${escapeHtmlText(s)}</option>`).join("");
  slSub.value = subs.includes(prevS) ? prevS : "all";
}
function escapeHtmlAttr(s){ return String(s).replaceAll('"','&quot;'); }
function escapeHtmlText(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

function pickCurrentMonthKey(keys, f){
  if(f.year !== "all" && f.month !== "all") return `${f.year}-${f.month}`;
  return keys.length ? keys[keys.length-1] : null;
}

function fmtPct(v){
  if(!Number.isFinite(v)) return "0%";
  const sign = v > 0 ? "+" : "";
  return `${sign}${Math.round(v)}%`;
}

async function refreshDashboard(){
  const rows = await fetchAllEntriesForDash();
  updateDashDropdowns(rows);

  const f = dashFilters();
  const pred = buildDashPredicate(f);

  // KPIs
  const k = computeKpis(rows, pred);
  byId("kpiExpense").textContent = fmt(k.expense);
  byId("kpiIncome").textContent = fmt(k.income);
  byId("kpiSaving").textContent = fmt(k.saving);
  byId("kpiNet").textContent = fmt(k.net);
  byId("kpiSavingRate").textContent = (k.savingRate || 0).toFixed(0);
  byId("kpiExpenseAvg").textContent = fmt(k.expenseAvg);
  byId("kpiIncomeAvg").textContent = fmt(k.incomeAvg);
  byId("kpiSavingAvg").textContent = fmt(k.savingAvg);

  // Monthly buckets (cap 48 months for readability)
  const { keys: allKeys, map } = computeMonthlyBuckets(rows, pred);
  const keys = allKeys.slice(Math.max(0, allKeys.length - 48));

  const exp = keys.map(mk=> (map.get(mk)?.expense)||0);
  const inc = keys.map(mk=> (map.get(mk)?.income)||0);
  const sav = keys.map(mk=> (map.get(mk)?.saving)||0);
  const net = keys.map((mk,i)=> (inc[i] - exp[i] - sav[i]));

  // "최근월 지출" + 전월대비
  const cur = pickCurrentMonthKey(keys, f);
  const curIdx = cur ? keys.indexOf(cur) : -1;
  const curExp = (curIdx>=0) ? exp[curIdx] : 0;
  const prevExp = (curIdx>0) ? exp[curIdx-1] : 0;
  const mom = prevExp > 0 ? ((curExp - prevExp) / prevExp) * 100 : 0;

  byId("kpiThisMonthExp").textContent = fmt(curExp);
  byId("kpiMoMExp").textContent = (curIdx>0) ? fmtPct(mom) : "—";

  // Category bar
  const catArr = computeCategoryExpense(rows, pred);
  const catLabels = catArr.map(x=>x[0]);
  const catVals = catArr.map(x=>x[1]);

  if(chartCategory) chartCategory.destroy();
  chartCategory = new Chart(byId("chartCategory"), {
    type:"bar",
    data:{ labels: catLabels, datasets:[{ label:"지출", data: catVals, borderRadius: 10 }] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(ctx)=> `${fmt(ctx.raw)} 원` } } },
      scales:{
        x:{ ticks:{ color:"rgba(255,255,255,.75)" }, grid:{ color:"rgba(255,255,255,.07)" } },
        y:{ ticks:{ color:"rgba(255,255,255,.75)", callback:(v)=> fmt(v) }, grid:{ color:"rgba(255,255,255,.07)" } }
      }
    }
  });

  // Top10 horizontal bar
  const topArr = computeTop10(rows, pred);
  const topLabels = topArr.map(x=>x[0]).reverse();
  const topVals = topArr.map(x=>x[1]).reverse();

  if(chartTop10) chartTop10.destroy();
  chartTop10 = new Chart(byId("chartTop10"), {
    type:"bar",
    data:{ labels: topLabels, datasets:[{ label:"지출", data: topVals, borderRadius: 10 }] },
    options:{
      indexAxis:"y",
      responsive:true,
      maintainAspectRatio:false,
      plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(ctx)=> `${fmt(ctx.raw)} 원` } } },
      scales:{
        x:{ ticks:{ color:"rgba(255,255,255,.75)", callback:(v)=> fmt(v) }, grid:{ color:"rgba(255,255,255,.07)" } },
        y:{ ticks:{ color:"rgba(255,255,255,.75)" }, grid:{ color:"rgba(255,255,255,.07)" } }
      }
    }
  });

  // Flow donut
  const flowTotals = {
    expense: k.expense,
    income: k.income,
    saving: k.saving
  };
  if(chartFlowDonut) chartFlowDonut.destroy();
  chartFlowDonut = new Chart(byId("chartFlowDonut"), {
    type: "doughnut",
    data:{
      labels:["지출","수입","저축"],
      datasets:[{
        data:[flowTotals.expense, flowTotals.income, flowTotals.saving],
        borderWidth: 1
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      cutout:"68%",
      plugins:{
        legend:{ position:"bottom", labels:{ color:"rgba(255,255,255,.85)", boxWidth: 10 } },
        tooltip:{ callbacks:{ label:(ctx)=> `${ctx.label}: ${fmt(ctx.raw)} 원` } }
      }
    }
  });

  // Monthly mixed (stacked bars + net line)
  if(chartMonthlyMixed) chartMonthlyMixed.destroy();
  chartMonthlyMixed = new Chart(byId("chartMonthlyMixed"), {
    data:{
      labels: keys,
      datasets:[
        { type:"bar", label:"지출", data: exp, stack:"stack1", borderRadius: 10 },
        { type:"bar", label:"수입", data: inc, stack:"stack1", borderRadius: 10 },
        { type:"bar", label:"저축", data: sav, stack:"stack1", borderRadius: 10 },
        { type:"line", label:"순현금흐름", data: net, tension: .25, yAxisID:"y" }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{ labels:{ color:"rgba(255,255,255,.85)" } },
        tooltip:{ callbacks:{ label:(ctx)=> `${ctx.dataset.label}: ${fmt(ctx.raw)} 원` } }
      },
      scales:{
        x:{ stacked:true, ticks:{ color:"rgba(255,255,255,.75)" }, grid:{ color:"rgba(255,255,255,.07)" } },
        y:{ stacked:true, ticks:{ color:"rgba(255,255,255,.75)", callback:(v)=> fmt(v) }, grid:{ color:"rgba(255,255,255,.07)" } }
      }
    }
  });
}

/** =========================
 * 8) Tabs
 * ========================= */
function switchTab(tab){
  for(const b of document.querySelectorAll(".tab-btn")){
    const on = b.dataset.tab === tab;
    b.dataset.active = on ? "true" : "false";
  }
  for(const sec of ["dash","edit","bulk","all"]){
    byId(`tab-${sec}`).classList.toggle("hidden", sec !== tab);
  }
}

document.addEventListener("click", (e)=>{
  const btn = e.target.closest(".tab-btn");
  if(!btn) return;
  switchTab(btn.dataset.tab);
});

/** =========================
 * 9) Refresh all
 * ========================= */
async function refreshEverything(){
  await loadMembers();
  await loadEntries();
  await refreshDashboard();
  await refreshAllDataGrid();
}

async function refreshUI(){
  const authed = !!(session?.access_token && session?.user?.id);

  byId("authBox").classList.toggle("hidden", authed);
  byId("appWrap").classList.toggle("hidden", !authed);
  byId("btnLogout").classList.toggle("hidden", !authed);
  byId("whoPill").classList.toggle("hidden", !authed);

  if(!authed){
    byId("ledgerName").textContent = "";
    byId("whoPill").textContent = "";
    setStatus("로그인 상태가 아니야.");
    return;
  }

  byId("whoPill").textContent = `로그인: ${session.user.email}`;

  // defaults
  if(!byId("filterFrom").value) byId("filterFrom").value = DEFAULT_START_DATE;
  if(!byId("filterTo").value) byId("filterTo").value = todayISO();
  if(!byId("entryDate").value) byId("entryDate").value = todayISO();
  if(!byId("bulkYm").value) byId("bulkYm").value = new Date().toISOString().slice(0,7);

  setStatus("로그인됨. 장부 확인 중...");
  await ensureDefaultLedger();
  setStatus("데이터 로딩 중...");
  await refreshEverything();
  setStatus("준비 완료!");
}

/** =========================
 * 10) Boot
 * ========================= */
window.addEventListener("DOMContentLoaded", async ()=>{
  try{
    const s = loadSession();
    if(s) session = s;

    // if token exists but user missing, fetch user
    if(session?.access_token && !session.user){
      try{
        const user = await fetchUser();
        saveSession({ ...session, user });
      }catch(e){
        // expired token etc
        saveSession(null);
      }
    }

    // bind auth
    byId("btnLogin").addEventListener("click", async ()=>{
      try{
        setError("");
        setStatus("로그인 중...");
        const email = (byId("email").value||"").trim();
        const pw = (byId("password").value||"").trim();
        if(!email || !pw) throw new Error("이메일/비밀번호를 입력해줘");
        await loginWithPassword(email, pw);
        await refreshUI();
      }catch(e){
        setError(e?.message || String(e));
        setStatus("");
      }
    });

    byId("btnSignUp").addEventListener("click", async ()=>{
      try{
        setError("");
        setStatus("회원가입 중...");
        const email = (byId("email").value||"").trim();
        const pw = (byId("password").value||"").trim();
        if(!email || !pw) throw new Error("이메일/비밀번호를 입력해줘");
        await signUp(email, pw);
        await refreshUI();
      }catch(e){
        setError(e?.message || String(e));
        setStatus("");
      }
    });

    byId("btnLogout").addEventListener("click", async ()=>{
      await logout();
      await refreshUI();
    });

    // edit form
    byId("entryForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      try{
        setError("");
        setStatus("저장 중...");
        await upsertEntryFromForm();
        await refreshEverything();
        setStatus("저장 완료!");
      }catch(err){
        setError(err?.message || String(err));
        setStatus("");
      }
    });
    byId("btnCancelEdit").addEventListener("click", ()=> cancelEdit());

    // list filters
    byId("btnReload").addEventListener("click", async ()=>{ try{ setError(""); await loadEntries(); }catch(e){ setError(e.message); } });
    byId("btnApplyFilter").addEventListener("click", async ()=>{ try{ setError(""); await loadEntries(); }catch(e){ setError(e.message); } });

    // dashboard actions (auto-apply)
    const dashIds = ["slMember","slYear","slMonth","slCategory","slSubcategory"];
    let dashTimer = null;
    const scheduleDash = ()=>{
      clearTimeout(dashTimer);
      dashTimer = setTimeout(async ()=>{
        try{ setError(""); await refreshDashboard(); }catch(e){ setError(e.message); }
      }, 120);
    };
    for(const id of dashIds){
      const el = byId(id);
      if(el) el.addEventListener("change", scheduleDash);
    }

    byId("btnDashReset").addEventListener("click", async ()=>{
      byId("slMember").value = "all";
      byId("slYear").value = "all";
      byId("slMonth").value = "all";
      byId("slCategory").value = "all";
      byId("slSubcategory").value = "all";
      scheduleDash();
    });

    // bulk
    byId("btnDownloadTemplate").addEventListener("click", ()=>{
      try{ downloadMonthlyTemplate(); }catch(e){ setError(e.message); }
    });
    byId("btnBulkUpload").addEventListener("click", async ()=>{
      try{
        setError("");
        await bulkUpload();
      }catch(e){
        setError(e?.message || String(e));
      }
    });

    // all tab
    byId("btnAllReload").addEventListener("click", async ()=>{
      try{ setError(""); await refreshAllDataGrid(); }catch(e){ setError(e.message); }
    });

    // sync across tabs
    window.addEventListener("storage", async (e)=>{
      if(e.key !== SS_KEY) return;
      session = loadSession();
      try{
        if(session?.access_token && !session.user){
          const user = await fetchUser();
          saveSession({ ...session, user });
        }
      }catch(_){}
      await refreshUI();
    });

    await refreshUI();
  }catch(e){
    console.error(e);
    setError(e?.message || String(e));
  }
});
</script>
</body>
</html>
