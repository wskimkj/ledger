
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>우리집 가계부 · Master 고정 (Final)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <!-- SheetJS (XLSX). If blocked, CSV fallback is used. -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg0:#f7f7ff;
      --bg1:#ffffffcc;
      --ink:#0b1220;
      --muted:rgba(11,18,32,.62);
      --line:rgba(99,102,241,.22);
      --shadow: 0 18px 55px rgba(17,24,39,.10);
      --grad: linear-gradient(135deg, #7c3aed, #2563eb, #06b6d4);
      --grad2: linear-gradient(135deg, #fb7185, #a78bfa, #22c55e);
    }
    body{
      color: var(--ink);
      background:
        radial-gradient(900px 520px at 12% 0%, rgba(124,58,237,.16), transparent 60%),
        radial-gradient(900px 520px at 92% 10%, rgba(37,99,235,.16), transparent 60%),
        radial-gradient(860px 520px at 50% 96%, rgba(34,197,94,.12), transparent 60%),
        var(--bg0);
    }
    .glass{
      background: var(--bg1);
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
    }
    .btn{
      border: 1px solid rgba(99,102,241,.22);
      background: rgba(255,255,255,.78);
      transition: transform .08s ease, filter .12s ease, background .12s ease;
    }
    .btn:hover{ background: rgba(255,255,255,.95); transform: translateY(-1px); }
    .btn-primary{
      color: white !important;
      border-color: rgba(99,102,241,.22);
      background: var(--grad);
    }
    .btn-primary:hover{ filter: brightness(1.03); }
    .btn-danger{
      border-color: rgba(239,68,68,.25);
      background: rgba(239,68,68,.10);
      color: rgba(153,27,27,.98) !important;
    }
    .pill{
      border: 1px solid rgba(124,58,237,.22);
      background: rgba(124,58,237,.08);
    }
    .tab[data-active="true"]{
      background: rgba(124,58,237,.10);
      border-color: rgba(124,58,237,.30);
    }
    .thin-scroll::-webkit-scrollbar{ height:10px; width:10px; }
    .thin-scroll::-webkit-scrollbar-thumb{ background: rgba(124,58,237,.28); border-radius: 999px; }
    .thin-scroll::-webkit-scrollbar-track{ background: rgba(17,24,39,.06); border-radius: 999px; }
    select,input{
      background: rgba(255,255,255,.9) !important;
      border-color: rgba(99,102,241,.22) !important;
      color: var(--ink) !important;
    }
    table th, table td { border-color: rgba(17,24,39,.10) !important; }
    .muted{ color: var(--muted); }
    .kpi{
      background: rgba(255,255,255,.65);
      border: 1px solid rgba(99,102,241,.18);
      box-shadow: 0 12px 32px rgba(17,24,39,.08);
      backdrop-filter: blur(14px);
    }
  </style>
</head>
<body>
  <div class="max-w-7xl mx-auto px-4 py-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl grid place-items-center text-white" style="background: var(--grad2); box-shadow: 0 14px 35px rgba(124,58,237,.18);">
          <i class="fa-solid fa-sparkles"></i>
        </div>
        <div>
          <div class="text-2xl font-extrabold tracking-tight">우리집 가계부</div>
          <div class="text-xs muted mt-0.5">Master(Flow→대분류→소분류→상세) 기준 · entries는 detail_item_id로만 저장</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <div id="whoPill" class="pill rounded-full px-3 py-2 text-sm muted hidden"></div>
        <button id="btnLogout" class="btn btn-danger rounded-xl px-4 py-2 text-sm hidden">
          <i class="fa-solid fa-right-from-bracket mr-2"></i>로그아웃
        </button>
      </div>
    </div>

    <div id="authBox" class="mt-5 glass rounded-2xl p-4">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
        <div>
          <div class="text-sm font-semibold">로그인</div>
          <div class="text-xs muted mt-1">처음이면 회원가입 후 로그인. (메일 인증이 켜져있으면 인증 후 가능)</div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-2 w-full lg:w-[560px]">
          <input id="email" class="md:col-span-2 rounded-xl px-3 py-2 text-sm" type="email" placeholder="이메일" />
          <input id="password" class="md:col-span-2 rounded-xl px-3 py-2 text-sm" type="password" placeholder="비밀번호" />
          <button id="btnLogin" class="btn btn-primary rounded-xl px-3 py-2 text-sm">로그인</button>
          <button id="btnSignUp" class="btn rounded-xl px-3 py-2 text-sm md:col-span-5">처음이면 회원가입</button>
        </div>
      </div>
      <div id="error" class="text-sm mt-3 text-red-600"></div>
      <div id="status" class="text-xs mt-1 muted"></div>
    </div>

    <div id="appWrap" class="mt-5 hidden">
      <div class="flex flex-wrap gap-2">
        <button class="tab btn rounded-xl px-4 py-2 text-sm" data-tab="dash" data-active="true">
          <i class="fa-solid fa-chart-line mr-2"></i>대시보드
        </button>
        <button class="tab btn rounded-xl px-4 py-2 text-sm" data-tab="edit" data-active="false">
          <i class="fa-solid fa-pen-to-square mr-2"></i>기록/수정
        </button>
        <button class="tab btn rounded-xl px-4 py-2 text-sm" data-tab="cat" data-active="false">
          <i class="fa-solid fa-layer-group mr-2"></i>카테고리
        </button>
      </div>

      <!-- DASH -->
      <section id="tab-dash" class="mt-4">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
          <div class="glass rounded-2xl p-4 lg:col-span-3">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold">필터</div>
              <div class="flex items-center gap-2">
                <button id="btnDashReset" class="btn rounded-xl px-3 py-2 text-xs">
                  <i class="fa-solid fa-rotate-left mr-2"></i>초기화
                </button>
                <button id="btnDashClearAll" class="btn rounded-xl px-3 py-2 text-xs">
                  <i class="fa-solid fa-eraser mr-2"></i>전체 해제
                </button>
                <button id="btnDashRefetch" class="btn rounded-xl px-3 py-2 text-xs">
                  <i class="fa-solid fa-rotate mr-2"></i>새로고침
                </button>
              </div>
            </div>

            <div class="mt-3 space-y-4">
              <div>
                <div class="text-xs muted mb-2">구분</div>
                <div id="dashMemberBtns" class="flex flex-wrap gap-2"></div>
              </div>

              <div>
                <div class="text-xs muted mb-2">년도</div>
                <div id="dashYearBtns" class="flex flex-wrap gap-2"></div>
              </div>

              <div>
                <div class="text-xs muted mb-2">월 (복수 선택)</div>
                <div id="dashMonthBtns" class="flex flex-wrap gap-2"></div>
              </div>

              <div>
                <div class="text-xs muted mb-2">흐름 (복수 선택)</div>
                <div id="dashFlowBtns" class="flex flex-wrap gap-2"></div>
              </div>

              <div>
                <div class="text-xs muted mb-2">대분류 (복수 선택)</div>
                <div id="dashCategoryBtns" class="flex flex-wrap gap-2 max-h-[190px] overflow-auto thin-scroll pr-1"></div>
              </div>

              <div>
                <div class="text-xs muted mb-2">소분류 (복수 선택)</div>
                <div id="dashSubcategoryBtns" class="flex flex-wrap gap-2 max-h-[220px] overflow-auto thin-scroll pr-1"></div>
              </div>

              <div class="pt-1">
                <div class="text-xs muted mb-1">선택 요약</div>
                <div id="dashSummary" class="text-xs muted"></div>
              </div>
            </div>
          </div>

          <div class="lg:col-span-9 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="kpi rounded-2xl p-4">
              <div class="text-xs muted">수입</div>
              <div class="text-2xl font-extrabold mt-1"><span id="kpiIncome">0</span><span class="text-base font-medium muted ml-1">원</span></div>
            </div>
            <div class="kpi rounded-2xl p-4">
              <div class="text-xs muted">지출</div>
              <div class="text-2xl font-extrabold mt-1"><span id="kpiExpense">0</span><span class="text-base font-medium muted ml-1">원</span></div>
            </div>
            <div class="kpi rounded-2xl p-4">
              <div class="text-xs muted">저축</div>
              <div class="text-2xl font-extrabold mt-1"><span id="kpiSaving">0</span><span class="text-base font-medium muted ml-1">원</span></div>
            </div>

            <div class="glass rounded-2xl p-4 md:col-span-2">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold"><i class="fa-regular fa-chart-bar mr-2"></i>지출 요약 (대분류)</div>
                <div class="text-xs muted">선택 조건 기준</div>
              </div>
              <div class="mt-3 h-[260px]"><canvas id="chartCategory"></canvas></div>
            </div>

            <div class="glass rounded-2xl p-4 md:col-span-1">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold"><i class="fa-solid fa-list-ol mr-2"></i>지출 Top 10 (소분류)</div>
              </div>
              <div class="mt-3 h-[260px]"><canvas id="chartTop10"></canvas></div>
            </div>

            <div class="glass rounded-2xl p-4 md:col-span-1">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold"><i class="fa-solid fa-chart-pie mr-2"></i>흐름 비중</div>
              </div>
              <div class="mt-3 h-[260px]"><canvas id="chartFlowShare"></canvas></div>
            </div>

            <div class="glass rounded-2xl p-4 md:col-span-2">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold"><i class="fa-solid fa-layer-group mr-2"></i>월별 합계(스택)</div>
                <div class="text-xs muted">수입/지출/저축</div>
              </div>
              <div class="mt-3 h-[260px]"><canvas id="chartMonthlyStack"></canvas></div>
            </div>

            <div class="glass rounded-2xl p-4 md:col-span-3">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold"><i class="fa-regular fa-calendar mr-2"></i>월별 추이</div>
              </div>
              <div class="mt-3 h-[280px]"><canvas id="chartMonthly"></canvas></div>
            </div>
          </div>
        </div>
      </section>

      <!-- EDIT -->
      <section id="tab-edit" class="mt-4 hidden">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
          <div class="glass rounded-2xl p-4 lg:col-span-4">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold">거래 입력</div>
              <button id="btnDownloadTemplate" class="btn btn-primary rounded-xl px-3 py-2 text-xs">
                <i class="fa-solid fa-download mr-2"></i>엑셀 템플릿
              </button>
              <label class="btn rounded-xl px-3 py-2 text-xs cursor-pointer">
                <i class="fa-solid fa-file-arrow-up mr-2"></i>엑셀 업로드
                <input id="fileUploadXlsx" type="file" accept=".xlsx" class="hidden" />
              </label>

            </div>
            <div class="text-xs muted mt-2">템플릿은 마스터 기준으로 생성돼. (Flow→대분류→소분류→상세 + 예시)</div>
            <div id="uploadStatus" class="text-xs mt-2 muted"></div>

            <form id="entryForm" class="mt-4 space-y-3">
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <div class="text-xs muted mb-1">날짜</div>
                  <input id="entryDate" type="date" class="w-full rounded-xl px-3 py-2 text-sm" required />
                </div>
                <div>
                  <div class="text-xs muted mb-1">구분</div>
                  <select id="memberSelect" class="w-full rounded-xl px-3 py-2 text-sm" required></select>
                </div>
              </div>

              <div>
                <div class="text-xs muted mb-1">흐름</div>
                <select id="flowSelect" class="w-full rounded-xl px-3 py-2 text-sm" required></select>
              </div>

              <div>
                <div class="text-xs muted mb-1">대분류</div>
                <select id="categorySelect" class="w-full rounded-xl px-3 py-2 text-sm" required></select>
              </div>

              <div class="grid grid-cols-2 gap-2">
                <div>
                  <div class="text-xs muted mb-1">소분류</div>
                  <select id="subcategorySelect" class="w-full rounded-xl px-3 py-2 text-sm" required></select>
                </div>
                <div>
                  <div class="text-xs muted mb-1">상세항목</div>
                  <select id="detailSelect" class="w-full rounded-xl px-3 py-2 text-sm" required></select>
                </div>
              </div>

              <div id="exampleHint" class="text-xs muted -mt-1"></div>

              <div class="grid grid-cols-2 gap-2">
                <div>
                  <div class="text-xs muted mb-1">금액</div>
                  <input id="amount" type="number" min="0" step="1" class="w-full rounded-xl px-3 py-2 text-sm" required />
                </div>
                <div>
                  <div class="text-xs muted mb-1">메모(선택)</div>
                  <input id="memo" class="w-full rounded-xl px-3 py-2 text-sm" placeholder="선택" />
                </div>
              </div>

              <button id="btnSubmit" type="submit" class="btn btn-primary rounded-xl px-4 py-2 text-sm w-full">
                <i class="fa-solid fa-plus mr-2"></i>저장
              </button>
            </form>
          </div>

          <div class="glass rounded-2xl p-4 lg:col-span-8">
            <div class="flex flex-wrap gap-2 items-end justify-between">
              <div>
                <div class="text-sm font-semibold">거래 목록</div>
                <div class="text-xs muted mt-1">v_entries_master 기준(조인뷰)</div>
              </div>
              <div class="flex flex-wrap gap-2 items-center">
                <input id="listFrom" type="date" class="rounded-xl px-3 py-2 text-sm" />
                <input id="listTo" type="date" class="rounded-xl px-3 py-2 text-sm" />
                <select id="listFlow" class="rounded-xl px-3 py-2 text-sm"></select>
                <select id="listMember" class="rounded-xl px-3 py-2 text-sm"></select>
                <input id="listQ" class="rounded-xl px-3 py-2 text-sm" placeholder="검색(상세/메모)" />
                <button id="btnListApply" class="btn btn-primary rounded-xl px-4 py-2 text-sm">적용</button>
                <button id="btnListReload" class="btn rounded-xl px-4 py-2 text-sm">새로고침</button>
              </div>
            </div>

            <div class="mt-4 overflow-auto thin-scroll">
              <table class="w-full text-sm border-separate border-spacing-0">
                <thead class="muted">
                  <tr>
                    <th class="text-left py-3 px-3 border-b">날짜</th>
                    <th class="text-left py-3 px-3 border-b">구분</th>
                    <th class="text-left py-3 px-3 border-b">흐름</th>
                    <th class="text-left py-3 px-3 border-b">대분류</th>
                    <th class="text-left py-3 px-3 border-b">소분류</th>
                    <th class="text-left py-3 px-3 border-b">상세항목</th>
                    <th class="text-right py-3 px-3 border-b">금액</th>
                    <th class="text-left py-3 px-3 border-b">메모</th>
                  </tr>
                </thead>
                <tbody id="listTbody"></tbody>
              </table>
            </div>
            <div class="text-xs muted mt-3">총 <span id="listCount">0</span></div>
          </div>
        </div>
      </section>

      <!-- CATEGORY (view only) -->
      <section id="tab-cat" class="mt-4 hidden">
        <div class="glass rounded-2xl p-4">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
            <div>
              <div class="text-sm font-semibold">카테고리 (마스터)</div>
              <div class="text-xs muted mt-1">현재는 “조회 전용”</div>
            </div>
            <button id="btnCatReload" class="btn rounded-xl px-4 py-2 text-sm">
              <i class="fa-solid fa-rotate mr-2"></i>새로고침
            </button>
          </div>

          <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="glass rounded-2xl p-4">
              <div class="text-sm font-semibold">대분류</div>
              <div id="catList" class="mt-3 space-y-2 max-h-[520px] overflow-auto thin-scroll pr-1"></div>
            </div>
            <div class="glass rounded-2xl p-4">
              <div class="text-sm font-semibold">소분류</div>
              <div id="subList" class="mt-3 space-y-2 max-h-[520px] overflow-auto thin-scroll pr-1"></div>
            </div>
            <div class="glass rounded-2xl p-4">
              <div class="text-sm font-semibold">상세항목</div>
              <div id="detailList" class="mt-3 space-y-2 max-h-[520px] overflow-auto thin-scroll pr-1"></div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
const SUPABASE_URL = "https://cqxpmfxwgrpdtxomxfiz.supabase.co";
const SUPABASE_KEY = "sb_publishable_srN_e_EFhBbMEnPHSyu2Eg_03Mw37jS";
const DEFAULT_LEDGER_NAME = "우리집";
const SS_KEY = "ledger_session_v2";

let session = null;
let currentLedgerId = null;

let membersCache = [];
let flowsCache = [];
let categoriesCache = [];
let subcategoriesCache = [];
let detailItemsCache = [];
let dashRowsCache = [];

const byId = (id)=>document.getElementById(id);
const fmt = (n)=>Number(n||0).toLocaleString("ko-KR");
function setError(msg){ byId("error").textContent = msg || ""; }
function setStatus(msg){ byId("status").textContent = msg || ""; }
function todayISO(){
  const d = new Date();
  const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
  return z.toISOString().slice(0,10);
}
function saveSession(s){
  session = s;
  if(s) localStorage.setItem(SS_KEY, JSON.stringify(s));
  else localStorage.removeItem(SS_KEY);
}
function loadSession(){
  const raw = localStorage.getItem(SS_KEY);
  if(!raw) return null;
  try{ return JSON.parse(raw); }catch{ return null; }
}

async function apiFetch(path, { method="GET", query=null, body=null, auth=true, preferReturn=true } = {}){
  const url = new URL(SUPABASE_URL + path);
  if(query){
    for(const [k,v] of Object.entries(query)){
      if(v === undefined || v === null) continue;
      url.searchParams.set(k, v);
    }
  }
  const headers = {
    "apikey": SUPABASE_KEY,
    ...(body ? {"Content-Type":"application/json"} : {}),
  };
  if(auth && session?.access_token){
    headers["Authorization"] = "Bearer " + session.access_token;
  }
  if(preferReturn && (method==="POST" || method==="PATCH")){
    headers["Prefer"] = "return=representation";
  }
  const res = await fetch(url.toString(), { method, headers, body: body ? JSON.stringify(body) : undefined });
  const text = await res.text();
  let data = null;
  try { data = text ? JSON.parse(text) : null; } catch { data = text || null; }
  if(!res.ok){
    const msg = typeof data === "object" && data ? (data.message || data.error_description || JSON.stringify(data)) : String(data);
    throw new Error(msg || `HTTP ${res.status}`);
  }
  return data;
}

/** AUTH */
async function fetchUser(){
  return await apiFetch("/auth/v1/user", { method:"GET", auth:true, preferReturn:false });
}
async function loginWithPassword(email, password){
  const data = await apiFetch("/auth/v1/token", {
    method:"POST",
    auth:false,
    preferReturn:false,
    query:{ grant_type:"password" },
    body:{ email, password }
  });
  const access_token = data?.access_token;
  const refresh_token = data?.refresh_token;
  if(!access_token) throw new Error("로그인 실패: 토큰이 없어");
  saveSession({ access_token, refresh_token, user:null });
  const user = await fetchUser();
  saveSession({ ...session, user });
}
async function signUp(email, password){
  await apiFetch("/auth/v1/signup", { method:"POST", auth:false, preferReturn:false, body:{ email, password } });
  await loginWithPassword(email, password);
}
async function logout(){ saveSession(null); }

/** BOOTSTRAP */
async function ensureDefaultLedger(){
  const ledgers = await apiFetch("/rest/v1/ledgers", { query:{ select:"id,name,created_at", order:"created_at.asc" }});
  if(ledgers?.length){ currentLedgerId = ledgers[0].id; return; }

  const createdArr = await apiFetch("/rest/v1/ledgers", { method:"POST", body:{ name: DEFAULT_LEDGER_NAME, created_by: session.user.id }});
  const created = createdArr?.[0];
  if(!created?.id) throw new Error("장부 생성 실패");
  currentLedgerId = created.id;

  try{
    await apiFetch("/rest/v1/ledger_members", { method:"POST", body:{ ledger_id: currentLedgerId, user_id: session.user.id, role:"owner", status:"active" }, preferReturn:false });
  }catch(_){}
}

/** LOAD MASTERS */
async function loadMembers(){
  membersCache = await apiFetch("/rest/v1/members", {
    query:{ select:"id,name,kind,is_active", ledger_id:`eq.${currentLedgerId}`, is_active:"eq.true", order:"kind.desc,name.asc", limit:"200" }
  }) || [];
}
async function loadFlows(){
  flowsCache = await apiFetch("/rest/v1/flows", {
    query:{ select:"id,code,name,sort_order", ledger_id:`eq.${currentLedgerId}`, order:"sort_order.asc,code.asc", limit:"50" }
  }) || [];
}
async function loadCategories(){
  categoriesCache = await apiFetch("/rest/v1/categories", {
    query:{ select:"id,name,flow_id,sort_order,is_active", ledger_id:`eq.${currentLedgerId}`, is_active:"eq.true", order:"sort_order.asc,name.asc", limit:"500" }
  }) || [];
}
async function loadSubcategories(){
  subcategoriesCache = await apiFetch("/rest/v1/subcategories", {
    query:{ select:"id,name,category_id,sort_order,is_active", ledger_id:`eq.${currentLedgerId}`, is_active:"eq.true", order:"sort_order.asc,name.asc", limit:"1000" }
  }) || [];
}
async function loadDetailItems(){
  detailItemsCache = await apiFetch("/rest/v1/detail_items", {
    query:{ select:"id,name,subcategory_id,example_note,sort_order,is_active", ledger_id:`eq.${currentLedgerId}`, is_active:"eq.true", order:"sort_order.asc,name.asc", limit:"5000" }
  }) || [];
}

function memberNameById(id){ return (membersCache.find(m=>m.id===id)?.name)||""; }

function fillFlowSelect(selectEl, includeAll=false){
  const prev = selectEl.value || "";
  selectEl.innerHTML = includeAll ? `<option value="all">전체</option>` : "";
  for(const f of flowsCache){
    const opt = document.createElement("option");
    opt.value = f.id;
    opt.textContent = f.name || f.code;
    selectEl.appendChild(opt);
  }
  if(includeAll && prev==="all") selectEl.value="all";
  else if(prev && [...selectEl.options].some(o=>o.value===prev)) selectEl.value = prev;
}
function fillMemberSelect(selectEl, includeAll=false){
  const prev = selectEl.value || "";
  selectEl.innerHTML = includeAll ? `<option value="all">전체</option>` : "";
  for(const m of membersCache){
    const opt = document.createElement("option");
    opt.value = m.id;
    opt.textContent = `${m.name}${m.kind==="common" ? " (공통)" : ""}`;
    selectEl.appendChild(opt);
  }
  if(includeAll && prev==="all") selectEl.value="all";
  else if(prev && [...selectEl.options].some(o=>o.value===prev)) selectEl.value = prev;
}
function fillCategorySelect(selectEl, flowId, includeAll=false){
  const prev = selectEl.value || "";
  const list = categoriesCache.filter(c => !flowId || c.flow_id === flowId);
  selectEl.innerHTML = includeAll ? `<option value="all">전체</option>` : "";
  for(const c of list){
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.name;
    selectEl.appendChild(opt);
  }
  if(includeAll && prev==="all") selectEl.value="all";
  else if(prev && [...selectEl.options].some(o=>o.value===prev)) selectEl.value = prev;
  else if(!includeAll && list.length) selectEl.value = list[0].id;
}
function fillSubcategorySelect(selectEl, categoryId, includeAll=false){
  const prev = selectEl.value || "";
  const list = subcategoriesCache.filter(s => !categoryId || s.category_id === categoryId);
  selectEl.innerHTML = includeAll ? `<option value="all">전체</option>` : "";
  for(const s of list){
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = s.name;
    selectEl.appendChild(opt);
  }
  if(includeAll && prev==="all") selectEl.value="all";
  else if(prev && [...selectEl.options].some(o=>o.value===prev)) selectEl.value = prev;
  else if(!includeAll && list.length) selectEl.value = list[0].id;
}
function fillDetailSelect(selectEl, subcategoryId, includeAll=false){
  const prev = selectEl.value || "";
  const list = detailItemsCache.filter(d => !subcategoryId || d.subcategory_id === subcategoryId);
  selectEl.innerHTML = includeAll ? `<option value="all">전체</option>` : "";
  for(const d of list){
    const opt = document.createElement("option");
    opt.value = d.id;
    opt.textContent = d.name;
    selectEl.appendChild(opt);
  }
  if(includeAll && prev==="all") selectEl.value="all";
  else if(prev && [...selectEl.options].some(o=>o.value===prev)) selectEl.value = prev;
  else if(!includeAll && list.length) selectEl.value = list[0].id;
}
function setExampleHint(detailItemId, el){
  const it = detailItemsCache.find(d=>d.id===detailItemId);
  const note = (it?.example_note||"").trim();
  el.textContent = note ? `예시: ${note}` : "";
}

/** VIEW DATA */
async function fetchDashRows(){
  const url = new URL(SUPABASE_URL + "/rest/v1/v_entries_master");
  url.searchParams.set("select", "entry_date,amount,member_id,flow_code,flow_name,category_name,subcategory_name,detail_name,detail_item_id,memo,category_id,subcategory_id");
  url.searchParams.set("ledger_id", `eq.${currentLedgerId}`);
  url.searchParams.set("order", "entry_date.asc");
  url.searchParams.set("limit", "12000");
  const headers = { "apikey": SUPABASE_KEY, "Authorization":"Bearer "+session.access_token };
  const res = await fetch(url.toString(), { headers });
  const data = await res.json();
  if(!res.ok) throw new Error(data?.message || JSON.stringify(data));
  return data || [];
}
// ===== DASH BUTTON FILTER STATE (멀티 선택) =====
const dashState = {
  members: new Set(),       // member_id
  years: new Set(),         // "2025"
  months: new Set(),        // "7".."12"
  flows: new Set(),         // flow_code: "expense" | "income" | "saving"
  categories: new Set(),    // category_id
  subcategories: new Set(), // subcategory_id
};

function ymdFromDate(iso){
  const s = String(iso || "");
  const y = Number(s.slice(0,4));
  const m = Number(s.slice(5,7));
  return { y, m };
}

function pillBtn(active){
  return active
    ? "btn pill rounded-full px-3 py-2 text-xs font-semibold"
    : "btn rounded-full px-3 py-2 text-xs";
}

function renderToggleGroup(containerEl, items, selectedSet, getId, getLabel, after){
  if(!containerEl) return;
  containerEl.innerHTML = "";
  for(const it of items){
    const id = String(getId(it));
    const active = selectedSet.has(id);
    const b = document.createElement("button");
    b.className = pillBtn(active);
    b.textContent = getLabel(it);
    if(active) b.style.outline = "2px solid rgba(124,58,237,.35)";
    b.onclick = ()=>{
      if(selectedSet.has(id)) selectedSet.delete(id);
      else selectedSet.add(id);
      after?.();
      updateDashSummary();
      refreshDashboard();
    };
    containerEl.appendChild(b);
  }
}

function renderToggleGroupNum(containerEl, nums, selectedSet, labelFn, after){
  if(!containerEl) return;
  containerEl.innerHTML = "";
  for(const n of nums){
    const id = String(n);
    const active = selectedSet.has(id);
    const b = document.createElement("button");
    b.className = pillBtn(active);
    b.textContent = labelFn(n);
    if(active) b.style.outline = "2px solid rgba(124,58,237,.35)";
    b.onclick = ()=>{
      if(selectedSet.has(id)) selectedSet.delete(id);
      else selectedSet.add(id);
      after?.();
      updateDashSummary();
      refreshDashboard();
    };
    containerEl.appendChild(b);
  }
}

function computeAvailableYearsMonths(rows){
  const years = new Set();
  const months = new Set();
  for(const r of rows){
    const { y, m } = ymdFromDate(r.entry_date);
    if(Number.isFinite(y)) years.add(y);
    if(Number.isFinite(m)) months.add(m);
  }
  return {
    yearsArr: [...years].sort((a,b)=>a-b),
    monthsArr: [...months].sort((a,b)=>a-b),
  };
}

function updateDashSummary(){
  const mem = dashState.members.size ? `${dashState.members.size}명` : "전체";
  const yr  = dashState.years.size ? ([...dashState.years].sort().join(",") + "년") : "전체년도";
  const mo  = dashState.months.size ? ([...dashState.months].map(x=>Number(x)).sort((a,b)=>a-b).map(x=>`${x}월`).join(", ")) : "전체월";
  const fl  = dashState.flows.size ? ([...dashState.flows].map(c => (c==="expense"?"지출":c==="income"?"수입":"저축")).join(", ")) : "전체흐름";
  const ca  = dashState.categories.size ? `${dashState.categories.size}개` : "전체대분류";
  const su  = dashState.subcategories.size ? `${dashState.subcategories.size}개` : "전체소분류";
  const el = byId("dashSummary");
  if(el) el.textContent = `구분: ${mem} · 년도: ${yr} · 월: ${mo} · 흐름: ${fl} · 대분류: ${ca} · 소분류: ${su}`;
}

function setDashDefaultYearMonth(){
  const { yearsArr, monthsArr } = computeAvailableYearsMonths(dashRowsCache);
  const now = new Date();
  const nowY = now.getFullYear();
  const nowM = now.getMonth()+1;

  dashState.years.clear();
  dashState.months.clear();

  if(yearsArr.length){
    dashState.years.add(String(yearsArr.includes(nowY) ? nowY : yearsArr[yearsArr.length-1]));
  }
  if(monthsArr.length){
    dashState.months.add(String(monthsArr.includes(nowM) ? nowM : monthsArr[monthsArr.length-1]));
  }
}

function clearDashAll(){
  dashState.members.clear();
  dashState.years.clear();
  dashState.months.clear();
  dashState.flows.clear();
  dashState.categories.clear();
  dashState.subcategories.clear();
}

function pruneSubcategoriesIfNeeded(){
  if(!dashState.categories.size) return;
  const allowed = new Set([...dashState.categories].map(String));
  for(const sid of [...dashState.subcategories]){
    const s = subcategoriesCache.find(x=>String(x.id)===String(sid));
    if(s && !allowed.has(String(s.category_id))){
      dashState.subcategories.delete(String(sid));
    }
  }
}

function renderDashCatsSubs(){
  // categories: if flows selected, narrow list by flow
  const flowCodeToFlowId = new Map(flowsCache.map(f=>[String(f.code), String(f.id)]));
  let allowedFlowIds = null;
  if(dashState.flows.size){
    allowedFlowIds = new Set([...dashState.flows].map(code => flowCodeToFlowId.get(String(code))).filter(Boolean));
  }

  const cats = allowedFlowIds
    ? categoriesCache.filter(c => allowedFlowIds.has(String(c.flow_id)))
    : categoriesCache;

  // drop selected categories that are no longer visible (because flow changed)
  const visibleCatIds = new Set(cats.map(c=>String(c.id)));
  for(const cid of [...dashState.categories]){
    if(!visibleCatIds.has(String(cid))) dashState.categories.delete(String(cid));
  }

  renderToggleGroup(
    byId("dashCategoryBtns"),
    cats,
    dashState.categories,
    (c)=>c.id,
    (c)=>c.name,
    ()=>{
      pruneSubcategoriesIfNeeded();
      renderDashCatsSubs();
    }
  );

  // subcategories: if categories selected, narrow list
  const allowedCatIds = dashState.categories.size ? new Set([...dashState.categories].map(String)) : null;
  const subs = allowedCatIds
    ? subcategoriesCache.filter(s => allowedCatIds.has(String(s.category_id)))
    : subcategoriesCache;

  const visibleSubIds = new Set(subs.map(s=>String(s.id)));
  for(const sid of [...dashState.subcategories]){
    if(!visibleSubIds.has(String(sid))) dashState.subcategories.delete(String(sid));
  }

  renderToggleGroup(
    byId("dashSubcategoryBtns"),
    subs,
    dashState.subcategories,
    (s)=>s.id,
    (s)=>s.name
  );
}

function renderDashButtonFilters(){
  renderToggleGroup(
    byId("dashMemberBtns"),
    membersCache,
    dashState.members,
    (m)=>m.id,
    (m)=>`${m.name}${m.kind==="common" ? " (공통)" : ""}`
  );

  const { yearsArr, monthsArr } = computeAvailableYearsMonths(dashRowsCache);
  if(dashState.years.size === 0 || dashState.months.size === 0){
    setDashDefaultYearMonth();
  }
  renderToggleGroupNum(byId("dashYearBtns"), yearsArr, dashState.years, (y)=>`${y}년`);
  renderToggleGroupNum(byId("dashMonthBtns"), monthsArr, dashState.months, (m)=>`${m}월`);

  const flowItems = [
    { code:"expense", label:"지출" },
    { code:"income", label:"수입" },
    { code:"saving", label:"저축" },
  ];
  renderToggleGroup(
    byId("dashFlowBtns"),
    flowItems,
    dashState.flows,
    (f)=>f.code,
    (f)=>f.label,
    ()=>{ renderDashCatsSubs(); }
  );

  renderDashCatsSubs();
  updateDashSummary();
}

function buildDashPredicate(){
  const ySet = dashState.years;
  const mSet = dashState.months;
  const memSet = dashState.members;
  const flowSet = dashState.flows; // flow_code set: expense/income/saving
  const catSet = dashState.categories;
  const subSet = dashState.subcategories;

  return (r)=>{
    const { y, m } = ymdFromDate(r.entry_date);

    if(ySet.size && !ySet.has(String(y))) return false;
    if(mSet.size && !mSet.has(String(m))) return false;
    if(memSet.size && !memSet.has(String(r.member_id))) return false;
    if(flowSet.size && !flowSet.has(String(r.flow_code))) return false;
    if(catSet.size && !catSet.has(String(r.category_id))) return false;
    if(subSet.size && !subSet.has(String(r.subcategory_id))) return false;

    return true;
  };
}

/** CHARTS */
Chart.register(ChartDataLabels);
let chartCategory=null, chartTop10=null, chartFlowShare=null, chartMonthlyStack=null, chartMonthly=null;

function chartCommonOpts(){
  return {
    responsive:true,
    maintainAspectRatio:false,
    plugins:{
      legend:{ labels:{ color:"rgba(11,18,32,.72)" } },
      datalabels:{
        color:"rgba(11,18,32,.78)",
        formatter:(v)=> (Number(v)||0)===0 ? "" : fmt(v),
        clamp:true
      },
      tooltip:{ callbacks:{ label:(ctx)=> `${ctx.dataset.label}: ${fmt(ctx.raw)} 원` } }
    },
    scales:{
      x:{ ticks:{ color:"rgba(11,18,32,.72)" }, grid:{ color:"rgba(11,18,32,.06)" } },
      y:{ ticks:{ color:"rgba(11,18,32,.72)", callback:(v)=>fmt(v) }, grid:{ color:"rgba(11,18,32,.06)" } }
    }
  };
}
function computeKpis(rows, pred){
  let expense=0,income=0,saving=0;
  for(const r of rows){
    if(!pred(r)) continue;
    if(r.flow_code==="expense") expense += Number(r.amount||0);
    if(r.flow_code==="income") income += Number(r.amount||0);
    if(r.flow_code==="saving") saving += Number(r.amount||0);
  }
  return { expense, income, saving };
}
function computeCategoryExpense(rows, pred){
  const map = new Map();
  for(const r of rows){
    if(!pred(r)) continue;
    if(r.flow_code!=="expense") continue;
    const k = r.category_name || "미분류";
    map.set(k, (map.get(k)||0) + Number(r.amount||0));
  }
  return [...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,12);
}
function computeTop10Sub(rows, pred){
  const map = new Map();
  for(const r of rows){
    if(!pred(r)) continue;
    if(r.flow_code!=="expense") continue;
    const k = r.subcategory_name || "미분류";
    map.set(k, (map.get(k)||0) + Number(r.amount||0));
  }
  return [...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
}
function computeFlowShare(rows, pred){
  let e=0,i=0,s=0;
  for(const r of rows){
    if(!pred(r)) continue;
    if(r.flow_code==="expense") e += Number(r.amount||0);
    else if(r.flow_code==="income") i += Number(r.amount||0);
    else if(r.flow_code==="saving") s += Number(r.amount||0);
  }
  const total = e+i+s || 1;
  return { e,i,s,total };
}
function computeMonthly(rows, pred){
  const map = new Map();
  for(const r of rows){
    if(!pred(r)) continue;
    const k = String(r.entry_date||"").slice(0,7);
    const o = map.get(k) || { expense:0,income:0,saving:0 };
    o[r.flow_code] = (o[r.flow_code]||0) + Number(r.amount||0);
    map.set(k,o);
  }
  const keys = [...map.keys()].sort();
  return {
    keys,
    exp: keys.map(k=>map.get(k)?.expense||0),
    inc: keys.map(k=>map.get(k)?.income||0),
    sav: keys.map(k=>map.get(k)?.saving||0)
  };
}

function refreshDashboard(){
  const pred = buildDashPredicate();
  const k = computeKpis(dashRowsCache, pred);
  byId("kpiExpense").textContent = fmt(k.expense);
  byId("kpiIncome").textContent = fmt(k.income);
  byId("kpiSaving").textContent = fmt(k.saving);

  const catArr = computeCategoryExpense(dashRowsCache, pred);
  if(chartCategory) chartCategory.destroy();
  chartCategory = new Chart(byId("chartCategory"), {
    type:"bar",
    data:{ labels: catArr.map(x=>x[0]), datasets:[{ label:"지출", data: catArr.map(x=>x[1]) }]},
    options:{ ...chartCommonOpts(), plugins:{ ...chartCommonOpts().plugins, legend:{ display:false }, datalabels:{ ...chartCommonOpts().plugins.datalabels, anchor:"end", align:"end" } } }
  });

  const topArr = computeTop10Sub(dashRowsCache, pred);
  if(chartTop10) chartTop10.destroy();
  chartTop10 = new Chart(byId("chartTop10"), {
    type:"bar",
    data:{ labels: topArr.map(x=>x[0]), datasets:[{ label:"지출", data: topArr.map(x=>x[1]) }]},
    options:{ ...chartCommonOpts(), plugins:{ ...chartCommonOpts().plugins, legend:{ display:false }, datalabels:{ ...chartCommonOpts().plugins.datalabels, anchor:"end", align:"end" } } }
  });

  const share = computeFlowShare(dashRowsCache, pred);
  if(chartFlowShare) chartFlowShare.destroy();
  chartFlowShare = new Chart(byId("chartFlowShare"), {
    type:"doughnut",
    data:{ labels:["지출","수입","저축"], datasets:[{ label:"비중", data:[share.e, share.i, share.s] }]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{ position:"bottom", labels:{ color:"rgba(11,18,32,.72)" } },
        tooltip:{ callbacks:{ label:(ctx)=> `${ctx.label}: ${fmt(ctx.raw)} 원` } },
        datalabels:{ color:"rgba(11,18,32,.78)", formatter:(v)=> (Number(v)||0)===0 ? "" : `${Math.round((Number(v||0)/share.total)*100)}%` }
      }
    }
  });

  const { keys, exp, inc, sav } = computeMonthly(dashRowsCache, pred);

  if(chartMonthlyStack) chartMonthlyStack.destroy();
  chartMonthlyStack = new Chart(byId("chartMonthlyStack"), {
    type:"bar",
    data:{ labels: keys, datasets:[ { label:"지출", data: exp, stack:"sum" }, { label:"수입", data: inc, stack:"sum" }, { label:"저축", data: sav, stack:"sum" } ]},
    options:{
      ...chartCommonOpts(),
      scales:{ x:{ stacked:true, ticks:{ color:"rgba(11,18,32,.72)" }, grid:{ color:"rgba(11,18,32,.06)" } },
               y:{ stacked:true, ticks:{ color:"rgba(11,18,32,.72)", callback:(v)=>fmt(v) }, grid:{ color:"rgba(11,18,32,.06)" } } },
      plugins:{ ...chartCommonOpts().plugins, datalabels:{ color:"rgba(11,18,32,.78)", anchor:"center", align:"center", formatter:(v)=> (Number(v)||0)===0 ? "" : fmt(v) } }
    }
  });

  if(chartMonthly) chartMonthly.destroy();
  chartMonthly = new Chart(byId("chartMonthly"), {
    type:"line",
    data:{ labels: keys, datasets:[ { label:"지출", data: exp, tension:.25 }, { label:"수입", data: inc, tension:.25 }, { label:"저축", data: sav, tension:.25 } ]},
    options:{ ...chartCommonOpts(), plugins:{ ...chartCommonOpts().plugins, datalabels:{ ...chartCommonOpts().plugins.datalabels, anchor:"end", align:"top" } } }
  });
}

/** LIST */
function escapeHtml(s){
  return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function listFilters(){
  return { from: byId("listFrom").value || "1900-01-01", to: byId("listTo").value || todayISO(), flowId: byId("listFlow").value, memberId: byId("listMember").value, q: (byId("listQ").value||"").trim() };
}
async function loadList(){
  const f = listFilters();
  const flowCode = (f.flowId==="all") ? "all" : (flowsCache.find(x=>x.id===f.flowId)?.code || "all");

  const url = new URL(SUPABASE_URL + "/rest/v1/v_entries_master");
  url.searchParams.set("select", "entry_date,amount,member_id,flow_name,flow_code,category_name,subcategory_name,detail_name,memo");
  url.searchParams.set("ledger_id", `eq.${currentLedgerId}`);
  url.searchParams.set("entry_date", `gte.${f.from}`);
  url.searchParams.append("entry_date", `lte.${f.to}`);
  if(flowCode !== "all") url.searchParams.set("flow_code", `eq.${flowCode}`);
  if(f.memberId !== "all") url.searchParams.set("member_id", `eq.${f.memberId}`);
  url.searchParams.set("order", "entry_date.desc");
  url.searchParams.set("limit", "4000");

  const headers = { "apikey": SUPABASE_KEY, "Authorization":"Bearer "+session.access_token };
  const res = await fetch(url.toString(), { headers });
  const data = await res.json();
  if(!res.ok) throw new Error(data?.message || JSON.stringify(data));

  const rows = (f.q) ? (data||[]).filter(r => (r.detail_name||"").includes(f.q) || (r.memo||"").includes(f.q)) : (data||[]);
  const tbody = byId("listTbody");
  tbody.innerHTML = "";
  for(const r of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="py-2 px-3 border-b">${escapeHtml(r.entry_date)}</td>
      <td class="py-2 px-3 border-b">${escapeHtml(memberNameById(r.member_id))}</td>
      <td class="py-2 px-3 border-b">${escapeHtml(r.flow_name || r.flow_code || "")}</td>
      <td class="py-2 px-3 border-b">${escapeHtml(r.category_name || "")}</td>
      <td class="py-2 px-3 border-b">${escapeHtml(r.subcategory_name || "")}</td>
      <td class="py-2 px-3 border-b">${escapeHtml(r.detail_name || "")}</td>
      <td class="py-2 px-3 border-b text-right font-semibold">${fmt(r.amount)}</td>
      <td class="py-2 px-3 border-b muted">${escapeHtml(r.memo || "")}</td>
    `;
    tbody.appendChild(tr);
  }
  byId("listCount").textContent = `${rows.length}건`;
}

/** ENTRY SAVE */
async function saveEntry(){
  const entry_date = byId("entryDate").value;
  const member_id = byId("memberSelect").value;
  const detail_item_id = byId("detailSelect").value;
  const amount = Number(byId("amount").value||0);
  const memo = (byId("memo").value||"").trim();

  if(!entry_date) throw new Error("날짜를 선택해줘");
  if(!member_id) throw new Error("구분을 선택해줘");
  if(!detail_item_id) throw new Error("상세항목을 선택해줘");
  if(!Number.isFinite(amount) || amount < 0) throw new Error("금액을 확인해줘");

  const payload = { ledger_id: currentLedgerId, entry_date, member_id, detail_item_id, amount, created_by: session.user.id };
  if(memo) payload.memo = memo;

  await apiFetch("/rest/v1/entries", { method:"POST", body: payload });
}

/** TEMPLATE DOWNLOAD */
function downloadBlob(filename, contentType, bytes){
  const blob = new Blob([bytes], { type: contentType });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
}
function buildTemplateRows(){
  const rows = [];
  rows.push(["사용법: 날짜는 YYYY-MM-DD. 금액 공란은 스킵(업로드 시)."]);
  rows.push(["날짜","흐름","대분류","소분류","상세항목","예시","돌프","천사","공통"]);

  const subById = new Map(subcategoriesCache.map(s=>[s.id,s]));
  const catById = new Map(categoriesCache.map(c=>[c.id,c]));
  const flowByIdMap = new Map(flowsCache.map(f=>[f.id,f]));
  const items = [...detailItemsCache].sort((a,b)=>(a.sort_order??0)-(b.sort_order??0) || (a.name||"").localeCompare(b.name||"", "ko"));

  for(const di of items){
    const sub = subById.get(di.subcategory_id);
    const cat = sub ? catById.get(sub.category_id) : null;
    const flow = cat ? flowByIdMap.get(cat.flow_id) : null;
    rows.push(["", flow?.name || flow?.code || "", cat?.name || "", sub?.name || "", di.name || "", (di.example_note||""), "", "", ""]);
  }
  return rows;
}


/** BULK UPLOAD (XLSX) */
function setUploadStatus(msg, isError=false){
  const el = byId("uploadStatus");
  if(!el) return;
  el.textContent = msg || "";
  el.style.color = isError ? "rgb(220 38 38)" : "rgba(11,18,32,.62)";
}

// Excel serial date -> YYYY-MM-DD
function excelSerialToISO(n){
  // Excel's epoch: 1899-12-30 (with the 1900 leap-year bug baked in)
  const ms = Math.round((Number(n) - 25569) * 86400 * 1000);
  const d = new Date(ms);
  const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
  return z.toISOString().slice(0,10);
}

function normalizeDate(cell){
  if(cell === null || cell === undefined || cell === "") return "";
  if(typeof cell === "number" && Number.isFinite(cell)) return excelSerialToISO(cell);
  const s = String(cell).trim();
  // Accept YYYY-MM-DD or YYYY/MM/DD
  const s2 = s.replaceAll("/", "-");
  if(/^\d{4}-\d{2}-\d{2}$/.test(s2)) return s2;
  // Try Date parse fallback
  const d = new Date(s2);
  if(!isNaN(d.getTime())){
    const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
    return z.toISOString().slice(0,10);
  }
  return "";
}

function toNumberSafe(v){
  if(v === null || v === undefined || v === "") return null;
  if(typeof v === "number" && Number.isFinite(v)) return v;
  const s = String(v).replaceAll(",","").trim();
  if(!s) return null;
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}

function buildDetailLookup(){
  // Key: flow|category|sub|detail (all trimmed)
  const subById = new Map(subcategoriesCache.map(s=>[String(s.id), s]));
  const catById = new Map(categoriesCache.map(c=>[String(c.id), c]));
  const flowById = new Map(flowsCache.map(f=>[String(f.id), f]));

  const map = new Map();
  for(const di of detailItemsCache){
    const sub = subById.get(String(di.subcategory_id));
    if(!sub) continue;
    const cat = catById.get(String(sub.category_id));
    if(!cat) continue;
    const flow = flowById.get(String(cat.flow_id));
    const flowName = (flow?.name || flow?.code || "").trim();
    const catName = (cat?.name || "").trim();
    const subName = (sub?.name || "").trim();
    const detName = (di?.name || "").trim();

    const k = `${flowName}|${catName}|${subName}|${detName}`.toLowerCase();
    map.set(k, String(di.id));
  }
  return map;
}

function buildMemberLookup(){
  // Key: member name -> id (trimmed)
  const map = new Map();
  for(const m of membersCache){
    map.set(String(m.name||"").trim(), String(m.id));
  }
  return map;
}

async function bulkInsertEntries(entries){
  const CHUNK = 500;
  for(let i=0;i<entries.length;i+=CHUNK){
    const chunk = entries.slice(i, i+CHUNK);
    // Use PostgREST bulk insert (array body). Prefer no representation to keep payload small.
    await apiFetch("/rest/v1/entries", { method:"POST", body: chunk, preferReturn:false });
    setUploadStatus(`업로드 중... ${Math.min(i+CHUNK, entries.length)}/${entries.length}건`);
  }
}

async function handleXlsxUpload(file){
  if(!file) return;
  if(!window.XLSX){
    throw new Error("엑셀 업로드를 위해 XLSX 라이브러리가 필요해. (네트워크/CDN 차단 여부 확인)");
  }

  setUploadStatus("엑셀 읽는 중...");
  const ab = await file.arrayBuffer();
  const wb = XLSX.read(ab, { type:"array" });
  const sheetName = wb.SheetNames?.[0];
  if(!sheetName) throw new Error("시트가 없어");
  const ws = wb.Sheets[sheetName];

  const rows = XLSX.utils.sheet_to_json(ws, { header:1, raw:true, blankrows:false });
  if(!rows || rows.length < 3) throw new Error("데이터가 너무 적어. 템플릿 형식인지 확인해줘.");

  // Template format:
  // row0: 안내문
  // row1: header (날짜,흐름,대분류,소분류,상세항목,예시,<member...>)
  const header = rows[1].map(x=>String(x||"").trim());
  const colDate = header.indexOf("날짜");
  const colFlow = header.indexOf("흐름");
  const colCat = header.indexOf("대분류");
  const colSub = header.indexOf("소분류");
  const colDet = header.indexOf("상세항목");

  if(colDate < 0 || colFlow < 0 || colCat < 0 || colSub < 0 || colDet < 0){
    throw new Error("템플릿 헤더를 못 찾았어. '날짜/흐름/대분류/소분류/상세항목' 컬럼이 필요해.");
  }

  const memberCols = [];
  for(let ci=0; ci<header.length; ci++){
    const name = header[ci];
    if(!name) continue;
    // member columns start after "예시"
    if(ci <= header.indexOf("예시")) continue;
    memberCols.push({ idx: ci, name });
  }
  if(!memberCols.length){
    throw new Error("멤버(돌프/천사/공통 등) 컬럼을 못 찾았어. 헤더 오른쪽에 멤버명이 있어야 해.");
  }

  const detailLookup = buildDetailLookup();
  const memberLookup = buildMemberLookup();

  // Validate member columns
  for(const mc of memberCols){
    if(!memberLookup.has(mc.name)){
      throw new Error(`멤버 컬럼 '${mc.name}'을(를) members 테이블에서 찾을 수 없어. (members.name과 헤더명이 동일해야 함)`);
    }
  }

  const toInsert = [];
  let skipped = 0;

  for(let ri=2; ri<rows.length; ri++){
    const row = rows[ri];
    const dateISO = normalizeDate(row[colDate]);
    if(!dateISO){ skipped++; continue; }

    const flowName = String(row[colFlow]||"").trim();
    const catName  = String(row[colCat]||"").trim();
    const subName  = String(row[colSub]||"").trim();
    const detName  = String(row[colDet]||"").trim();

    if(!flowName || !catName || !subName || !detName){ skipped++; continue; }

    const key = `${flowName}|${catName}|${subName}|${detName}`.toLowerCase();
    const detail_item_id = detailLookup.get(key);
    if(!detail_item_id){
      throw new Error(`마스터 매칭 실패: ${flowName} > ${catName} > ${subName} > ${detName}\n(템플릿이 최신인지/오타 없는지 확인)`);
    }

    for(const mc of memberCols){
      const amt = toNumberSafe(row[mc.idx]);
      if(amt === null || amt === 0) continue;
      const member_id = memberLookup.get(mc.name);

      toInsert.push({
        ledger_id: currentLedgerId,
        entry_date: dateISO,
        member_id,
        detail_item_id,
        amount: Math.round(amt),
        created_by: session.user.id
      });
    }
  }

  if(!toInsert.length){
    throw new Error("업로드할 데이터가 없어. 날짜와 멤버 금액 컬럼을 확인해줘.");
  }

  setUploadStatus(`업로드 준비 완료: ${toInsert.length}건 (스킵 ${skipped}행)`);
  await bulkInsertEntries(toInsert);

  setUploadStatus(`업로드 완료! ${toInsert.length}건 추가됨`);
}

function downloadTemplate(){
  const ym = new Date().toISOString().slice(0,7).replace("-","");
  const fname = `record_template_${ym}.xlsx`;
  const rows = buildTemplateRows();

  if(window.XLSX && window.XLSX.utils && window.XLSX.writeFile){
    const ws = XLSX.utils.aoa_to_sheet(rows);
    ws["!cols"] = [{wch:14},{wch:10},{wch:14},{wch:14},{wch:18},{wch:28},{wch:12},{wch:12},{wch:12}];
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "기록");
    XLSX.writeFile(wb, fname);
    return;
  }

  const csv = rows.map(r => r.map(x=>{
    const s = String(x??"");
    if(/[",\n]/.test(s)) return '"' + s.replaceAll('"','""') + '"';
    return s;
  }).join(",")).join("\n");
  downloadBlob(fname.replace(".xlsx",".csv"), "text/csv;charset=utf-8", csv);
}

/** CATEGORY VIEW */
let catSelectedId = null;
let subSelectedId = null;
function renderCategoryView(){
  const catList = byId("catList");
  const subList = byId("subList");
  const detList = byId("detailList");
  catList.innerHTML = ""; subList.innerHTML = ""; detList.innerHTML = "";

  const flowByIdMap = new Map(flowsCache.map(f=>[f.id,f]));
  const cats = [...categoriesCache].sort((a,b)=>(a.sort_order??0)-(b.sort_order??0) || (a.name||"").localeCompare(b.name||"", "ko"));

  for(const c of cats){
    const f = flowByIdMap.get(c.flow_id);
    const btn = document.createElement("button");
    btn.className = "btn rounded-xl px-3 py-2 text-sm w-full text-left";
    btn.innerHTML = `<div class="font-semibold">${escapeHtml(c.name)}</div><div class="text-xs muted mt-0.5">${escapeHtml(f?.name || f?.code || "")}</div>`;
    btn.addEventListener("click", ()=>{ catSelectedId = c.id; subSelectedId = null; renderCategoryView(); });
    if(catSelectedId === null) catSelectedId = cats[0]?.id || null;
    if(catSelectedId === c.id) btn.style.outline = "2px solid rgba(124,58,237,.35)";
    catList.appendChild(btn);
  }

  const subs = subcategoriesCache.filter(s=>!catSelectedId || s.category_id===catSelectedId)
    .sort((a,b)=>(a.sort_order??0)-(b.sort_order??0) || (a.name||"").localeCompare(b.name||"", "ko"));
  for(const s of subs){
    const btn = document.createElement("button");
    btn.className = "btn rounded-xl px-3 py-2 text-sm w-full text-left";
    btn.textContent = s.name;
    btn.addEventListener("click", ()=>{ subSelectedId = s.id; renderCategoryView(); });
    if(subSelectedId === null) subSelectedId = subs[0]?.id || null;
    if(subSelectedId === s.id) btn.style.outline = "2px solid rgba(37,99,235,.30)";
    subList.appendChild(btn);
  }

  const dets = detailItemsCache.filter(d=>!subSelectedId || d.subcategory_id===subSelectedId)
    .sort((a,b)=>(a.sort_order??0)-(b.sort_order??0) || (a.name||"").localeCompare(b.name||"", "ko"));
  for(const d of dets){
    const div = document.createElement("div");
    div.className = "btn rounded-xl px-3 py-2 text-sm w-full text-left";
    div.innerHTML = `<div class="font-semibold">${escapeHtml(d.name)}</div>${d.example_note ? `<div class="text-xs muted mt-0.5">예시: ${escapeHtml(d.example_note)}</div>` : ""}`;
    detList.appendChild(div);
  }
}

/** FILTER BINDING */
function refreshEntrySelectOptions(){
  fillFlowSelect(byId("flowSelect"), false);

  const onFlowChange = ()=>{
    const flowId = byId("flowSelect").value;
    fillCategorySelect(byId("categorySelect"), flowId, false);
    onCategoryChange();
  };
  const onCategoryChange = ()=>{
    const catId = byId("categorySelect").value;
    fillSubcategorySelect(byId("subcategorySelect"), catId, false);
    onSubChange();
  };
  const onSubChange = ()=>{
    const subId = byId("subcategorySelect").value;
    fillDetailSelect(byId("detailSelect"), subId, false);
    onDetailChange();
  };
  const onDetailChange = ()=> setExampleHint(byId("detailSelect").value, byId("exampleHint"));

  byId("flowSelect").onchange = onFlowChange;
  byId("categorySelect").onchange = onCategoryChange;
  byId("subcategorySelect").onchange = onSubChange;
  byId("detailSelect").onchange = onDetailChange;

  onFlowChange();
}

/** TABS */
function switchTab(tab){
  for(const b of document.querySelectorAll(".tab")){
    b.dataset.active = (b.dataset.tab === tab) ? "true" : "false";
  }
  for(const sec of ["dash","edit","cat"]){
    byId(`tab-${sec}`).classList.toggle("hidden", sec !== tab);
  }
}
document.addEventListener("click", (e)=>{
  const btn = e.target.closest(".tab");
  if(!btn) return;
  switchTab(btn.dataset.tab);
});

/** FULL REFRESH */
async function refreshEverything(){
  await ensureDefaultLedger();
  await Promise.all([loadMembers(), loadFlows(), loadCategories(), loadSubcategories(), loadDetailItems()]);
  if(!byId("entryDate").value) byId("entryDate").value = todayISO();
  if(!byId("listFrom").value) byId("listFrom").value = "2026-01-01";
  if(!byId("listTo").value) byId("listTo").value = todayISO();

  fillMemberSelect(byId("memberSelect"), false);
  refreshEntrySelectOptions();

  fillFlowSelect(byId("listFlow"), true);
  fillMemberSelect(byId("listMember"), true);


  dashRowsCache = await fetchDashRows();
  renderDashButtonFilters();
  refreshDashboard();
  await loadList();
  renderCategoryView();
}

async function refreshUI(){
  const authed = !!(session?.access_token && session?.user?.id);
  byId("authBox").classList.toggle("hidden", authed);
  byId("appWrap").classList.toggle("hidden", !authed);
  byId("btnLogout").classList.toggle("hidden", !authed);
  byId("whoPill").classList.toggle("hidden", !authed);

  if(!authed){ setStatus("로그인 상태가 아니야."); return; }
  byId("whoPill").textContent = `로그인: ${session.user.email}`;

  setStatus("데이터 로딩 중...");
  await refreshEverything();
  setStatus("준비 완료!");
}

window.addEventListener("DOMContentLoaded", async ()=>{
  try{
    const s = loadSession();
    if(s) session = s;
    if(session?.access_token && !session.user){
      try{
        const user = await fetchUser();
        saveSession({ ...session, user });
      }catch(_){
        saveSession(null);
      }
    }

    byId("btnLogin").addEventListener("click", async ()=>{
      try{
        setError(""); setStatus("로그인 중...");
        const email = (byId("email").value||"").trim();
        const pw = (byId("password").value||"").trim();
        if(!email || !pw) throw new Error("이메일/비밀번호를 입력해줘");
        await loginWithPassword(email, pw);
        await refreshUI();
      }catch(e){ setError(e?.message || String(e)); setStatus(""); }
    });

    byId("btnSignUp").addEventListener("click", async ()=>{
      try{
        setError(""); setStatus("회원가입 중...");
        const email = (byId("email").value||"").trim();
        const pw = (byId("password").value||"").trim();
        if(!email || !pw) throw new Error("이메일/비밀번호를 입력해줘");
        await signUp(email, pw);
        await refreshUI();
      }catch(e){ setError(e?.message || String(e)); setStatus(""); }
    });

    byId("btnLogout").addEventListener("click", async ()=>{ await logout(); await refreshUI(); });

    // DASH: 버튼 체크 필터
    byId("btnDashReset")?.addEventListener("click", ()=>{
      // 초기화: 년/월만 기본값으로, 나머지는 전체(선택 해제)
      dashState.members.clear();
      dashState.flows.clear();
      dashState.categories.clear();
      dashState.subcategories.clear();
      setDashDefaultYearMonth();
      renderDashButtonFilters();
      refreshDashboard();
    });

    byId("btnDashClearAll")?.addEventListener("click", ()=>{
      // 전체 해제: 모든 선택 제거(= 전체 데이터)
      clearDashAll();
      renderDashButtonFilters();
      refreshDashboard();
    });
    byId("btnDashRefetch")?.addEventListener("click", async ()=>{
      try{
        setError(""); setStatus("대시보드 새로고침...");
        dashRowsCache = await fetchDashRows();
        renderDashButtonFilters();
        refreshDashboard();
        setStatus("준비 완료!");
      }catch(e){ setError(e?.message || String(e)); setStatus(""); }
    });

    byId("entryForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      try{
        setError(""); setStatus("저장 중...");
        await saveEntry();
        dashRowsCache = await fetchDashRows();
        refreshDashboard();
        await loadList();
        byId("amount").value = "";
        byId("memo").value = "";
        setStatus("저장 완료!");
      }catch(err){ setError(err?.message || String(err)); setStatus(""); }
    });

    byId("btnListReload").addEventListener("click", async ()=>{ try{ setError(""); await loadList(); }catch(e){ setError(e.message); } });
    byId("btnListApply").addEventListener("click", async ()=>{ try{ setError(""); await loadList(); }catch(e){ setError(e.message); } });

    byId("btnDownloadTemplate").addEventListener("click", ()=>{ try{ downloadTemplate(); }catch(e){ setError(e.message); } });

    // XLSX 업로드 (대량 입력)
    byId("fileUploadXlsx")?.addEventListener("change", async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      try{
        setError(""); setUploadStatus("");
        setStatus("엑셀 업로드 중...");
        await handleXlsxUpload(file);
        // refresh after upload
        dashRowsCache = await fetchDashRows();
        renderDashButtonFilters();
        refreshDashboard();
        await loadList();
        setStatus("준비 완료!");
      }catch(err){
        setUploadStatus(err?.message || String(err), true);
        setError(err?.message || String(err));
        setStatus("");
      }finally{
        // allow uploading same file again
        e.target.value = "";
      }
    });

    byId("btnCatReload").addEventListener("click", async ()=>{
      try{
        setError(""); setStatus("카테고리 로딩...");
        await Promise.all([loadFlows(), loadCategories(), loadSubcategories(), loadDetailItems()]);
        renderCategoryView();
        setStatus("준비 완료!");
      }catch(e){ setError(e?.message || String(e)); setStatus(""); }
    });

    await refreshUI();
  }catch(e){
    console.error(e);
    setError(e?.message || String(e));
  }
});
</script>
</body>
</html>
