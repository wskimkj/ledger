<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<title>우리집 가계부 · 카테고리 관리 FINAL</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
  .tree-item { cursor:pointer; }
  .tree-item.active { background:#eef2ff; }
  .tree-item.inactive { opacity:.4; }
  .drag-over { outline:2px dashed #6366f1; }
</style>
</head>
<body class="bg-slate-50 p-6">

<h1 class="text-2xl font-bold mb-4">카테고리 관리 (FINAL)</h1>
<p class="text-sm text-slate-500 mb-6">
네이버 블로그 스타일 · 전체 트리 / 선택 편집 / 드래그 정렬 / 비활성화
</p>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

  <!-- LEFT: TREE -->
  <div class="bg-white rounded-xl shadow p-4 lg:col-span-2">
    <div class="font-semibold mb-2">카테고리 전체 보기</div>
    <div id="categoryTree" class="text-sm space-y-1"></div>
  </div>

  <!-- RIGHT: EDIT PANEL -->
  <div class="bg-white rounded-xl shadow p-4">
    <div class="font-semibold mb-2">선택 항목 편집</div>

    <div id="editEmpty" class="text-xs text-slate-400">
      왼쪽에서 항목을 선택하세요
    </div>

    <div id="editBox" class="hidden space-y-2">
      <div class="text-xs">종류: <b id="editType"></b></div>

      <div>
        <label class="text-xs">이름</label>
        <input id="editName" class="w-full border rounded px-2 py-1 text-sm"/>
      </div>

      <div id="editExampleWrap" class="hidden">
        <label class="text-xs">설명 (example)</label>
        <input id="editExample" class="w-full border rounded px-2 py-1 text-sm"/>
      </div>

      <div class="text-xs">
        상태: <b id="editStatus"></b>
      </div>

      <div class="flex gap-2 mt-2">
        <button id="btnSave" class="flex-1 bg-indigo-600 text-white rounded px-3 py-2 text-sm">
          저장
        </button>
        <button id="btnToggle" class="flex-1 bg-rose-100 text-rose-700 rounded px-3 py-2 text-sm">
          비활성
        </button>
      </div>
    </div>
  </div>

</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://cqxpmfxwgrpdtxomxfiz.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNxeHBtZnh3Z3JwZHR4b214Zml6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MTQ1NzAsImV4cCI6MjA4MzQ5MDU3MH0.YUGKXlqNpltt_JI_tyvgE-FhLXRILq0v7-gpLpQgo0M";
const LEDGER_ID = "873e11dd-0acb-422a-90d0-52a0ad8a9c93";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= STATE ================= */
let categories=[], subcategories=[], details=[];
let selected = null;

/* ================= LOAD ================= */
async function loadAll(){
  categories = (await sb.from("categories").select("*").eq("ledger_id",LEDGER_ID).order("sort_order")).data||[];
  subcategories = (await sb.from("subcategories").select("*").eq("ledger_id",LEDGER_ID).order("sort_order")).data||[];
  details = (await sb.from("detail_items").select("*").eq("ledger_id",LEDGER_ID).order("sort_order")).data||[];
  renderTree();
}

/* ================= TREE ================= */
function renderTree(){
  const wrap = document.getElementById("categoryTree");
  wrap.innerHTML = "";

  categories.forEach(cat=>{
    const c = nodeDiv(cat,"category");
    wrap.appendChild(c);

    subcategories.filter(s=>s.category_id===cat.id).forEach(sub=>{
      const s = nodeDiv(sub,"subcategory","ml-4");
      wrap.appendChild(s);

      details.filter(d=>d.subcategory_id===sub.id).forEach(det=>{
        const d = nodeDiv(det,"detail","ml-8");
        wrap.appendChild(d);
      });
    });
  });
}

function nodeDiv(obj,type,cls=""){
  const d = document.createElement("div");
  d.className = `tree-item ${cls} ${obj.is_active?"":"inactive"}`;
  d.textContent =
    type==="category" ? "▸ "+obj.name :
    type==="subcategory" ? "  ▸ "+obj.name :
    "    • "+obj.name;

  d.onclick = ()=>selectNode(type,obj,d);
  d.draggable = true;

  d.ondragstart = e=>{ e.dataTransfer.setData("id",obj.id); e.dataTransfer.setData("type",type); };
  d.ondragover = e=>{ e.preventDefault(); d.classList.add("drag-over"); };
  d.ondragleave = ()=>d.classList.remove("drag-over");
  d.ondrop = async e=>{
    e.preventDefault(); d.classList.remove("drag-over");
    const fromId = e.dataTransfer.getData("id");
    const fromType = e.dataTransfer.getData("type");
    if(fromType!==type) return;
    await swapSort(type, fromId, obj.id);
  };

  return d;
}

/* ================= SELECT / EDIT ================= */
function selectNode(type,obj,el){
  document.querySelectorAll(".tree-item").forEach(x=>x.classList.remove("active"));
  el.classList.add("active");

  selected = { type, ...obj };

  document.getElementById("editEmpty").classList.add("hidden");
  document.getElementById("editBox").classList.remove("hidden");

  document.getElementById("editType").textContent =
    type==="category"?"대분류":type==="subcategory"?"소분류":"상세항목";

  document.getElementById("editName").value = obj.name;
  document.getElementById("editStatus").textContent = obj.is_active?"활성":"비활성";

  const exWrap = document.getElementById("editExampleWrap");
  if(type==="detail"){
    exWrap.classList.remove("hidden");
    document.getElementById("editExample").value = obj.example_note||"";
  }else{
    exWrap.classList.add("hidden");
  }

  document.getElementById("btnToggle").textContent =
    obj.is_active ? "비활성" : "활성";
}

/* ================= SAVE ================= */
document.getElementById("btnSave").onclick = async ()=>{
  if(!selected) return;
  const table =
    selected.type==="category"?"categories":
    selected.type==="subcategory"?"subcategories":"detail_items";

  const payload = { name: document.getElementById("editName").value };
  if(selected.type==="detail"){
    payload.example_note = document.getElementById("editExample").value;
  }

  await sb.from(table).update(payload).eq("id",selected.id);
  await loadAll();
};

document.getElementById("btnToggle").onclick = async ()=>{
  if(!selected) return;
  const table =
    selected.type==="category"?"categories":
    selected.type==="subcategory"?"subcategories":"detail_items";

  await sb.from(table).update({ is_active: !selected.is_active }).eq("id",selected.id);
  await loadAll();
};

/* ================= SORT ================= */
async function swapSort(type,a,b){
  const table =
    type==="category"?"categories":
    type==="subcategory"?"subcategories":"detail_items";

  const list = type==="category"?categories:type==="subcategory"?subcategories:details;
  const A = list.find(x=>x.id===a);
  const B = list.find(x=>x.id===b);
  if(!A||!B) return;

  await sb.from(table).update({ sort_order: B.sort_order }).eq("id",A.id);
  await sb.from(table).update({ sort_order: A.sort_order }).eq("id",B.id);
  await loadAll();
}

/* ================= INIT ================= */
loadAll();
</script>

</body>
</html>
