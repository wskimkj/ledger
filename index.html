<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ìš°ë¦¬ì§‘ ê°€ê³„ë¶€ Â· Master ê³ ì • (Final)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <!-- SheetJS (XLSX). If blocked, CSV fallback is used. -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg0:#f7f7ff;
      --bg1:#ffffffcc;
      --ink:#0b1220;
      --muted:rgba(11,18,32,.62);
      --line:rgba(99,102,241,.22);
      --shadow: 0 18px 55px rgba(17,24,39,.10);
      --grad: linear-gradient(135deg, #7c3aed, #2563eb, #06b6d4);
      --grad2: linear-gradient(135deg, #fb7185, #a78bfa, #22c55e);
    }
    body{
      color: var(--ink);
      background:
        radial-gradient(900px 520px at 12% 0%, rgba(124,58,237,.16), transparent 60%),
        radial-gradient(900px 520px at 92% 10%, rgba(37,99,235,.16), transparent 60%),
        radial-gradient(860px 520px at 50% 96%, rgba(34,197,94,.12), transparent 60%),
        var(--bg0);
    }
    .glass{
      background: var(--bg1);
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
    }
    .btn{
      border: 1px solid rgba(99,102,241,.22);
      background: rgba(255,255,255,.78);
      transition: transform .08s ease, filter .12s ease, background .12s ease;
    }
    .btn:hover{ background: rgba(255,255,255,.95); transform: translateY(-1px); }
    .btn-primary{
      color: white !important;
      border-color: rgba(99,102,241,.22);
      background: var(--grad);
    }
    .btn-primary:hover{ filter: brightness(1.03); }
    .btn-danger{
      border-color: rgba(239,68,68,.25);
      background: rgba(239,68,68,.10);
      color: rgba(153,27,27,.98) !important;
    }
    .pill{
      border: 1px solid rgba(124,58,237,.22);
      background: rgba(124,58,237,.08);
    }
    .tab[data-active="true"]{
      background: rgba(124,58,237,.10);
      border-color: rgba(124,58,237,.30);
    }
    .thin-scroll::-webkit-scrollbar{ height:10px; width:10px; }
    .thin-scroll::-webkit-scrollbar-thumb{ background: rgba(124,58,237,.28); border-radius: 999px; }
    .thin-scroll::-webkit-scrollbar-track{ background: rgba(17,24,39,.06); border-radius: 999px; }
    select,input{
      background: rgba(255,255,255,.9) !important;
      border-color: rgba(99,102,241,.22) !important;
      color: var(--ink) !important;
    }
    table th, table td { border-color: rgba(17,24,39,.10) !important; }
    .muted{ color: var(--muted); }
    .kpi{
      background: rgba(255,255,255,.65);
      border: 1px solid rgba(99,102,241,.18);
      box-shadow: 0 12px 32px rgba(17,24,39,.08);
      backdrop-filter: blur(14px);
    }
  </style>
</head>
<body>
  <div class="max-w-7xl mx-auto px-4 py-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl grid place-items-center text-white" style="background: var(--grad2); box-shadow: 0 14px 35px rgba(124,58,237,.18);">
          <i class="fa-solid fa-sparkles"></i>
        </div>
        <div>
          <div class="text-2xl font-extrabold tracking-tight">ìš°ë¦¬ì§‘ ê°€ê³„ë¶€</div>
          <div class="text-xs muted mt-0.5">Master(Flowâ†’ëŒ€ë¶„ë¥˜â†’ì†Œë¶„ë¥˜â†’ìƒì„¸) ê¸°ì¤€ Â· entriesëŠ” detail_item_idë¡œë§Œ ì €ì¥</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <div id="whoPill" class="pill rounded-full px-3 py-2 text-sm muted hidden"></div>
        <button id="btnLogout" class="btn btn-danger rounded-xl px-4 py-2 text-sm hidden">
          <i class="fa-solid fa-right-from-bracket mr-2"></i>ë¡œê·¸ì•„ì›ƒ
        </button>
      </div>
    </div>

    <div id="authBox" class="mt-5 glass rounded-2xl p-4">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
        <div>
          <div class="text-sm font-semibold">ë¡œê·¸ì¸</div>
          <div class="text-xs muted mt-1">ì²˜ìŒì´ë©´ íšŒì›ê°€ì… í›„ ë¡œê·¸ì¸. (ë©”ì¼ ì¸ì¦ì´ ì¼œì ¸ìˆìœ¼ë©´ ì¸ì¦ í›„ ê°€ëŠ¥)</div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-2 w-full lg:w-[560px]">
          <input id="email" class="md:col-span-2 rounded-xl px-3 py-2 text-sm" type="email" placeholder="ì´ë©”ì¼" />
          <input id="password" class="md:col-span-2 rounded-xl px-3 py-2 text-sm" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" />
          <button id="btnLogin" class="btn btn-primary rounded-xl px-3 py-2 text-sm">ë¡œê·¸ì¸</button>
          <button id="btnSignUp" class="btn rounded-xl px-3 py-2 text-sm md:col-span-5">ì²˜ìŒì´ë©´ íšŒì›ê°€ì…</button>
        </div>
      </div>
      <div id="error" class="text-sm mt-3 text-red-600"></div>
      <div id="status" class="text-xs mt-1 muted"></div>
    </div>

    <div id="appWrap" class="mt-5 hidden">
      <div class="flex flex-wrap gap-2">
        <button class="tab btn rounded-xl px-4 py-2 text-sm" data-tab="dash" data-active="true">
          <i class="fa-solid fa-chart-line mr-2"></i>ëŒ€ì‹œë³´ë“œ
        </button>
        <button class="tab btn rounded-xl px-4 py-2 text-sm" data-tab="edit" data-active="false">
          <i class="fa-solid fa-pen-to-square mr-2"></i>ê¸°ë¡/ìˆ˜ì •
        </button>
        <button class="tab btn rounded-xl px-4 py-2 text-sm" data-tab="cat" data-active="false">
          <i class="fa-solid fa-layer-group mr-2"></i>ì¹´í…Œê³ ë¦¬
        </button>
      </div>

      <!-- DASH -->
      <section id="tab-dash" class="mt-4">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
          <div class="glass rounded-2xl p-4 lg:col-span-3">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold">í•„í„°</div>
              <button id="btnDashRefetch" class="btn rounded-xl px-3 py-2 text-xs">
                <i class="fa-solid fa-rotate mr-2"></i>ìƒˆë¡œê³ ì¹¨
              </button>
            </div>

            <div class="mt-3 space-y-3">
              <div>
                <div class="text-xs muted mb-1">ê¸°ê°„</div>
                <div class="grid grid-cols-2 gap-2">
                  <input id="dashFrom" type="date" class="rounded-xl px-3 py-2 text-sm">
                  <input id="dashTo" type="date" class="rounded-xl px-3 py-2 text-sm">
                </div>
              </div>

              <div>
                <div class="text-xs muted mb-1">íë¦„</div>
                <select id="dashFlow" class="w-full rounded-xl px-3 py-2 text-sm"></select>
              </div>

              <div>
                <div class="text-xs muted mb-1">ëŒ€ë¶„ë¥˜</div>
                <select id="dashCategory" class="w-full rounded-xl px-3 py-2 text-sm"></select>
              </div>

              <div>
                <div class="text-xs muted mb-1">ì†Œë¶„ë¥˜</div>
                <select id="dashSubcategory" class="w-full rounded-xl px-3 py-2 text-sm"></select>
              </div>

              <div>
                <div class="text-xs muted mb-1">ìƒì„¸í•­ëª©</div>
                <select id="dashDetailItem" class="w-full rounded-xl px-3 py-2 text-sm"></select>
                <div id="dashExample" class="text-xs muted mt-2"></div>
              </div>

              <div>
                <div class="text-xs muted mb-1">êµ¬ë¶„</div>
                <select id="dashMember" class="w-full rounded-xl px-3 py-2 text-sm"></select>
              </div>

              <div class="flex gap-2 pt-1">
                <button id="btnDashClear" class="btn rounded-xl px-4 py-2 text-sm w-full">í•„í„° ì´ˆê¸°í™”</button>
              </div>
            </div>
          </div>

          <div class="lg:col-span-9 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="kpi rounded-2xl p-4">
              <div class="text-xs muted">ìˆ˜ì…</div>
              <div class="text-2xl font-extrabold mt-1"><span id="kpiIncome">0</span><span class="text-base font-medium muted ml-1">ì›</span></div>
            </div>
            <div class="kpi rounded-2xl p-4">
              <div class="text-xs muted">ì§€ì¶œ</div>
              <div class="text-2xl font-extrabold mt-1"><span id="kpiExpense">0</span><span class="text-base font-medium muted ml-1">ì›</span></div>
            </div>
            <div class="kpi rounded-2xl p-4">
              <div class="text-xs muted">ì €ì¶•</div>
              <div class="text-2xl font-extrabold mt-1"><span id="kpiSaving">0</span><span class="text-base font-medium muted ml-1">ì›</span></div>
            </div>

            <div class="glass rounded-2xl p-4 md:col-span-2">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold"><i class="fa-regular fa-chart-bar mr-2"></i>ì§€ì¶œ ìš”ì•½ (ëŒ€ë¶„ë¥˜)</div>
                <div class="text-xs muted">ì„ íƒ ì¡°ê±´ ê¸°ì¤€</div>
              </div>
              <div class="mt-3 h-[260px]"><canvas id="chartCategory"></canvas></div>
            </div>

            <div class="glass rounded-2xl p-4 md:col-span-1">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold"><i class="fa-solid fa-list-ol mr-2"></i>ì§€ì¶œ Top 10 (ì†Œë¶„ë¥˜)</div>
              </div>
              <div class="mt-3 h-[260px]"><canvas id="chartTop10"></canvas></div>
            </div>

            <div class="glass rounded-2xl p-4 md:col-span-1">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold"><i class="fa-solid fa-chart-pie mr-2"></i>íë¦„ ë¹„ì¤‘</div>
              </div>
              <div class="mt-3 h-[260px]"><canvas id="chartFlowShare"></canvas></div>
            </div>

            <div class="glass rounded-2xl p-4 md:col-span-2">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold"><i class="fa-solid fa-layer-group mr-2"></i>ì›”ë³„ í•©ê³„(ìŠ¤íƒ)</div>
                <div class="text-xs muted">ìˆ˜ì…/ì§€ì¶œ/ì €ì¶•</div>
              </div>
              <div class="mt-3 h-[260px]"><canvas id="chartMonthlyStack"></canvas></div>
            </div>

            <div class="glass rounded-2xl p-4 md:col-span-3">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold"><i class="fa-regular fa-calendar mr-2"></i>ì›”ë³„ ì¶”ì´</div>
              </div>
              <div class="mt-3 h-[280px]"><canvas id="chartMonthly"></canvas></div>
            </div>
          </div>
        </div>
      </section>

      <!-- EDIT -->
      <section id="tab-edit" class="mt-4 hidden">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
          <div class="glass rounded-2xl p-4 lg:col-span-4">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold">ê±°ë˜ ì…ë ¥</div>
              <button id="btnDownloadTemplate" class="btn btn-primary rounded-xl px-3 py-2 text-xs">
                <i class="fa-solid fa-download mr-2"></i>ì—‘ì…€ í…œí”Œë¦¿
              </button>
            </div>
            <div class="text-xs muted mt-2">í…œí”Œë¦¿ì€ ë§ˆìŠ¤í„° ê¸°ì¤€ìœ¼ë¡œ ìƒì„±ë¼. (Flowâ†’ëŒ€ë¶„ë¥˜â†’ì†Œë¶„ë¥˜â†’ìƒì„¸ + ì˜ˆì‹œ)</div>

            <form id="entryForm" class="mt-4 space-y-3">
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <div class="text-xs muted mb-1">ë‚ ì§œ</div>
                  <input id="entryDate" type="date" class="w-full rounded-xl px-3 py-2 text-sm" required />
                </div>
                <div>
                  <div class="text-xs muted mb-1">êµ¬ë¶„</div>
                  <select id="memberSelect" class="w-full rounded-xl px-3 py-2 text-sm" required></select>
                </div>
              </div>

              <div>
                <div class="text-xs muted mb-1">íë¦„</div>
                <select id="flowSelect" class="w-full rounded-xl px-3 py-2 text-sm" required></select>
              </div>

              <div>
                <div class="text-xs muted mb-1">ëŒ€ë¶„ë¥˜</div>
                <select id="categorySelect" class="w-full rounded-xl px-3 py-2 text-sm" required></select>
              </div>

              <div class="grid grid-cols-2 gap-2">
                <div>
                  <div class="text-xs muted mb-1">ì†Œë¶„ë¥˜</div>
                  <select id="subcategorySelect" class="w-full rounded-xl px-3 py-2 text-sm" required></select>
                </div>
                <div>
                  <div class="text-xs muted mb-1">ìƒì„¸í•­ëª©</div>
                  <select id="detailSelect" class="w-full rounded-xl px-3 py-2 text-sm" required></select>
                </div>
              </div>

              <div id="exampleHint" class="text-xs muted -mt-1"></div>

              <div class="grid grid-cols-2 gap-2">
                <div>
                  <div class="text-xs muted mb-1">ê¸ˆì•¡</div>
                  <input id="amount" type="number" min="0" step="1" class="w-full rounded-xl px-3 py-2 text-sm" required />
                </div>
                <div>
                  <div class="text-xs muted mb-1">ë©”ëª¨(ì„ íƒ)</div>
                  <input id="memo" class="w-full rounded-xl px-3 py-2 text-sm" placeholder="ì„ íƒ" />
                </div>
              </div>

              <button id="btnSubmit" type="submit" class="btn btn-primary rounded-xl px-4 py-2 text-sm w-full">
                <i class="fa-solid fa-plus mr-2"></i>ì €ì¥
              </button>
            </form>
          </div>

          <div class="glass rounded-2xl p-4 lg:col-span-8">
            <div class="flex flex-wrap gap-2 items-end justify-between">
              <div>
                <div class="text-sm font-semibold">ê±°ë˜ ëª©ë¡</div>
                <div class="text-xs muted mt-1">v_entries_master ê¸°ì¤€(ì¡°ì¸ë·°)</div>
              </div>
              <div class="flex flex-wrap gap-2 items-center">
                <input id="listFrom" type="date" class="rounded-xl px-3 py-2 text-sm" />
                <input id="listTo" type="date" class="rounded-xl px-3 py-2 text-sm" />
                <select id="listFlow" class="rounded-xl px-3 py-2 text-sm"></select>
                <select id="listMember" class="rounded-xl px-3 py-2 text-sm"></select>
                <input id="listQ" class="rounded-xl px-3 py-2 text-sm" placeholder="ê²€ìƒ‰(ìƒì„¸/ë©”ëª¨)" />
                <button id="btnListApply" class="btn btn-primary rounded-xl px-4 py-2 text-sm">ì ìš©</button>
                <button id="btnListReload" class="btn rounded-xl px-4 py-2 text-sm">ìƒˆë¡œê³ ì¹¨</button>
              </div>
            </div>

            <div class="mt-4 overflow-auto thin-scroll">
              <table class="w-full text-sm border-separate border-spacing-0">
                <thead class="muted">
                  <tr>
                    <th class="text-left py-3 px-3 border-b">ë‚ ì§œ</th>
                    <th class="text-left py-3 px-3 border-b">êµ¬ë¶„</th>
                    <th class="text-left py-3 px-3 border-b">íë¦„</th>
                    <th class="text-left py-3 px-3 border-b">ëŒ€ë¶„ë¥˜</th>
                    <th class="text-left py-3 px-3 border-b">ì†Œë¶„ë¥˜</th>
                    <th class="text-left py-3 px-3 border-b">ìƒì„¸í•­ëª©</th>
                    <th class="text-right py-3 px-3 border-b">ê¸ˆì•¡</th>
                    <th class="text-left py-3 px-3 border-b">ë©”ëª¨</th>
                  </tr>
                </thead>
                <tbody id="listTbody"></tbody>
              </table>
            </div>
            <div class="text-xs muted mt-3">ì´ <span id="listCount">0</span></div>
          </div>
        </div>
      </section>

      <!-- CATEGORY (view only) -->
      <section id="tab-cat" class="mt-4 hidden">
        <div class="glass rounded-2xl p-4">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
            <div>
              <div class="text-sm font-semibold">ì¹´í…Œê³ ë¦¬ (ë§ˆìŠ¤í„°)</div>
              <div class="text-xs muted mt-1">í˜„ì¬ëŠ” â€œì¡°íšŒ ì „ìš©â€</div>
            </div>
            <button id="btnCatReload" class="btn rounded-xl px-4 py-2 text-sm">
              <i class="fa-solid fa-rotate mr-2"></i>ìƒˆë¡œê³ ì¹¨
            </button>
          </div>

          <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="glass rounded-2xl p-4">
              <div class="text-sm font-semibold">ëŒ€ë¶„ë¥˜</div>
              <div id="catList" class="mt-3 space-y-2 max-h-[520px] overflow-auto thin-scroll pr-1"></div>
            </div>
            <div class="glass rounded-2xl p-4">
              <div class="text-sm font-semibold">ì†Œë¶„ë¥˜</div>
              <div id="subList" class="mt-3 space-y-2 max-h-[520px] overflow-auto thin-scroll pr-1"></div>
            </div>
            <div class="glass rounded-2xl p-4">
              <div class="text-sm font-semibold">ìƒì„¸í•­ëª©</div>
              <div id="detailList" class="mt-3 space-y-2 max-h-[520px] overflow-auto thin-scroll pr-1"></div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
const SUPABASE_URL = "https://cqxpmfxwgrpdtxomxfiz.supabase.co";
const SUPABASE_KEY = "REPLACE_WITH_YOUR_ANON_KEY"; // ğŸ”´ ë„¤ anon keyë¡œ êµì²´
const DEFAULT_LEDGER_NAME = "ìš°ë¦¬ì§‘";
const SS_KEY = "ledger_session_v2";

let session = null;
let currentLedgerId = null;

let membersCache = [];
let flowsCache = [];
let categoriesCache = [];
let subcategoriesCache = [];
let detailItemsCache = [];
let dashRowsCache = [];

const byId = (id)=>document.getElementById(id);
const fmt = (n)=>Number(n||0).toLocaleString("ko-KR");
function setError(msg){ byId("error").textContent = msg || ""; }
function setStatus(msg){ byId("status").textContent = msg || ""; }
function todayISO(){
  const d = new Date();
  const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
  return z.toISOString().slice(0,10);
}
function saveSession(s){
  session = s;
  if(s) localStorage.setItem(SS_KEY, JSON.stringify(s));
  else localStorage.removeItem(SS_KEY);
}
function loadSession(){
  const raw = localStorage.getItem(SS_KEY);
  if(!raw) return null;
  try{ return JSON.parse(raw); }catch{ return null; }
}

async function apiFetch(path, { method="GET", query=null, body=null, auth=true, preferReturn=true } = {}){
  const url = new URL(SUPABASE_URL + path);
  if(query){
    for(const [k,v] of Object.entries(query)){
      if(v === undefined || v === null) continue;
      url.searchParams.set(k, v);
    }
  }
  const headers = {
    "apikey": SUPABASE_KEY,
    ...(body ? {"Content-Type":"application/json"} : {}),
  };
  if(auth && session?.access_token){
    headers["Authorization"] = "Bearer " + session.access_token;
  }
  if(preferReturn && (method==="POST" || method==="PATCH")){
    headers["Prefer"] = "return=representation";
  }
  const res = await fetch(url.toString(), { method, headers, body: body ? JSON.stringify(body) : undefined });
  const text = await res.text();
  let data = null;
  try { data = text ? JSON.parse(text) : null; } catch { data = text || null; }
  if(!res.ok){
    const msg = typeof data === "object" && data ? (data.message || data.error_description || JSON.stringify(data)) : String(data);
    throw new Error(msg || `HTTP ${res.status}`);
  }
  return data;
}

/** AUTH */
async function fetchUser(){
  return await apiFetch("/auth/v1/user", { method:"GET", auth:true, preferReturn:false });
}
async function loginWithPassword(email, password){
  const data = await apiFetch("/auth/v1/token", {
    method:"POST",
    auth:false,
    preferReturn:false,
    query:{ grant_type:"password" },
    body:{ email, password }
  });
  const access_token = data?.access_token;
  const refresh_token = data?.refresh_token;
  if(!access_token) throw new Error("ë¡œê·¸ì¸ ì‹¤íŒ¨: í† í°ì´ ì—†ì–´");
  saveSession({ access_token, refresh_token, user:null });
  const user = await fetchUser();
  saveSession({ ...session, user });
}
async function signUp(email, password){
  await apiFetch("/auth/v1/signup", { method:"POST", auth:false, preferReturn:false, body:{ email, password } });
  await loginWithPassword(email, password);
}
async function logout(){ saveSession(null); }

/** BOOTSTRAP */
async function ensureDefaultLedger(){
  const ledgers = await apiFetch("/rest/v1/ledgers", { query:{ select:"id,name,created_at", order:"created_at.asc" }});
  if(ledgers?.length){ currentLedgerId = ledgers[0].id; return; }

  const createdArr = await apiFetch("/rest/v1/ledgers", { method:"POST", body:{ name: DEFAULT_LEDGER_NAME, created_by: session.user.id }});
  const created = createdArr?.[0];
  if(!created?.id) throw new Error("ì¥ë¶€ ìƒì„± ì‹¤íŒ¨");
  currentLedgerId = created.id;

  try{
    await apiFetch("/rest/v1/ledger_members", { method:"POST", body:{ ledger_id: currentLedgerId, user_id: session.user.id, role:"owner", status:"active" }, preferReturn:false });
  }catch(_){}
}

/** LOAD MASTERS */
async function loadMembers(){
  membersCache = await apiFetch("/rest/v1/members", {
    query:{ select:"id,name,kind,is_active", ledger_id:`eq.${currentLedgerId}`, is_active:"eq.true", order:"kind.desc,name.asc", limit:"200" }
  }) || [];
}
async function loadFlows(){
  flowsCache = await apiFetch("/rest/v1/flows", {
    query:{ select:"id,code,name,sort_order", ledger_id:`eq.${currentLedgerId}`, order:"sort_order.asc,code.asc", limit:"50" }
  }) || [];
}
async function loadCategories(){
  categoriesCache = await apiFetch("/rest/v1/categories", {
    query:{ select:"id,name,flow_id,sort_order,is_active", ledger_id:`eq.${currentLedgerId}`, is_active:"eq.true", order:"sort_order.asc,name.asc", limit:"500" }
  }) || [];
}
async function loadSubcategories(){
  subcategoriesCache = await apiFetch("/rest/v1/subcategories", {
    query:{ select:"id,name,category_id,sort_order,is_active", ledger_id:`eq.${currentLedgerId}`, is_active:"eq.true", order:"sort_order.asc,name.asc", limit:"1000" }
  }) || [];
}
async function loadDetailItems(){
  detailItemsCache = await apiFetch("/rest/v1/detail_items", {
    query:{ select:"id,name,subcategory_id,example_note,sort_order,is_active", ledger_id:`eq.${currentLedgerId}`, is_active:"eq.true", order:"sort_order.asc,name.asc", limit:"5000" }
  }) || [];
}

function memberNameById(id){ return (membersCache.find(m=>m.id===id)?.name)||""; }

function fillFlowSelect(selectEl, includeAll=false){
  const prev = selectEl.value || "";
  selectEl.innerHTML = includeAll ? `<option value="all">ì „ì²´</option>` : "";
  for(const f of flowsCache){
    const opt = document.createElement("option");
    opt.value = f.id;
    opt.textContent = f.name || f.code;
    selectEl.appendChild(opt);
  }
  if(includeAll && prev==="all") selectEl.value="all";
  else if(prev && [...selectEl.options].some(o=>o.value===prev)) selectEl.value = prev;
}
function fillMemberSelect(selectEl, includeAll=false){
  const prev = selectEl.value || "";
  selectEl.innerHTML = includeAll ? `<option value="all">ì „ì²´</option>` : "";
  for(const m of membersCache){
    const opt = document.createElement("option");
    opt.value = m.id;
    opt.textContent = `${m.name}${m.kind==="common" ? " (ê³µí†µ)" : ""}`;
    selectEl.appendChild(opt);
  }
  if(includeAll && prev==="all") selectEl.value="all";
  else if(prev && [...selectEl.options].some(o=>o.value===prev)) selectEl.value = prev;
}
function fillCategorySelect(selectEl, flowId, includeAll=false){
  const prev = selectEl.value || "";
  const list = categoriesCache.filter(c => !flowId || c.flow_id === flowId);
  selectEl.innerHTML = includeAll ? `<option value="all">ì „ì²´</option>` : "";
  for(const c of list){
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.name;
    selectEl.appendChild(opt);
  }
  if(includeAll && prev==="all") selectEl.value="all";
  else if(prev && [...selectEl.options].some(o=>o.value===prev)) selectEl.value = prev;
  else if(!includeAll && list.length) selectEl.value = list[0].id;
}
function fillSubcategorySelect(selectEl, categoryId, includeAll=false){
  const prev = selectEl.value || "";
  const list = subcategoriesCache.filter(s => !categoryId || s.category_id === categoryId);
  selectEl.innerHTML = includeAll ? `<option value="all">ì „ì²´</option>` : "";
  for(const s of list){
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = s.name;
    selectEl.appendChild(opt);
  }
  if(includeAll && prev==="all") selectEl.value="all";
  else if(prev && [...selectEl.options].some(o=>o.value===prev)) selectEl.value = prev;
  else if(!includeAll && list.length) selectEl.value = list[0].id;
}
function fillDetailSelect(selectEl, subcategoryId, includeAll=false){
  const prev = selectEl.value || "";
  const list = detailItemsCache.filter(d => !subcategoryId || d.subcategory_id === subcategoryId);
  selectEl.innerHTML = includeAll ? `<option value="all">ì „ì²´</option>` : "";
  for(const d of list){
    const opt = document.createElement("option");
    opt.value = d.id;
    opt.textContent = d.name;
    selectEl.appendChild(opt);
  }
  if(includeAll && prev==="all") selectEl.value="all";
  else if(prev && [...selectEl.options].some(o=>o.value===prev)) selectEl.value = prev;
  else if(!includeAll && list.length) selectEl.value = list[0].id;
}
function setExampleHint(detailItemId, el){
  const it = detailItemsCache.find(d=>d.id===detailItemId);
  const note = (it?.example_note||"").trim();
  el.textContent = note ? `ì˜ˆì‹œ: ${note}` : "";
}

/** VIEW DATA */
async function fetchDashRows(){
  const url = new URL(SUPABASE_URL + "/rest/v1/v_entries_master");
  url.searchParams.set("select", "entry_date,amount,member_id,flow_code,flow_name,category_name,subcategory_name,detail_name,detail_item_id,memo,category_id,subcategory_id");
  url.searchParams.set("ledger_id", `eq.${currentLedgerId}`);
  url.searchParams.set("order", "entry_date.asc");
  url.searchParams.set("limit", "12000");
  const headers = { "apikey": SUPABASE_KEY, "Authorization":"Bearer "+session.access_token };
  const res = await fetch(url.toString(), { headers });
  const data = await res.json();
  if(!res.ok) throw new Error(data?.message || JSON.stringify(data));
  return data || [];
}

function buildDashPredicate(){
  const from = byId("dashFrom").value || "1900-01-01";
  const to = byId("dashTo").value || todayISO();
  const flowId = byId("dashFlow").value;
  const catId = byId("dashCategory").value;
  const subId = byId("dashSubcategory").value;
  const detId = byId("dashDetailItem").value;
  const memId = byId("dashMember").value;

  const flowCode = (flowId==="all") ? "all" : (flowsCache.find(f=>f.id===flowId)?.code || "all");

  return (r)=>{
    if(r.entry_date < from || r.entry_date > to) return false;
    if(memId !== "all" && r.member_id !== memId) return false;
    if(flowCode !== "all" && r.flow_code !== flowCode) return false;
    if(catId !== "all" && String(r.category_id) !== String(catId)) return false;
    if(subId !== "all" && String(r.subcategory_id) !== String(subId)) return false;
    if(detId !== "all" && String(r.detail_item_id) !== String(detId)) return false;
    return true;
  };
}

/** CHARTS */
Chart.register(ChartDataLabels);
let chartCategory=null, chartTop10=null, chartFlowShare=null, chartMonthlyStack=null, chartMonthly=null;

function chartCommonOpts(){
  return {
    responsive:true,
    maintainAspectRatio:false,
    plugins:{
      legend:{ labels:{ color:"rgba(11,18,32,.72)" } },
      datalabels:{
        color:"rgba(11,18,32,.78)",
        formatter:(v)=> (Number(v)||0)===0 ? "" : fmt(v),
        clamp:true
      },
      tooltip:{ callbacks:{ label:(ctx)=> `${ctx.dataset.label}: ${fmt(ctx.raw)} ì›` } }
    },
    scales:{
      x:{ ticks:{ color:"rgba(11,18,32,.72)" }, grid:{ color:"rgba(11,18,32,.06)" } },
      y:{ ticks:{ color:"rgba(11,18,32,.72)", callback:(v)=>fmt(v) }, grid:{ color:"rgba(11,18,32,.06)" } }
    }
  };
}
function computeKpis(rows, pred){
  let expense=0,income=0,saving=0;
  for(const r of rows){
    if(!pred(r)) continue;
    if(r.flow_code==="expense") expense += Number(r.amount||0);
    if(r.flow_code==="income") income += Number(r.amount||0);
    if(r.flow_code==="saving") saving += Number(r.amount||0);
  }
  return { expense, income, saving };
}
function computeCategoryExpense(rows, pred){
  const map = new Map();
  for(const r of rows){
    if(!pred(r)) continue;
    if(r.flow_code!=="expense") continue;
    const k = r.category_name || "ë¯¸ë¶„ë¥˜";
    map.set(k, (map.get(k)||0) + Number(r.amount||0));
  }
  return [...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,12);
}
function computeTop10Sub(rows, pred){
  const map = new Map();
  for(const r of rows){
    if(!pred(r)) continue;
    if(r.flow_code!=="expense") continue;
    const k = r.subcategory_name || "ë¯¸ë¶„ë¥˜";
    map.set(k, (map.get(k)||0) + Number(r.amount||0));
  }
  return [...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
}
function computeFlowShare(rows, pred){
  let e=0,i=0,s=0;
  for(const r of rows){
    if(!pred(r)) continue;
    if(r.flow_code==="expense") e += Number(r.amount||0);
    else if(r.flow_code==="income") i += Number(r.amount||0);
    else if(r.flow_code==="saving") s += Number(r.amount||0);
  }
  const total = e+i+s || 1;
  return { e,i,s,total };
}
function computeMonthly(rows, pred){
  const map = new Map();
  for(const r of rows){
    if(!pred(r)) continue;
    const k = String(r.entry_date||"").slice(0,7);
    const o = map.get(k) || { expense:0,income:0,saving:0 };
    o[r.flow_code] = (o[r.flow_code]||0) + Number(r.amount||0);
    map.set(k,o);
  }
  const keys = [...map.keys()].sort();
  return {
    keys,
    exp: keys.map(k=>map.get(k)?.expense||0),
    inc: keys.map(k=>map.get(k)?.income||0),
    sav: keys.map(k=>map.get(k)?.saving||0)
  };
}

function refreshDashboard(){
  const pred = buildDashPredicate();
  const k = computeKpis(dashRowsCache, pred);
  byId("kpiExpense").textContent = fmt(k.expense);
  byId("kpiIncome").textContent = fmt(k.income);
  byId("kpiSaving").textContent = fmt(k.saving);

  const catArr = computeCategoryExpense(dashRowsCache, pred);
  if(chartCategory) chartCategory.destroy();
  chartCategory = new Chart(byId("chartCategory"), {
    type:"bar",
    data:{ labels: catArr.map(x=>x[0]), datasets:[{ label:"ì§€ì¶œ", data: catArr.map(x=>x[1]) }]},
    options:{ ...chartCommonOpts(), plugins:{ ...chartCommonOpts().plugins, legend:{ display:false }, datalabels:{ ...chartCommonOpts().plugins.datalabels, anchor:"end", align:"end" } } }
  });

  const topArr = computeTop10Sub(dashRowsCache, pred);
  if(chartTop10) chartTop10.destroy();
  chartTop10 = new Chart(byId("chartTop10"), {
    type:"bar",
    data:{ labels: topArr.map(x=>x[0]), datasets:[{ label:"ì§€ì¶œ", data: topArr.map(x=>x[1]) }]},
    options:{ ...chartCommonOpts(), plugins:{ ...chartCommonOpts().plugins, legend:{ display:false }, datalabels:{ ...chartCommonOpts().plugins.datalabels, anchor:"end", align:"end" } } }
  });

  const share = computeFlowShare(dashRowsCache, pred);
  if(chartFlowShare) chartFlowShare.destroy();
  chartFlowShare = new Chart(byId("chartFlowShare"), {
    type:"doughnut",
    data:{ labels:["ì§€ì¶œ","ìˆ˜ì…","ì €ì¶•"], datasets:[{ label:"ë¹„ì¤‘", data:[share.e, share.i, share.s] }]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{ position:"bottom", labels:{ color:"rgba(11,18,32,.72)" } },
        tooltip:{ callbacks:{ label:(ctx)=> `${ctx.label}: ${fmt(ctx.raw)} ì›` } },
        datalabels:{ color:"rgba(11,18,32,.78)", formatter:(v)=> (Number(v)||0)===0 ? "" : `${Math.round((Number(v||0)/share.total)*100)}%` }
      }
    }
  });

  const { keys, exp, inc, sav } = computeMonthly(dashRowsCache, pred);

  if(chartMonthlyStack) chartMonthlyStack.destroy();
  chartMonthlyStack = new Chart(byId("chartMonthlyStack"), {
    type:"bar",
    data:{ labels: keys, datasets:[ { label:"ì§€ì¶œ", data: exp, stack:"sum" }, { label:"ìˆ˜ì…", data: inc, stack:"sum" }, { label:"ì €ì¶•", data: sav, stack:"sum" } ]},
    options:{
      ...chartCommonOpts(),
      scales:{ x:{ stacked:true, ticks:{ color:"rgba(11,18,32,.72)" }, grid:{ color:"rgba(11,18,32,.06)" } },
               y:{ stacked:true, ticks:{ color:"rgba(11,18,32,.72)", callback:(v)=>fmt(v) }, grid:{ color:"rgba(11,18,32,.06)" } } },
      plugins:{ ...chartCommonOpts().plugins, datalabels:{ color:"rgba(11,18,32,.78)", anchor:"center", align:"center", formatter:(v)=> (Number(v)||0)===0 ? "" : fmt(v) } }
    }
  });

  if(chartMonthly) chartMonthly.destroy();
  chartMonthly = new Chart(byId("chartMonthly"), {
    type:"line",
    data:{ labels: keys, datasets:[ { label:"ì§€ì¶œ", data: exp, tension:.25 }, { label:"ìˆ˜ì…", data: inc, tension:.25 }, { label:"ì €ì¶•", data: sav, tension:.25 } ]},
    options:{ ...chartCommonOpts(), plugins:{ ...chartCommonOpts().plugins, datalabels:{ ...chartCommonOpts().plugins.datalabels, anchor:"end", align:"top" } } }
  });
}

/** LIST */
function escapeHtml(s){
  return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function listFilters(){
  return { from: byId("listFrom").value || "1900-01-01", to: byId("listTo").value || todayISO(), flowId: byId("listFlow").value, memberId: byId("listMember").value, q: (byId("listQ").value||"").trim() };
}
async function loadList(){
  const f = listFilters();
  const flowCode = (f.flowId==="all") ? "all" : (flowsCache.find(x=>x.id===f.flowId)?.code || "all");

  const url = new URL(SUPABASE_URL + "/rest/v1/v_entries_master");
  url.searchParams.set("select", "entry_date,amount,member_id,flow_name,flow_code,category_name,subcategory_name,detail_name,memo");
  url.searchParams.set("ledger_id", `eq.${currentLedgerId}`);
  url.searchParams.set("entry_date", `gte.${f.from}`);
  url.searchParams.append("entry_date", `lte.${f.to}`);
  if(flowCode !== "all") url.searchParams.set("flow_code", `eq.${flowCode}`);
  if(f.memberId !== "all") url.searchParams.set("member_id", `eq.${f.memberId}`);
  url.searchParams.set("order", "entry_date.desc");
  url.searchParams.set("limit", "4000");

  const headers = { "apikey": SUPABASE_KEY, "Authorization":"Bearer "+session.access_token };
  const res = await fetch(url.toString(), { headers });
  const data = await res.json();
  if(!res.ok) throw new Error(data?.message || JSON.stringify(data));

  const rows = (f.q) ? (data||[]).filter(r => (r.detail_name||"").includes(f.q) || (r.memo||"").includes(f.q)) : (data||[]);
  const tbody = byId("listTbody");
  tbody.innerHTML = "";
  for(const r of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="py-2 px-3 border-b">${escapeHtml(r.entry_date)}</td>
      <td class="py-2 px-3 border-b">${escapeHtml(memberNameById(r.member_id))}</td>
      <td class="py-2 px-3 border-b">${escapeHtml(r.flow_name || r.flow_code || "")}</td>
      <td class="py-2 px-3 border-b">${escapeHtml(r.category_name || "")}</td>
      <td class="py-2 px-3 border-b">${escapeHtml(r.subcategory_name || "")}</td>
      <td class="py-2 px-3 border-b">${escapeHtml(r.detail_name || "")}</td>
      <td class="py-2 px-3 border-b text-right font-semibold">${fmt(r.amount)}</td>
      <td class="py-2 px-3 border-b muted">${escapeHtml(r.memo || "")}</td>
    `;
    tbody.appendChild(tr);
  }
  byId("listCount").textContent = `${rows.length}ê±´`;
}

/** ENTRY SAVE */
async function saveEntry(){
  const entry_date = byId("entryDate").value;
  const member_id = byId("memberSelect").value;
  const detail_item_id = byId("detailSelect").value;
  const amount = Number(byId("amount").value||0);
  const memo = (byId("memo").value||"").trim();

  if(!entry_date) throw new Error("ë‚ ì§œë¥¼ ì„ íƒí•´ì¤˜");
  if(!member_id) throw new Error("êµ¬ë¶„ì„ ì„ íƒí•´ì¤˜");
  if(!detail_item_id) throw new Error("ìƒì„¸í•­ëª©ì„ ì„ íƒí•´ì¤˜");
  if(!Number.isFinite(amount) || amount < 0) throw new Error("ê¸ˆì•¡ì„ í™•ì¸í•´ì¤˜");

  const payload = { ledger_id: currentLedgerId, entry_date, member_id, detail_item_id, amount, created_by: session.user.id };
  if(memo) payload.memo = memo;

  await apiFetch("/rest/v1/entries", { method:"POST", body: payload });
}

/** TEMPLATE DOWNLOAD */
function downloadBlob(filename, contentType, bytes){
  const blob = new Blob([bytes], { type: contentType });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
}
function buildTemplateRows(){
  const rows = [];
  rows.push(["ì‚¬ìš©ë²•: ë‚ ì§œëŠ” YYYY-MM-DD. ê¸ˆì•¡ ê³µë€ì€ ìŠ¤í‚µ(ì—…ë¡œë“œ ì‹œ)."]);
  rows.push(["ë‚ ì§œ","íë¦„","ëŒ€ë¶„ë¥˜","ì†Œë¶„ë¥˜","ìƒì„¸í•­ëª©","ì˜ˆì‹œ","ëŒí”„","ì²œì‚¬","ê³µí†µ"]);

  const subById = new Map(subcategoriesCache.map(s=>[s.id,s]));
  const catById = new Map(categoriesCache.map(c=>[c.id,c]));
  const flowByIdMap = new Map(flowsCache.map(f=>[f.id,f]));
  const items = [...detailItemsCache].sort((a,b)=>(a.sort_order??0)-(b.sort_order??0) || (a.name||"").localeCompare(b.name||"", "ko"));

  for(const di of items){
    const sub = subById.get(di.subcategory_id);
    const cat = sub ? catById.get(sub.category_id) : null;
    const flow = cat ? flowByIdMap.get(cat.flow_id) : null;
    rows.push(["", flow?.name || flow?.code || "", cat?.name || "", sub?.name || "", di.name || "", (di.example_note||""), "", "", ""]);
  }
  return rows;
}
function downloadTemplate(){
  const ym = new Date().toISOString().slice(0,7).replace("-","");
  const fname = `record_template_${ym}.xlsx`;
  const rows = buildTemplateRows();

  if(window.XLSX && window.XLSX.utils && window.XLSX.writeFile){
    const ws = XLSX.utils.aoa_to_sheet(rows);
    ws["!cols"] = [{wch:14},{wch:10},{wch:14},{wch:14},{wch:18},{wch:28},{wch:12},{wch:12},{wch:12}];
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ê¸°ë¡");
    XLSX.writeFile(wb, fname);
    return;
  }

  const csv = rows.map(r => r.map(x=>{
    const s = String(x??"");
    if(/[",\n]/.test(s)) return '"' + s.replaceAll('"','""') + '"';
    return s;
  }).join(",")).join("\n");
  downloadBlob(fname.replace(".xlsx",".csv"), "text/csv;charset=utf-8", csv);
}

/** CATEGORY VIEW */
let catSelectedId = null;
let subSelectedId = null;
function renderCategoryView(){
  const catList = byId("catList");
  const subList = byId("subList");
  const detList = byId("detailList");
  catList.innerHTML = ""; subList.innerHTML = ""; detList.innerHTML = "";

  const flowByIdMap = new Map(flowsCache.map(f=>[f.id,f]));
  const cats = [...categoriesCache].sort((a,b)=>(a.sort_order??0)-(b.sort_order??0) || (a.name||"").localeCompare(b.name||"", "ko"));

  for(const c of cats){
    const f = flowByIdMap.get(c.flow_id);
    const btn = document.createElement("button");
    btn.className = "btn rounded-xl px-3 py-2 text-sm w-full text-left";
    btn.innerHTML = `<div class="font-semibold">${escapeHtml(c.name)}</div><div class="text-xs muted mt-0.5">${escapeHtml(f?.name || f?.code || "")}</div>`;
    btn.addEventListener("click", ()=>{ catSelectedId = c.id; subSelectedId = null; renderCategoryView(); });
    if(catSelectedId === null) catSelectedId = cats[0]?.id || null;
    if(catSelectedId === c.id) btn.style.outline = "2px solid rgba(124,58,237,.35)";
    catList.appendChild(btn);
  }

  const subs = subcategoriesCache.filter(s=>!catSelectedId || s.category_id===catSelectedId)
    .sort((a,b)=>(a.sort_order??0)-(b.sort_order??0) || (a.name||"").localeCompare(b.name||"", "ko"));
  for(const s of subs){
    const btn = document.createElement("button");
    btn.className = "btn rounded-xl px-3 py-2 text-sm w-full text-left";
    btn.textContent = s.name;
    btn.addEventListener("click", ()=>{ subSelectedId = s.id; renderCategoryView(); });
    if(subSelectedId === null) subSelectedId = subs[0]?.id || null;
    if(subSelectedId === s.id) btn.style.outline = "2px solid rgba(37,99,235,.30)";
    subList.appendChild(btn);
  }

  const dets = detailItemsCache.filter(d=>!subSelectedId || d.subcategory_id===subSelectedId)
    .sort((a,b)=>(a.sort_order??0)-(b.sort_order??0) || (a.name||"").localeCompare(b.name||"", "ko"));
  for(const d of dets){
    const div = document.createElement("div");
    div.className = "btn rounded-xl px-3 py-2 text-sm w-full text-left";
    div.innerHTML = `<div class="font-semibold">${escapeHtml(d.name)}</div>${d.example_note ? `<div class="text-xs muted mt-0.5">ì˜ˆì‹œ: ${escapeHtml(d.example_note)}</div>` : ""}`;
    detList.appendChild(div);
  }
}

/** FILTER BINDING */
function refreshDashFilterOptions(){
  fillFlowSelect(byId("dashFlow"), true);

  const onFlowChange = ()=>{
    const flowId = byId("dashFlow").value;
    fillCategorySelect(byId("dashCategory"), flowId==="all" ? null : flowId, true);
    onCategoryChange();
  };
  const onCategoryChange = ()=>{
    const catId = byId("dashCategory").value;
    fillSubcategorySelect(byId("dashSubcategory"), catId==="all" ? null : catId, true);
    onSubChange();
  };
  const onSubChange = ()=>{
    const subId = byId("dashSubcategory").value;
    fillDetailSelect(byId("dashDetailItem"), subId==="all" ? null : subId, true);
    onDetailChange();
  };
  const onDetailChange = ()=> setExampleHint(byId("dashDetailItem").value, byId("dashExample"));

  byId("dashFlow").onchange = ()=>{ onFlowChange(); refreshDashboard(); };
  byId("dashCategory").onchange = ()=>{ onCategoryChange(); refreshDashboard(); };
  byId("dashSubcategory").onchange = ()=>{ onSubChange(); refreshDashboard(); };
  byId("dashDetailItem").onchange = ()=>{ onDetailChange(); refreshDashboard(); };
  byId("dashMember").onchange = ()=> refreshDashboard();
  byId("dashFrom").onchange = ()=> refreshDashboard();
  byId("dashTo").onchange = ()=> refreshDashboard();

  onFlowChange();
  fillMemberSelect(byId("dashMember"), true);
}
function refreshEntrySelectOptions(){
  fillFlowSelect(byId("flowSelect"), false);

  const onFlowChange = ()=>{
    const flowId = byId("flowSelect").value;
    fillCategorySelect(byId("categorySelect"), flowId, false);
    onCategoryChange();
  };
  const onCategoryChange = ()=>{
    const catId = byId("categorySelect").value;
    fillSubcategorySelect(byId("subcategorySelect"), catId, false);
    onSubChange();
  };
  const onSubChange = ()=>{
    const subId = byId("subcategorySelect").value;
    fillDetailSelect(byId("detailSelect"), subId, false);
    onDetailChange();
  };
  const onDetailChange = ()=> setExampleHint(byId("detailSelect").value, byId("exampleHint"));

  byId("flowSelect").onchange = onFlowChange;
  byId("categorySelect").onchange = onCategoryChange;
  byId("subcategorySelect").onchange = onSubChange;
  byId("detailSelect").onchange = onDetailChange;

  onFlowChange();
}

/** TABS */
function switchTab(tab){
  for(const b of document.querySelectorAll(".tab")){
    b.dataset.active = (b.dataset.tab === tab) ? "true" : "false";
  }
  for(const sec of ["dash","edit","cat"]){
    byId(`tab-${sec}`).classList.toggle("hidden", sec !== tab);
  }
}
document.addEventListener("click", (e)=>{
  const btn = e.target.closest(".tab");
  if(!btn) return;
  switchTab(btn.dataset.tab);
});

/** FULL REFRESH */
async function refreshEverything(){
  await ensureDefaultLedger();
  await Promise.all([loadMembers(), loadFlows(), loadCategories(), loadSubcategories(), loadDetailItems()]);
  if(!byId("dashFrom").value) byId("dashFrom").value = "2026-01-01";
  if(!byId("dashTo").value) byId("dashTo").value = todayISO();
  if(!byId("entryDate").value) byId("entryDate").value = todayISO();
  if(!byId("listFrom").value) byId("listFrom").value = "2026-01-01";
  if(!byId("listTo").value) byId("listTo").value = todayISO();

  fillMemberSelect(byId("memberSelect"), false);
  refreshEntrySelectOptions();

  fillFlowSelect(byId("listFlow"), true);
  fillMemberSelect(byId("listMember"), true);

  refreshDashFilterOptions();

  dashRowsCache = await fetchDashRows();
  refreshDashboard();
  await loadList();
  renderCategoryView();
}

async function refreshUI(){
  const authed = !!(session?.access_token && session?.user?.id);
  byId("authBox").classList.toggle("hidden", authed);
  byId("appWrap").classList.toggle("hidden", !authed);
  byId("btnLogout").classList.toggle("hidden", !authed);
  byId("whoPill").classList.toggle("hidden", !authed);

  if(!authed){ setStatus("ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹ˆì•¼."); return; }
  byId("whoPill").textContent = `ë¡œê·¸ì¸: ${session.user.email}`;

  setStatus("ë°ì´í„° ë¡œë”© ì¤‘...");
  await refreshEverything();
  setStatus("ì¤€ë¹„ ì™„ë£Œ!");
}

window.addEventListener("DOMContentLoaded", async ()=>{
  try{
    const s = loadSession();
    if(s) session = s;
    if(session?.access_token && !session.user){
      try{
        const user = await fetchUser();
        saveSession({ ...session, user });
      }catch(_){
        saveSession(null);
      }
    }

    byId("btnLogin").addEventListener("click", async ()=>{
      try{
        setError(""); setStatus("ë¡œê·¸ì¸ ì¤‘...");
        const email = (byId("email").value||"").trim();
        const pw = (byId("password").value||"").trim();
        if(!email || !pw) throw new Error("ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì¤˜");
        await loginWithPassword(email, pw);
        await refreshUI();
      }catch(e){ setError(e?.message || String(e)); setStatus(""); }
    });

    byId("btnSignUp").addEventListener("click", async ()=>{
      try{
        setError(""); setStatus("íšŒì›ê°€ì… ì¤‘...");
        const email = (byId("email").value||"").trim();
        const pw = (byId("password").value||"").trim();
        if(!email || !pw) throw new Error("ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì¤˜");
        await signUp(email, pw);
        await refreshUI();
      }catch(e){ setError(e?.message || String(e)); setStatus(""); }
    });

    byId("btnLogout").addEventListener("click", async ()=>{ await logout(); await refreshUI(); });

    byId("btnDashClear").addEventListener("click", ()=>{
      byId("dashFrom").value = "2026-01-01";
      byId("dashTo").value = todayISO();
      byId("dashFlow").value = "all";
      refreshDashFilterOptions();
      byId("dashMember").value = "all";
      refreshDashboard();
    });

    byId("btnDashRefetch").addEventListener("click", async ()=>{
      try{
        setError(""); setStatus("ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨...");
        dashRowsCache = await fetchDashRows();
        refreshDashboard();
        setStatus("ì¤€ë¹„ ì™„ë£Œ!");
      }catch(e){ setError(e?.message || String(e)); setStatus(""); }
    });

    byId("entryForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      try{
        setError(""); setStatus("ì €ì¥ ì¤‘...");
        await saveEntry();
        dashRowsCache = await fetchDashRows();
        refreshDashboard();
        await loadList();
        byId("amount").value = "";
        byId("memo").value = "";
        setStatus("ì €ì¥ ì™„ë£Œ!");
      }catch(err){ setError(err?.message || String(err)); setStatus(""); }
    });

    byId("btnListReload").addEventListener("click", async ()=>{ try{ setError(""); await loadList(); }catch(e){ setError(e.message); } });
    byId("btnListApply").addEventListener("click", async ()=>{ try{ setError(""); await loadList(); }catch(e){ setError(e.message); } });

    byId("btnDownloadTemplate").addEventListener("click", ()=>{ try{ downloadTemplate(); }catch(e){ setError(e.message); } });

    byId("btnCatReload").addEventListener("click", async ()=>{
      try{
        setError(""); setStatus("ì¹´í…Œê³ ë¦¬ ë¡œë”©...");
        await Promise.all([loadFlows(), loadCategories(), loadSubcategories(), loadDetailItems()]);
        renderCategoryView();
        setStatus("ì¤€ë¹„ ì™„ë£Œ!");
      }catch(e){ setError(e?.message || String(e)); setStatus(""); }
    });

    await refreshUI();
  }catch(e){
    console.error(e);
    setError(e?.message || String(e));
  }
});
</script>
</body>
</html>
