
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>우리집 가계부</title>

  <!-- Tailwind (UI) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- xlsx -->
  <script src="./xlsx.full.min.js"></script>

    <style>
    /* Light pastel + glass (purple) */
    :root{
      --ink: #0f172a;                 /* slate-900 */
      --ink-2: rgba(15,23,42,.72);
      --ink-3: rgba(15,23,42,.55);
      --border: rgba(99,102,241,.22); /* indigo */
      --border-2: rgba(168,85,247,.18); /* purple */
      --glass: rgba(255,255,255,.72);
      --glass2: rgba(255,255,255,.58);
      --shadow: 0 18px 45px rgba(15,23,42,.10);
    }

    body{
      color: var(--ink);
      background:
        radial-gradient(1200px 600px at 15% 0%, rgba(168,85,247,0.22), transparent 60%),
        radial-gradient(1100px 560px at 90% 12%, rgba(99,102,241,0.18), transparent 60%),
        radial-gradient(900px 480px at 40% 90%, rgba(236,72,153,0.10), transparent 60%),
        #f7f5ff;
    }

    /* glass cards */
    .glass{
      background: var(--glass);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
    }
    .glass2{
      background: var(--glass2);
      border: 1px solid rgba(99,102,241,.18);
      box-shadow: 0 12px 28px rgba(15,23,42,.08);
      backdrop-filter: blur(14px);
    }

    /* scrollbar */
    .thin-scroll::-webkit-scrollbar{ height:10px; width:10px; }
    .thin-scroll::-webkit-scrollbar-thumb{ background: rgba(99,102,241,.28); border-radius: 999px; }
    .thin-scroll::-webkit-scrollbar-track{ background: rgba(15,23,42,.06); border-radius: 999px; }

    /* tabs/buttons */
    .tab-btn[data-active="true"]{
      background: rgba(99,102,241,.12);
      border-color: rgba(99,102,241,.35);
    }
    .pill{ border:1px solid rgba(99,102,241,.22); background: rgba(99,102,241,.06); }

    .btn{
      border:1px solid rgba(99,102,241,.18);
      background: rgba(255,255,255,.65);
    }
    .btn:hover{ background: rgba(255,255,255,.86); }
    .btn-primary{
      background: linear-gradient(135deg, rgba(99,102,241,.95), rgba(168,85,247,.95));
      border-color: rgba(99,102,241,.35);
      color: white !important;
    }
    .btn-primary:hover{
      filter: brightness(1.02);
      background: linear-gradient(135deg, rgba(99,102,241,1), rgba(168,85,247,1));
    }
    .btn-danger{
      background: rgba(239,68,68,.10);
      border-color: rgba(239,68,68,.22);
      color: rgba(185,28,28,.95) !important;
    }
    .btn-danger:hover{ background: rgba(239,68,68,.14); }

    /* inputs */
    input, select{
  background: rgba(255,255,255,.75) !important;
  border-color: rgba(99,102,241,.22) !important;
  color: var(--ink) !important;
}

    input::placeholder{ color: rgba(15,23,42,.45); }
    option{ color: var(--ink); }

    /* table lines */
    table th, table td { border-color: rgba(15,23,42,.10) !important; }

    /* Tailwind utility overrides (because markup uses text-white/xx everywhere) */
    .text-white{ color: var(--ink) !important; }
    .text-white\/80{ color: rgba(15,23,42,.80) !important; }
    .text-white\/70{ color: rgba(15,23,42,.70) !important; }
    .text-white\/60{ color: rgba(15,23,42,.60) !important; }
    .text-white\/50{ color: rgba(15,23,42,.50) !important; }
    .text-red-300{ color: rgba(220,38,38,.90) !important; }
  
    .chip{
      border:1px solid rgba(17,24,39,.12);
      background: rgba(255,255,255,.65);
      color: rgba(17,24,39,.85);
      border-radius: 999px;
      box-shadow: 0 8px 24px rgba(17,24,39,.06);
      backdrop-filter: blur(10px);
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .chip:hover{ background: rgba(255,255,255,.85); transform: translateY(-1px); }
    .chip[data-active="true"]{
      background: rgba(124,58,237,.14);
      border-color: rgba(124,58,237,.35);
      color: rgba(76,29,149,.95);
    }
</style>
</head>

<body class="text-white">
  <div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div>
        <h1 class="text-3xl font-bold tracking-tight">가계부</h1>
        <div class="text-white/60 text-sm mt-1">
          Supabase 동기화 · 커버 대시보드 + 기록/수정 + 대량 업로드(템플릿) · 공란 스킵=기존값 유지 · 덮어쓰기=금액이 있을 때만 업데이트
        </div>
      </div>
      <div class="flex items-center gap-2">
        <div id="whoPill" class="pill rounded-full px-3 py-2 text-sm text-white/80 hidden"></div>
        <button id="btnLogout" class="btn btn-danger rounded-xl px-4 py-2 text-sm hidden">
          <i class="fa-solid fa-right-from-bracket mr-2"></i>로그아웃
        </button>
      </div>
    </div>

    <!-- Status -->
    <div class="mt-4 glass rounded-2xl p-4">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div class="text-sm text-white/70">
          <div>현재 장부: <span id="ledgerName" class="font-semibold text-white"></span></div>
          <div id="status" class="text-white/70 mt-1"></div>
          <div id="error" class="text-red-300 mt-1"></div>
        </div>

        <!-- Auth box -->
        <div id="authBox" class="glass2 rounded-2xl p-4 w-full md:w-[520px]">
          <div class="text-sm font-semibold mb-2">로그인</div>
          <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
            <input id="email" class="md:col-span-2 rounded-xl px-3 py-2 text-sm" type="email" placeholder="이메일" />
            <input id="password" class="md:col-span-2 rounded-xl px-3 py-2 text-sm" type="password" placeholder="비밀번호" />
            <button id="btnLogin" class="btn btn-primary rounded-xl px-3 py-2 text-sm">
              로그인
            </button>
            <button id="btnSignUp" class="btn rounded-xl px-3 py-2 text-sm md:col-span-5">
              처음이면 회원가입(메일 인증 필요할 수 있음)
            </button>
          </div>
          <div class="text-xs text-white/60 mt-2">
            * Supabase 설정에서 <b>Confirm email</b>이 켜져있으면, 가입 후 메일 인증을 해야 로그인돼.
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div id="appWrap" class="mt-5 hidden">
      <div class="flex flex-wrap gap-2">
        <button class="tab-btn btn rounded-xl px-4 py-2 text-sm" data-tab="dash" data-active="true">
          <i class="fa-solid fa-chart-line mr-2"></i>커버 대시보드
        </button>
        <button class="tab-btn btn rounded-xl px-4 py-2 text-sm" data-tab="edit" data-active="false">
          <i class="fa-solid fa-pen-to-square mr-2"></i>기록/수정
        </button>
        <button class="tab-btn btn rounded-xl px-4 py-2 text-sm" data-tab="bulk" data-active="false">
          <i class="fa-solid fa-file-arrow-up mr-2"></i>대량 업로드
        </button>
        <button class="tab-btn btn rounded-xl px-4 py-2 text-sm" data-tab="all" data-active="false">
          <i class="fa-solid fa-table mr-2"></i>전체 데이터/수정
        </button>
      </div>

      <!-- DASHBOARD -->
      <section id="tab-dash" class="mt-4">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
          
          <!-- slicers -->
          <div class="glass rounded-2xl p-4 lg:col-span-3">
            <div class="flex items-center justify-between mb-3">
              <div class="text-sm font-semibold">필터</div>
              <button id="btnDashRefetch" class="btn rounded-xl px-3 py-2 text-xs">
                <i class="fa-solid fa-rotate mr-2"></i>데이터 새로고침
              </button>
            </div>

            <div class="space-y-4">
              <div>
                <div class="text-xs text-black/60 mb-2">구분 (중복 선택 가능)</div>
                <div id="dashBtnsMember" class="flex flex-wrap gap-2"></div>
              </div>

              <div>
                <div class="text-xs text-black/60 mb-2">연도 (중복 선택 가능)</div>
                <div id="dashBtnsYear" class="flex flex-wrap gap-2"></div>
              </div>

              <div>
                <div class="text-xs text-black/60 mb-2">월 (중복 선택 가능)</div>
                <div id="dashBtnsMonth" class="flex flex-wrap gap-2"></div>
              </div>

              <div>
                <div class="text-xs text-black/60 mb-2">대분류 (중복 선택 가능)</div>
                <div id="dashBtnsCategory" class="flex flex-wrap gap-2 max-h-40 overflow-auto thin-scroll pr-1"></div>
              </div>

              <div>
                <div class="text-xs text-black/60 mb-2">소분류 (중복 선택 가능)</div>
                <div id="dashBtnsSubcategory" class="flex flex-wrap gap-2 max-h-44 overflow-auto thin-scroll pr-1"></div>
              </div>

              <div class="flex gap-2 pt-1">
                <button id="btnDashClear" class="btn rounded-xl px-4 py-2 text-sm w-full">
                  전체 해제
                </button>
              </div>

              <div id="dashSelectionHint" class="text-xs text-black/50">
                * 버튼을 누르면 즉시 반영돼. (중복 선택은 합산)
              </div>
            </div>
          </div>

          <!-- main dashboard -->

          <div class="lg:col-span-9 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="glass rounded-2xl p-4">
              <div class="text-xs text-white/60">저축 현황</div>
              <div class="text-2xl font-bold mt-1"><span id="kpiSaving">0</span> <span class="text-base font-medium text-white/60">원</span></div>
              <div class="text-xs text-white/50 mt-2">월평균: <span id="kpiSavingAvg">0</span> 원</div>
            </div>
            <div class="glass rounded-2xl p-4">
              <div class="text-xs text-white/60">수입 현황</div>
              <div class="text-2xl font-bold mt-1"><span id="kpiIncome">0</span> <span class="text-base font-medium text-white/60">원</span></div>
              <div class="text-xs text-white/50 mt-2">월평균: <span id="kpiIncomeAvg">0</span> 원</div>
            </div>
            <div class="glass rounded-2xl p-4">
              <div class="text-xs text-white/60">지출 현황</div>
              <div class="text-2xl font-bold mt-1"><span id="kpiExpense">0</span> <span class="text-base font-medium text-white/60">원</span></div>
              <div class="text-xs text-white/50 mt-2">월평균: <span id="kpiExpenseAvg">0</span> 원</div>
            </div>

            <div class="glass rounded-2xl p-4 md:col-span-2">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold"><i class="fa-regular fa-chart-bar mr-2"></i>지출 요약 (대분류)</div>
                <div class="text-xs text-white/50">선택 조건 기준</div>
              </div>
              <div class="mt-3 h-[260px]">
                <canvas id="chartCategory"></canvas>
              </div>
            </div>

            <div class="glass rounded-2xl p-4 md:col-span-1">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold"><i class="fa-solid fa-list-ol mr-2"></i>지출 Top 10</div>
              </div>
              <div class="mt-3 h-[260px]">
                <canvas id="chartTop10"></canvas>
              </div>
            </div>

            
            <div class="glass rounded-2xl p-4 md:col-span-1">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold"><i class="fa-solid fa-chart-pie mr-2"></i>흐름 비중</div>
              </div>
              <div class="mt-3 h-[260px]">
                <canvas id="chartFlowShare"></canvas>
              </div>
            </div>

            <div class="glass rounded-2xl p-4 md:col-span-2">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold"><i class="fa-solid fa-layer-group mr-2"></i>월별 합계(스택)</div>
                <div class="text-xs text-black/50">지출/수입/저축</div>
              </div>
              <div class="mt-3 h-[260px]">
                <canvas id="chartMonthlyStack"></canvas>
              </div>
            </div>
<div class="glass rounded-2xl p-4 md:col-span-3">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold"><i class="fa-regular fa-calendar mr-2"></i>월별 지출/수입/저축 추이</div>
                <div class="text-xs text-white/50">연도=전체면 전체기간</div>
              </div>
              <div class="mt-3 h-[280px]">
                <canvas id="chartMonthly"></canvas>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- EDIT -->
      <section id="tab-edit" class="mt-4 hidden">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
          <div class="glass rounded-2xl p-4 lg:col-span-4">
            <div class="text-sm font-semibold mb-3">거래 입력/수정</div>
            <form id="entryForm" class="space-y-3">
              <input type="hidden" id="editId" value="" />
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <div class="text-xs text-white/60 mb-1">날짜</div>
                  <input id="entryDate" type="date" class="w-full rounded-xl px-3 py-2 text-sm" required />
                </div>
                <div>
                  <div class="text-xs text-white/60 mb-1">구분</div>
                  <select id="memberSelect" class="w-full rounded-xl px-3 py-2 text-sm" required></select>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-2">
                <div>
                  <div class="text-xs text-white/60 mb-1">흐름</div>
                  <select id="flowType" class="w-full rounded-xl px-3 py-2 text-sm">
                    <option value="expense">지출</option>
                    <option value="income">수입</option>
                    <option value="saving">저축</option>
                  </select>
                </div>
                <div>
                  <div class="text-xs text-white/60 mb-1">금액</div>
                  <input id="amount" type="number" min="0" step="1" class="w-full rounded-xl px-3 py-2 text-sm" required />
                </div>
              </div>

              <div>
                <div class="text-xs text-white/60 mb-1">대분류</div>
                <input id="category" class="w-full rounded-xl px-3 py-2 text-sm" placeholder="예: 식비" />
              </div>

              <div>
                <div class="text-xs text-white/60 mb-1">소분류</div>
                <input id="subcategory" class="w-full rounded-xl px-3 py-2 text-sm" placeholder="예: 외식" />
              </div>

              <div>
                <div class="text-xs text-white/60 mb-1">설명/상세</div>
                <input id="detail" class="w-full rounded-xl px-3 py-2 text-sm" placeholder="예: 점심" required />
              </div>

              <div>
                <div class="text-xs text-white/60 mb-1">메모(선택)</div>
                <input id="memo" class="w-full rounded-xl px-3 py-2 text-sm" placeholder="선택" />
              </div>

              <div class="flex gap-2">
                <button id="btnSubmit" type="submit" class="btn btn-primary rounded-xl px-4 py-2 text-sm w-full">추가</button>
                <button id="btnCancelEdit" type="button" class="btn rounded-xl px-4 py-2 text-sm w-full hidden">수정 취소</button>
              </div>
              <!-- 카테고리/설명 일괄 변경 -->
<div class="mt-6 glass2 rounded-2xl p-4">
  <div class="flex items-center justify-between">
    <div class="text-sm font-semibold">카테고리/설명 일괄 변경</div>
    <div class="text-xs text-black/50">기존 데이터 전체에 반영</div>
  </div>

  <div class="text-xs text-black/60 mt-2">
    * “기존값” 조건에 맞는 거래를 찾아서 “변경값”으로 바꿔. (공란인 변경값은 해당 필드 변경 안 함)
  </div>

  <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
    <div class="glass rounded-2xl p-3">
      <div class="text-xs font-semibold text-black/70 mb-2">기존값(찾을 조건)</div>
      <div class="space-y-2">
        <input id="renameOldCategory" class="w-full rounded-xl px-3 py-2 text-sm" placeholder="기존 대분류 (예: 식비)" />
        <input id="renameOldSubcategory" class="w-full rounded-xl px-3 py-2 text-sm" placeholder="기존 소분류 (예: 외식)" />
        <input id="renameOldDetail" class="w-full rounded-xl px-3 py-2 text-sm" placeholder="기존 설명 (예: 점심)" />
      </div>
    </div>

    <div class="glass rounded-2xl p-3">
      <div class="text-xs font-semibold text-black/70 mb-2">변경값(바꿀 값)</div>
      <div class="space-y-2">
        <input id="renameNewCategory" class="w-full rounded-xl px-3 py-2 text-sm" placeholder="새 대분류 (예: 식비)" />
        <input id="renameNewSubcategory" class="w-full rounded-xl px-3 py-2 text-sm" placeholder="새 소분류 (예: 외식/배달)" />
        <input id="renameNewDetail" class="w-full rounded-xl px-3 py-2 text-sm" placeholder="새 설명 (예: 점심/저녁)" />
      </div>
    </div>
  </div>

  <div class="mt-3 flex gap-2">
    <button id="btnRenameApply" class="btn btn-primary rounded-xl px-4 py-2 text-sm w-full">
      <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>일괄 변경 실행
    </button>
    <button id="btnRenameClear" class="btn rounded-xl px-4 py-2 text-sm">
      초기화
    </button>
  </div>

  <div id="renameHint" class="text-xs text-black/60 mt-2"></div>
</div>



              
            </form>
          </div>

          <div class="glass rounded-2xl p-4 lg:col-span-8">
            <div class="flex flex-wrap gap-2 items-end justify-between">
              <div>
                <div class="text-sm font-semibold">거래 목록</div>
                <div class="text-xs text-white/60 mt-1">필터로 빠르게 찾고 수정/삭제</div>
              </div>
              <div class="flex flex-wrap gap-2 items-center">
                <input id="filterFrom" type="date" class="rounded-xl px-3 py-2 text-sm" />
                <input id="filterTo" type="date" class="rounded-xl px-3 py-2 text-sm" />
                <select id="filterFlow" class="rounded-xl px-3 py-2 text-sm">
                  <option value="all">전체 흐름</option>
                  <option value="expense">지출</option>
                  <option value="income">수입</option>
                  <option value="saving">저축</option>
                </select>
                <select id="filterMember" class="rounded-xl px-3 py-2 text-sm">
                  <option value="all">전체 구분</option>
                </select>
                <input id="filterQ" class="rounded-xl px-3 py-2 text-sm" placeholder="검색(상세/메모)" />
                <button id="btnApplyFilter" class="btn btn-primary rounded-xl px-4 py-2 text-sm">적용</button>
                <button id="btnReload" class="btn rounded-xl px-4 py-2 text-sm">새로고침</button>
              </div>
            </div>

            <div class="mt-4 overflow-auto thin-scroll">
              <table class="w-full text-sm border-separate border-spacing-0">
                <thead class="text-white/70">
                  <tr>
                    <th class="text-left py-3 px-3 border-b">날짜</th>
                    <th class="text-left py-3 px-3 border-b">구분</th>
                    <th class="text-left py-3 px-3 border-b">흐름</th>
                    <th class="text-left py-3 px-3 border-b">대분류</th>
                    <th class="text-left py-3 px-3 border-b">소분류</th>
                    <th class="text-left py-3 px-3 border-b">설명</th>
                    <th class="text-right py-3 px-3 border-b">금액</th>
                    <th class="text-left py-3 px-3 border-b">메모</th>
                    <th class="text-left py-3 px-3 border-b">관리</th>
                  </tr>
                </thead>
                <tbody id="entriesTbody"></tbody>
              </table>
            </div>
            <div class="text-xs text-white/60 mt-3">총 <span id="count">0</span></div>
          </div>
        </div>
      </section>

      <!-- BULK -->
      <section id="tab-bulk" class="mt-4 hidden">
        <div class="glass rounded-2xl p-4">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <div class="text-sm font-semibold">대량 업로드</div>
              <div class="text-xs text-white/60 mt-1">
                템플릿(기록 시트) 다운로드 → 금액만 채우기 → 업로드.
                <b>날짜(A열)</b>는 가능한 한 <b>반드시 입력(YYYY-MM-DD)</b>. (연도 없는 'M/D'만 쓸 경우 기본 월의 연도를 사용)
                <b>금액(E/F/G)</b> 공란은 스킵(기존값 유지). 금액이 있으면 덮어쓰기(upsert).
              </div>
            </div>
            <div class="flex flex-wrap gap-2 items-center">
              <div class="text-xs text-white/60">기본 월(선택)</div>
              <input id="bulkYm" type="month" class="rounded-xl px-3 py-2 text-sm" />
              <button id="btnDownloadTemplate" class="btn btn-primary rounded-xl px-4 py-2 text-sm">
                <i class="fa-solid fa-download mr-2"></i>기록 템플릿 다운로드
              </button>
            </div>
          </div>

          <div class="mt-4 glass2 rounded-2xl p-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
              <div class="flex items-center gap-3">
                <input id="bulkFile" type="file" accept=".xlsx,.xls" class="text-sm" />
                <button id="btnBulkUpload" class="btn btn-primary rounded-xl px-4 py-2 text-sm">
                  <i class="fa-solid fa-file-arrow-up mr-2"></i>업로드 실행
                </button>
              </div>
              <div class="text-xs text-white/60">
                * 업로드는 <b>entries</b> 테이블에 기록돼. (멤버=돌프/천사/공통)
              </div>
            </div>

            <div class="mt-3 text-xs text-white/60">
              업로드 규칙(중요):
              <ul class="list-disc ml-5 mt-1 space-y-1">
                <li>키(덮어쓰기 기준): ledger_id + entry_date + member_id + category + subcategory + detail + flow_type</li>
                <li>같은 키로 다시 업로드하면 <b>금액</b>만 업데이트(=덮어쓰기). 금액 공란이면 건드리지 않음.</li>
                <li>대분류가 <b>수입</b>이면 flow=income, <b>금융·저축/저축</b>이면 flow=saving, 그 외 expense</li>
              </ul>
            </div>
          </div>
        </div>
      </section>

      <!-- ALL DATA GRID (월별 매트릭스 편집) -->
      <section id="tab-all" class="mt-4 hidden">
        <div class="glass rounded-2xl p-4">
          <div class="flex flex-col gap-3 lg:flex-row lg:items-end lg:justify-between">
            <div>
              <div class="text-sm font-semibold">월별 매트릭스(전체) · 셀 더블클릭 수정</div>
              <div class="text-xs text-black/60 mt-1">
                대분류/소분류/설명을 세로로 고정하고, 월을 가로축으로 펼쳐서 한 번에 보고 수정할 수 있어.
              </div>
            </div>

            <div class="flex flex-wrap gap-2 items-center">
              <div class="text-xs text-black/60">연도</div>
              <select id="mxYear" class="rounded-xl px-3 py-2 text-sm"></select>
<div class="text-xs text-black/60 ml-1">흐름</div>
              <select id="mxFlow" class="rounded-xl px-3 py-2 text-sm">
                <option value="expense">지출</option>
                <option value="income">수입</option>
                <option value="saving">저축</option>
              </select>

              <button id="btnMxReload" class="btn rounded-xl px-4 py-2 text-sm">
                <i class="fa-solid fa-rotate mr-2"></i>새로고침
              </button>
            </div>
          </div>

          <div class="mt-4 glass2 rounded-2xl p-3">
            <div class="text-xs text-black/60">
              * 수정: 셀 더블클릭 → 금액 입력 → Enter/포커스아웃 저장 (빈칸으로 저장하면 해당 월/멤버 항목 삭제)
            </div>
          </div>

          <div class="mt-4 overflow-auto thin-scroll">
            <table class="w-full text-sm border-separate border-spacing-0" id="mxTable">
              <thead id="mxThead" class="text-black/70 sticky top-0 bg-white/60 backdrop-blur"></thead>
              <tbody id="mxTbody"></tbody>
            </table>
          </div>
          <div class="text-xs text-black/60 mt-3">행 <span id="mxRowCount">0</span> · 셀 <span id="mxCellCount">0</span></div>
        </div>
      </section>
    </div>
  </div>

<script>
/** =========================
 * 0) Project config
 * ========================= */
    // --- XLSX 로더 가드 ---
    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
    async function waitForXLSX(timeoutMs = 8000){
      const t0 = Date.now();
      while(Date.now() - t0 < timeoutMs){
        if (window.XLSX && window.XLSX.utils && window.XLSX.writeFile) return true;
        await sleep(50);
      }
      return false;
    }

const SUPABASE_URL = "https://cqxpmfxwgrpdtxomxfiz.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNxeHBtZnh3Z3JwZHR4b214Zml6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MTQ1NzAsImV4cCI6MjA4MzQ5MDU3MH0.YUGKXlqNpltt_JI_tyvgE-FhLXRILq0v7-gpLpQgo0M";

const DEFAULT_LEDGER_NAME = "우리집";
const DEFAULT_START_DATE = "2026-01-01";
const SS_KEY = "ledger_session_v2";

let session = null; // { access_token, refresh_token, user }
let currentLedgerId = null;
let membersCache = []; // {id,name,kind}
let memberNameToId = new Map();

const byId = (id) => document.getElementById(id);
const fmt = (n) => Number(n||0).toLocaleString("ko-KR");

function setStatus(msg){ byId("status").textContent = msg || ""; }
function setError(msg){ byId("error").textContent = msg || ""; }
function todayISO(){
  const d = new Date();
  const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
  return z.toISOString().slice(0,10);
}
function ymFromInput(){
  const v = (byId("bulkYm").value || "").trim();
  if(!v) return "";
  return v; // YYYY-MM
}

function saveSession(s){
  session = s;
  if(s) localStorage.setItem(SS_KEY, JSON.stringify(s));
  else localStorage.removeItem(SS_KEY);
}
function loadSession(){
  const raw = localStorage.getItem(SS_KEY);
  if(!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
}

async function apiFetch(path, { method="GET", query=null, body=null, auth=true, preferReturn=true, extraHeaders=null } = {}){
  const url = new URL(SUPABASE_URL + path);
  if(query){
    for(const [k,v] of Object.entries(query)){
      if(v === undefined || v === null) continue;
      url.searchParams.set(k, v);
    }
  }

  const headers = {
    "apikey": SUPABASE_KEY,
    "Content-Type": "application/json",
    ...(extraHeaders || {})
  };
  if(auth && session?.access_token){
    headers["Authorization"] = "Bearer " + session.access_token;
  }
  if(preferReturn && (method==="POST" || method==="PATCH")){
    headers["Prefer"] = headers["Prefer"] ? headers["Prefer"] + ", return=representation" : "return=representation";
  }

  const res = await fetch(url.toString(), {
    method,
    headers,
    body: body ? JSON.stringify(body) : undefined
  });

  const text = await res.text();
  let data = null;
  try { data = text ? JSON.parse(text) : null; } catch { data = text || null; }

  if(!res.ok){
    const msg = typeof data === "object" && data ? (data.message || data.msg || data.error_description || JSON.stringify(data)) : String(data);
    throw new Error(msg || `HTTP ${res.status}`);
  }
  return data;
}

/** =========================
 * 1) Auth (email+password)
 * ========================= */
async function loginWithPassword(email, password){
  const data = await apiFetch("/auth/v1/token", {
    method:"POST",
    auth:false,
    preferReturn:false,
    query:{ grant_type:"password" },
    body:{ email, password }
  });
  const access_token = data?.access_token;
  const refresh_token = data?.refresh_token;
  if(!access_token) throw new Error("로그인 실패: 토큰이 없어");
  saveSession({ access_token, refresh_token, user:null });
  const user = await fetchUser();
  saveSession({ ...session, user });
}

async function signUp(email, password){
  await apiFetch("/auth/v1/signup", {
    method:"POST",
    auth:false,
    preferReturn:false,
    body:{ email, password }
  });
  // 바로 로그인 시도 (confirm email이 켜져있으면 여기서 실패할 수 있음)
  await loginWithPassword(email, password);
}

async function fetchUser(){
  return await apiFetch("/auth/v1/user", { method:"GET", auth:true, preferReturn:false });
}
async function logout(){
  saveSession(null);
}

/** =========================
 * 2) DB bootstrap (ledger + members)
 * ========================= */
async function ensureDefaultLedger(){
  const ledgers = await apiFetch("/rest/v1/ledgers", {
    query: { select:"id,name,created_at", order:"created_at.asc" }
  });

  if(ledgers?.length){
    currentLedgerId = ledgers[0].id;
    byId("ledgerName").textContent = ledgers[0].name;
    return;
  }

  // ledger create
  const createdArr = await apiFetch("/rest/v1/ledgers", {
    method:"POST",
    body:{ name: DEFAULT_LEDGER_NAME, created_by: session.user.id }
  });
  const created = createdArr?.[0];
  if(!created?.id) throw new Error("장부 생성 실패");
  currentLedgerId = created.id;
  byId("ledgerName").textContent = DEFAULT_LEDGER_NAME;

  // 트리거가 있다면 owner+공통 생성됨. 없다면 아래가 필요.
  // 안전상: 시도만 하고 실패해도 무시 (이미 존재할 수 있음)
  try{
    await apiFetch("/rest/v1/ledger_members", {
      method:"POST",
      body:{ ledger_id: currentLedgerId, user_id: session.user.id, role:"owner" },
      preferReturn:false
    });
  }catch(e){}

  try{
    await apiFetch("/rest/v1/members", {
      method:"POST",
      body:{ ledger_id: currentLedgerId, name:"공통", kind:"common" },
      preferReturn:false
    });
  }catch(e){}
}

/** =========================
 * 3) Members
 * ========================= */
async function loadMembers(){
  const members = await apiFetch("/rest/v1/members", {
    query:{
      select:"id,name,kind,is_active",
      ledger_id:`eq.${currentLedgerId}`,
      is_active:"eq.true",
      order:"kind.desc,name.asc"
    }
  });

  membersCache = members || [];
  memberNameToId = new Map(membersCache.map(m => [m.name, m.id]));

  // edit form select
  const sel = byId("memberSelect");
  sel.innerHTML = "";
  for(const m of membersCache){
    const opt = document.createElement("option");
    opt.value = m.id;
    opt.textContent = `${m.name}${m.kind==="common" ? " (공통)" : ""}`;
    sel.appendChild(opt);
  }

  // filter member
  const filterMember = byId("filterMember");
  const prev = filterMember.value || "all";
  filterMember.innerHTML = `<option value="all">전체 구분</option>`;
  for(const m of membersCache){
    const opt = document.createElement("option");
    opt.value = m.id;
    opt.textContent = `${m.name}${m.kind==="common" ? " (공통)" : ""}`;
    filterMember.appendChild(opt);
  }
  filterMember.value = prev;
}

/** =========================
 * 4) Entries CRUD
 * ========================= */
function getFilters(){
  return {
    from: byId("filterFrom").value || DEFAULT_START_DATE,
    to: byId("filterTo").value || todayISO(),
    flow: byId("filterFlow").value,
    memberId: byId("filterMember").value,
    q: (byId("filterQ").value || "").trim(),
  };
}

async function loadEntries(){
  const f = getFilters();
  const url = new URL(SUPABASE_URL + "/rest/v1/entries");
  url.searchParams.set("select", "id,entry_date,flow_type,amount,detail,subcategory,category,memo,member_id,created_at");
  url.searchParams.set("ledger_id", `eq.${currentLedgerId}`);
  url.searchParams.set("entry_date", `gte.${f.from}`);
  url.searchParams.append("entry_date", `lte.${f.to}`);
  if(f.flow !== "all") url.searchParams.set("flow_type", `eq.${f.flow}`);
  if(f.memberId !== "all") url.searchParams.set("member_id", `eq.${f.memberId}`);
  url.searchParams.set("order", "entry_date.desc,created_at.desc");

  const headers = {
    "apikey": SUPABASE_KEY,
    "Authorization": "Bearer " + session.access_token,
  };

  const res = await fetch(url.toString(), { headers });
  const data = await res.json();
  if(!res.ok) throw new Error(data?.message || JSON.stringify(data));

  const rows = (f.q)
    ? data.filter(r => (r.detail||"").includes(f.q) || (r.memo||"").includes(f.q))
    : data;

  renderEntries(rows);
  byId("count").textContent = `${rows.length}건`;
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function memberNameById(id){
  const m = membersCache.find(x=>x.id===id);
  return m ? m.name : "";
}

function renderEntries(rows){
  const tbody = byId("entriesTbody");
  tbody.innerHTML = "";
  for(const r of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="py-2 px-3 border-b text-white/80">${escapeHtml(r.entry_date)}</td>
      <td class="py-2 px-3 border-b text-white/80">${escapeHtml(memberNameById(r.member_id))}</td>
      <td class="py-2 px-3 border-b text-white/80">${escapeHtml(r.flow_type)}</td>
      <td class="py-2 px-3 border-b text-white/80">${escapeHtml(r.category || "")}</td>
      <td class="py-2 px-3 border-b text-white/80">${escapeHtml(r.subcategory || "")}</td>
      <td class="py-2 px-3 border-b text-white/80">${escapeHtml(r.detail || "")}</td>
      <td class="py-2 px-3 border-b text-right font-semibold">${fmt(r.amount)}</td>
      <td class="py-2 px-3 border-b text-white/70">${escapeHtml(r.memo || "")}</td>
      <td class="py-2 px-3 border-b">
        <div class="flex gap-2">
          <button class="btn rounded-lg px-3 py-1 text-xs" data-act="edit"><i class="fa-regular fa-pen-to-square mr-1"></i>수정</button>
          <button class="btn btn-danger rounded-lg px-3 py-1 text-xs" data-act="del"><i class="fa-regular fa-trash-can mr-1"></i>삭제</button>
        </div>
      </td>
    `;
    tr.querySelector('[data-act="edit"]').addEventListener("click", () => startEdit(r));
    tr.querySelector('[data-act="del"]').addEventListener("click", async () => {
      if(!confirm("삭제할까?")) return;
      await apiFetch("/rest/v1/entries", { method:"DELETE", query:{ id:`eq.${r.id}` }, preferReturn:false });
      await refreshEverything();
    });
    tbody.appendChild(tr);
  }
}

function startEdit(r){
  byId("editId").value = r.id;
  byId("entryDate").value = r.entry_date;
  byId("flowType").value = r.flow_type;
  byId("amount").value = r.amount;
  byId("detail").value = r.detail || "";
  byId("memo").value = r.memo || "";
  byId("category").value = r.category || "";
  byId("subcategory").value = r.subcategory || "";
  byId("memberSelect").value = r.member_id;
  byId("btnSubmit").textContent = "수정 저장";
  byId("btnCancelEdit").classList.remove("hidden");
}

function cancelEdit(){
  byId("editId").value = "";
  byId("btnSubmit").textContent = "추가";
  byId("btnCancelEdit").classList.add("hidden");
}

async function upsertEntryFromForm(){
  const id = byId("editId").value || null;
  const entry_date = byId("entryDate").value;
  const member_id = byId("memberSelect").value;
  const flow_type = byId("flowType").value;
  const amount = Number(byId("amount").value || 0);
  const detail = (byId("detail").value || "").trim();
  const memo = (byId("memo").value || "").trim();
  const category = (byId("category").value || "").trim();
  const subcategory = (byId("subcategory").value || "").trim();

  if(!entry_date) throw new Error("날짜를 선택해줘");
  if(!member_id) throw new Error("구분을 선택해줘");
  if(!detail) throw new Error("설명을 입력해줘");
  if(!Number.isFinite(amount) || amount < 0) throw new Error("금액을 확인해줘");

  const payload = {
    ledger_id: currentLedgerId,
    entry_date,
    member_id,
    flow_type,
    amount,
    detail,
    category: category || "",
    subcategory: subcategory || "",
    created_by: session.user.id
  };
  if(memo) payload.memo = memo;

  if(!id){
    await apiFetch("/rest/v1/entries", { method:"POST", body: payload });
  }else{
    await apiFetch("/rest/v1/entries", { method:"PATCH", query:{ id:`eq.${id}` }, body: payload });
  }

  byId("entryForm").reset();
  byId("entryDate").value = todayISO();
  cancelEdit();
}
async function renameCategoryBatch(){
  setError("");
  setStatus("");

  const oldCategory = (byId("renameOldCategory").value || "").trim();
  const oldSubcategory = (byId("renameOldSubcategory").value || "").trim();
  const oldDetail = (byId("renameOldDetail").value || "").trim();

  const newCategory = (byId("renameNewCategory").value || "").trim();
  const newSubcategory = (byId("renameNewSubcategory").value || "").trim();
  const newDetail = (byId("renameNewDetail").value || "").trim();

  // 최소 안전장치: 조건이 너무 넓은 실수 방지
  if(!oldCategory && !oldSubcategory && !oldDetail){
    throw new Error("기존값(찾을 조건)에서 최소 1개는 입력해야 해.");
  }

  // 변경값이 전부 비면 할 게 없음
  if(!newCategory && !newSubcategory && !newDetail){
    throw new Error("변경값(바꿀 값)을 최소 1개는 입력해야 해.");
  }

  // 1) 대상 id들 가져오기
  const url = new URL(SUPABASE_URL + "/rest/v1/entries");
  url.searchParams.set("select", "id");
  url.searchParams.set("ledger_id", `eq.${currentLedgerId}`);

  if(oldCategory !== "") url.searchParams.set("category", `eq.${oldCategory}`);
  if(oldSubcategory !== "") url.searchParams.set("subcategory", `eq.${oldSubcategory}`);
  if(oldDetail !== "") url.searchParams.set("detail", `eq.${oldDetail}`);

  url.searchParams.set("limit", "12000");

  const headers = { "apikey": SUPABASE_KEY, "Authorization": "Bearer " + session.access_token };
  setStatus("변경 대상 찾는 중...");
  const res = await fetch(url.toString(), { headers });
  const data = await res.json();
  if(!res.ok) throw new Error(data?.message || JSON.stringify(data));

  const ids = (data || []).map(x => x.id).filter(Boolean);
  byId("renameHint").textContent = `대상 ${ids.length}건`;

  if(!ids.length){
    setStatus("조건에 맞는 데이터가 없어. (0건)");
    return;
  }

  if(!confirm(`조건에 맞는 ${ids.length}건을 일괄 변경할까?`)){
    setStatus("취소됨");
    return;
  }

  // 2) PATCH payload (공란은 변경 안 함)
  const patchBody = {};
  if(newCategory !== "") patchBody.category = newCategory;
  if(newSubcategory !== "") patchBody.subcategory = newSubcategory;
  if(newDetail !== "") patchBody.detail = newDetail;

  // 3) id IN으로 청크 PATCH
  setStatus("일괄 변경 적용 중...");
  const chunkSize = 200;

  for(let i=0;i<ids.length;i+=chunkSize){
    const part = ids.slice(i, i+chunkSize);
    await apiFetch("/rest/v1/entries", {
      method:"PATCH",
      preferReturn:false,
      query:{ id: `in.(${part.join(",")})` },
      body: patchBody
    });
    await sleep(60);
  }

  setStatus(`일괄 변경 완료! (${ids.length}건)`);
  await refreshEverything();
}


/** =========================
 * 5) ALL DATA GRID → 월별 매트릭스 편집 (월×멤버 3컬럼)
 *    - 세로: (대분류/소분류/설명)
 *    - 가로: 1~12월 × (돌프/천사/공통)
 *    - 셀 더블클릭: 금액 수정(upsert) / 빈칸 저장: 삭제
 * ========================= */
function monthLabels(){ return Array.from({length:12}, (_,i)=>String(i+1).padStart(2,"0")); }

function buildMatrixRowKey(flow_type, category, subcategory, detail){
  return [flow_type, category||"", subcategory||"", detail||""].join("||");
}

function getMatrixMembers3(){
  // 돌프/천사/공통 3개를 고정 노출 (없으면 가능한 것만)
  const pick = (name)=>{
    const list = membersCache.filter(m => m.name === name);
    if(!list.length) return null;
    if(name === "공통") return (list.find(m=>m.kind==="common") || list[0]);
    return list[0];
  };
  const arr = [pick("돌프"), pick("천사"), pick("공통")].filter(Boolean);
  return arr; // [{id,name,kind}, ...]
}

async function fetchEntriesForMatrix(year, flow_type){
  const url = new URL(SUPABASE_URL + "/rest/v1/entries");
  url.searchParams.set("select", "entry_date,flow_type,amount,category,subcategory,detail,member_id,created_at");
  url.searchParams.set("ledger_id", `eq.${currentLedgerId}`);
  url.searchParams.set("flow_type", `eq.${flow_type}`);
  url.searchParams.set("entry_date", `gte.${year}-01-01`);
  url.searchParams.append("entry_date", `lte.${year}-12-31`);
  url.searchParams.set("order", "entry_date.asc,created_at.asc");
  url.searchParams.set("limit", "12000");

  const headers = { "apikey": SUPABASE_KEY, "Authorization": "Bearer " + session.access_token };
  const res = await fetch(url.toString(), { headers });
  const data = await res.json();
  if(!res.ok) throw new Error(data?.message || JSON.stringify(data));
  return data || [];
}

function fillMatrixFilters(years){
  const ySel = byId("mxYear");
  const prevY = ySel.value || "";
  ySel.innerHTML = years.map(y=>`<option value="${y}">${y}년</option>`).join("");
  ySel.value = years.includes(prevY) ? prevY : (years.at(-1) || new Date().getFullYear().toString());
}

function renderMatrixTable3({ year, flow_type, rows }){
  const months = monthLabels();
  const members3 = getMatrixMembers3();
  if(members3.length < 3){
    setError("members 테이블에 '돌프/천사/공통'이 모두 있어야 3컬럼 매트릭스를 완전하게 표시할 수 있어. (일부만 있으면 있는 멤버만 표시함)");
  }

  // Pivot: rowKey -> {meta, cell[mm][member_id]=sum}
  const map = new Map();
  for(const r of rows){
    const mk = (r.entry_date||"").slice(5,7);
    if(!months.includes(mk)) continue;

    const cat = (r.category || "");
    const sub = (r.subcategory || "");
    const det = (r.detail || "");
    const key = buildMatrixRowKey(flow_type, cat, sub, det);

    if(!map.has(key)){
      const cell = {};
      for(const mm of months){
        cell[mm] = {};
        for(const m of members3){
          cell[mm][m.id] = 0;
        }
      }
      map.set(key, { flow_type, category: cat, subcategory: sub, detail: det, cell });
    }

    const obj = map.get(key);
    if(obj.cell[mk] && obj.cell[mk][r.member_id] !== undefined){
      obj.cell[mk][r.member_id] += Number(r.amount||0);
    }
  }

  const arr = [...map.values()].sort((a,b)=>{
    const A = `${a.category}||${a.subcategory}||${a.detail}`;
    const B = `${b.category}||${b.subcategory}||${b.detail}`;
    return A.localeCompare(B, "ko");
  });

  // THEAD (2 rows: month colspans + member names)
const thead = byId("mxThead");
thead.innerHTML = `
  <tr>
    <th class="text-left py-3 px-3 border-b sticky left-0 bg-white/70 backdrop-blur z-30">대분류</th>
    <th class="text-left py-3 px-3 border-b sticky left-[160px] bg-white/70 backdrop-blur z-30">소분류</th>
    <th class="text-left py-3 px-3 border-b sticky left-[320px] bg-white/70 backdrop-blur z-30">설명</th>
    ${months.map(mm => `
      <th class="text-center py-3 px-3 border-b bg-white/70 backdrop-blur" colspan="${members3.length}">
        ${Number(mm)}월
      </th>
    `).join("")}
  </tr>
  <tr>
    <th class="border-b sticky left-0 bg-white/70 backdrop-blur z-30"></th>
    <th class="border-b sticky left-[160px] bg-white/70 backdrop-blur z-30"></th>
    <th class="border-b sticky left-[320px] bg-white/70 backdrop-blur z-30"></th>
    ${months.map(()=>members3.map(m=>`
      <th class="text-right py-2 px-3 border-b bg-white/70 backdrop-blur min-w-[110px]">
        ${escapeHtml(m.name)}
      </th>
    `).join("")).join("")}
  </tr>
`;



  const tbody = byId("mxTbody");
  tbody.innerHTML = "";
  let cellCount = 0;

  for(const row of arr){
    const tr = document.createElement("tr");

    const tdCat = document.createElement("td");
    tdCat.className = "py-2 px-3 border-b sticky left-0 bg-white/60 backdrop-blur z-20 min-w-[160px] max-w-[160px] truncate";
    tdCat.textContent = row.category || "미분류";

    const tdSub = document.createElement("td");
    tdSub.className = "py-2 px-3 border-b sticky left-[160px] bg-white/60 backdrop-blur z-20 min-w-[160px] max-w-[160px] truncate";
    tdSub.textContent = row.subcategory || "";

    const tdDet = document.createElement("td");
    tdDet.className = "py-2 px-3 border-b sticky left-[320px] bg-white/60 backdrop-blur z-20 min-w-[260px] max-w-[360px] truncate";
    tdDet.textContent = row.detail || "";

    tr.appendChild(tdCat);
    tr.appendChild(tdSub);
    tr.appendChild(tdDet);

    for(const mm of months){
      for(const m of members3){
        const td = document.createElement("td");
        td.className = "py-2 px-3 border-b text-right font-medium hover:bg-black/5 rounded-lg cursor-pointer";
        td.dataset.year = year;
        td.dataset.month = mm;
        td.dataset.member_id = m.id;
        td.dataset.member_name = m.name;
        td.dataset.flow = flow_type;
        td.dataset.category = row.category || "";
        td.dataset.subcategory = row.subcategory || "";
        td.dataset.detail = row.detail || "";
        td.textContent = fmt((row.cell?.[mm]?.[m.id]) || 0);
        cellCount++;

        td.addEventListener("dblclick", ()=> startCellEdit3(td));
        tr.appendChild(td);
      }
    }

    tbody.appendChild(tr);
  }

  byId("mxRowCount").textContent = String(arr.length);
  byId("mxCellCount").textContent = String(cellCount);
}

function startCellEdit3(td){
  setError("");
  if(td.querySelector("input")) return;

  const prevText = td.textContent;
  const prevVal = Number(String(prevText).replaceAll(",","")) || 0;

  const inp = document.createElement("input");
  inp.type = "number";
  inp.min = "0";
  inp.step = "1";
  inp.value = String(prevVal);
  inp.className = "w-full rounded-lg px-2 py-1 text-sm text-right";

  td.innerHTML = "";
  td.appendChild(inp);
  inp.focus();
  inp.select();

  const restore = ()=>{ td.textContent = prevText; };

  const commit = async ()=>{
    const v = inp.value.trim();

    const year = td.dataset.year;
    const mm = td.dataset.month;
    const member_id = td.dataset.member_id;
    const flow_type = td.dataset.flow;
    const category = td.dataset.category || "";
    const subcategory = td.dataset.subcategory || "";
    const detail = td.dataset.detail || "";
   const entry_date = String(`${year}-${mm}-01`);


    try{
      setStatus("저장 중...");

      // 빈칸 저장: 삭제
      if(v === ""){
        await apiFetch("/rest/v1/entries", {
          method:"DELETE",
          preferReturn:false,
          query:{
            ledger_id:`eq.${currentLedgerId}`,
            entry_date:`eq.${entry_date}`,
            member_id:`eq.${member_id}`,
            flow_type:`eq.${flow_type}`,
            category:`eq.${category}`,
            subcategory:`eq.${subcategory}`,
            detail:`eq.${detail}`
          }
        });
        td.textContent = fmt(0);
        setStatus("삭제 완료!");
        return;
      }

      const amount = Number(v);
      if(!Number.isFinite(amount) || amount < 0){
        restore();
        setStatus("");
        setError("금액을 확인해줘 (0 이상의 숫자)");
        return;
      }

      const payload = {
        ledger_id: currentLedgerId,
        entry_date,
        member_id,
        flow_type,
        amount,
        detail,
        category,
        subcategory,
        created_by: session.user.id
      };

      const onConflict = "ledger_id,entry_date,member_id,flow_type,category,subcategory,detail";
      await apiFetch("/rest/v1/entries", {
        method:"POST",
        query:{ on_conflict: onConflict },
        body: [payload],
        preferReturn:false,
        extraHeaders:{ "Prefer":"resolution=merge-duplicates" }
      });

      td.textContent = fmt(amount);
      setStatus("저장 완료!");
    }catch(e){
      restore();
      setStatus("");
      setError(e?.message || String(e));
    }
  };

  inp.addEventListener("keydown", async (e)=>{
    if(e.key === "Enter"){ e.preventDefault(); await commit(); }
    if(e.key === "Escape"){ restore(); }
  });
  inp.addEventListener("blur", async ()=>{ await commit(); });
}

async function refreshMatrix(){
  // year candidates from DB quickly: use dashRowsCache if already loaded, else fetch minimal.
  let years = [];
  try{
    if(dashRowsCache?.length){
      years = [...new Set(dashRowsCache.map(r=>r.entry_date.slice(0,4)))].sort();
    }else{
      const url = new URL(SUPABASE_URL + "/rest/v1/entries");
      url.searchParams.set("select", "entry_date");
      url.searchParams.set("ledger_id", `eq.${currentLedgerId}`);
      url.searchParams.set("order", "entry_date.asc");
      url.searchParams.set("limit", "12000");
      const headers = { "apikey": SUPABASE_KEY, "Authorization": "Bearer " + session.access_token };
      const res = await fetch(url.toString(), { headers });
      const data = await res.json();
      if(res.ok) years = [...new Set((data||[]).map(r=>String(r.entry_date||"").slice(0,4)))].filter(Boolean).sort();
    }
  }catch(_){}
  if(!years.length) years = [String(new Date().getFullYear())];

  fillMatrixFilters(years);

  const year = byId("mxYear").value;
  const flow_type = byId("mxFlow").value;

  setStatus("매트릭스 로딩 중...");
  const rows = await fetchEntriesForMatrix(year, flow_type);
  renderMatrixTable3({ year, flow_type, rows });
  setStatus("준비 완료!");
}

/** =========================
 * 6) BULK TEMPLATE + UPLOAD (YOUR TEMPLATE FORMAT)
 *    - Sheet: 기록
 *    - Row1: 안내문(옵션)
 *    - Row2: 헤더 [날짜, 대분류, 소분류, 설명, 돌프, 천사, 공통]
 *    - Date blank => use selected ym -> YYYY-MM-01
 *    - Amount blank => skip (keep existing)
 *    - Amount present => UPSERT (overwrite amount)
 * ========================= */
async function fetchActiveTemplates(){
  // 활성 템플릿만, 정렬순으로 가져오기
  const rows = await apiFetch("/rest/v1/entry_templates", {
    query:{
      select:"id,category,subcategory,detail,sort_order,is_active",
      ledger_id:`eq.${currentLedgerId}`,
      is_active:"eq.true",
      order:"sort_order.asc,id.asc",
      limit:"5000"
    }
  });
  return rows || [];
}

async function seedDefaultTemplatesIfEmpty(){
  // entry_templates가 비어 있으면, 기존 TEMPLATE_ROWS(하드코딩) 값을 최초 1회 삽입
  const existing = await apiFetch("/rest/v1/entry_templates", {
    query:{
      select:"id",
      ledger_id:`eq.${currentLedgerId}`,
      limit:"1"
    }
  });
  if(existing?.length) return;

  // ✅ 네가 기존에 쓰던 TEMPLATE_ROWS를 여기에서만 1회 seed 용으로 사용
  const DEFAULT_SEED = [
    ["식비","식재료",""],
    ["식비","외식",""],
    ["식비","배달",""],
    ["식비","중식",""],
    ["식비","카페/간식",""],
    ["소비 생활","쇼핑","의류, 잡화, 가방, 신발,화장품"],
    ["소비 생활","미용","미용실, 네일,미용시술"],
    ["소비 생활","구독","넷플릭스, 유튜브프리미엄, 음악스트리밍, 클라우드,멤버십"],
    ["소비 생활","생활편의","생필품,가전제품, 인테리어 소품,가구"],
    ["문화여가","여행","항공권, 숙박, 교통, 입장권"],
    ["문화여가","문화생활","영화, 공연, 전시, 도서, 게임"],
    ["문화여가","운동","헬스장, PT, 요가, 필라테스, 수영"],
    ["건강·관리","보험","생명보험, 건강보험, 자동차보험"],
    ["건강·관리","병원·약국","진료비, 약값, 건강검진"],
    ["건강·관리","건강식품","비타민, 단백질보충제, 건강보조제"],
    ["인간관계","회비","동호회,가족회비,동창"],
    ["인간관계","경조/선물","추의금, 조의금, 행사참석비 / 생일선물, 기념일선물"],
    ["인간관계","친목","친목회식"],
    ["예비/기타","기부","후원"],
    ["예비/기타","기타","비정기적 장비구매, 이벤트성 지출"],
    ["필수 생활","주거/통신","전세이자, 관리비, 수도세, 전기세, 가스비, 휴대폰요금, 인터넷, IPTV"],
    ["필수 생활","교통","대중교통(버스/지하철), 택시, 자가용유지(주유, 주차, 하이패스, 정비)"],
    ["필수 생활","공과금","공과금, 재활용비,지방세 등"],
    ["금융·저축","저축","정기적금, 비상금적금, CMA,주택청약"],
    ["금융·저축","투자","주식, 펀드, 코인, 부동산, ETF"],
    ["금융·저축","부채상환","카드값, 대출원리금, 이자"],
    ["수입","월급","월급"],
    ["수입","기타수입",""],
    ["수입","금융이자","상여금,"],
    ["수입","주식매도",""]
  ];

  const payload = DEFAULT_SEED.map((x, i)=>({
    ledger_id: currentLedgerId,
    category: x[0] || "",
    subcategory: x[1] || "",
    detail: x[2] || "",
    sort_order: i,
    is_active: true,
    created_by: session.user.id
  }));

  // 대량 insert
  await apiFetch("/rest/v1/entry_templates", {
    method:"POST",
    body: payload,
    preferReturn:false
  });
}

async function downloadMonthlyTemplate(){
  const ok = await waitForXLSX();
  if(!ok){
    setError("xlsx 라이브러리 로딩이 안 됐어. xlsx.full.min.js 파일이 index.html(이 파일)과 같은 폴더에 있는지 확인해줘.");
    return;
  }
  setError("");

  // ✅ 최초 1회 seed (비어있을 때만)
  await seedDefaultTemplatesIfEmpty();

  // ✅ 현재 DB 상태를 기반으로 템플릿 생성
  const templates = await fetchActiveTemplates();

  if(!templates.length){
    setError("활성화된 템플릿 항목이 없어. (카테고리 관리에서 추가하거나, 기본 템플릿을 다시 시드해야 해)");
    return;
  }

  const ym = ymFromInput() || new Date().toISOString().slice(0,7);
  const sheetRows = [];

  sheetRows.push(["사용법: '날짜'는 가능하면 YYYY-MM-DD로 입력. 금액 공란은 스킵(기존 값 유지)."]);
  sheetRows.push(["날짜","대분류","소분류","설명","돌프","천사","공통"]);

  for(const r of templates){
    sheetRows.push(["", r.category || "", r.subcategory || "", r.detail || "", "", "", ""]);
  }

  const ws = XLSX.utils.aoa_to_sheet(sheetRows);
  ws["!cols"] = [{wch:14},{wch:14},{wch:14},{wch:34},{wch:12},{wch:12},{wch:12}];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "기록");

  const fname = `record_template_${ym.replace("-","")}.xlsx`;
  XLSX.writeFile(wb, fname);
}


function detectHeaderRow(rows){
  // find a row that contains required headers
  const needed = ["날짜","대분류","소분류","설명","돌프","천사","공통"];
  for(let i=0;i<Math.min(rows.length, 20);i++){
    const row = rows[i].map(v => String(v||"").trim());
    const ok = needed.every(h => row.includes(h));
    if(ok) return i;
  }
  return -1;
}

function flowFromCategory(cat){
  const c = (cat||"").trim();
  if(c === "수입") return "income";
  if(c === "금융·저축" || c === "저축" || c === "금융/저축") return "saving";
  return "expense";
}

async function bulkUpload(){
  const ok = await waitForXLSX();
  if(!ok){
    setError("xlsx 라이브러리 로딩이 안 됐어. xlsx.full.min.js 파일이 index.html(이 파일)과 같은 폴더에 있는지 확인해줘.");
    return;
  }

  setError("");
  const file = byId("bulkFile").files?.[0];
  if(!file) throw new Error("엑셀 파일을 선택해줘");

  // 시트명은 이제 아무거나 OK. (날짜(A열=헤더 '날짜')만 제대로 있으면 됨)
  // 단, '7/3'처럼 연도 없는 날짜를 쓰는 경우를 대비해서 "기본 월"은 옵션으로 유지.
  const defaultYm = ymFromInput(); // optional
  if(!window.XLSX) throw new Error("xlsx 라이브러리 로딩이 안 됐어. (CDN 차단/오프라인)");

  setStatus("엑셀 읽는 중...");
  const data = await file.arrayBuffer();
  const wb = XLSX.read(data, { type:"array", cellDates:true });

  // ensure members exist
  const findMemberId = (name)=>{
    const list = membersCache.filter(m => m.name === name);
    if(!list.length) return null;
    if(name==="공통") return (list.find(m=>m.kind==="common") || list[0]).id;
    return list[0].id;
  };
  const dolId = findMemberId("돌프");
  const angId = findMemberId("천사");
  const comId = findMemberId("공통");
  if(!dolId || !angId || !comId){
    throw new Error("members에 '돌프/천사/공통'이 모두 있어야 해. (members 테이블에 추가/활성화 확인)");
  }

  const toUpsert = [];
  let scannedSheets = 0;
  let skippedSheets = 0;
  let skippedNoDate = 0;

  for(const sheetName of wb.SheetNames){
    const sheet = wb.Sheets[sheetName];
    if(!sheet) continue;

    const rows = XLSX.utils.sheet_to_json(sheet, { header:1, defval:"" });
    if(rows.length < 2) { skippedSheets++; continue; }

    const headerRow = detectHeaderRow(rows);
    if(headerRow < 0) { skippedSheets++; continue; } // 헤더 없는 시트는 무시

    const header = rows[headerRow].map(h => String(h).trim());
    const idx = (name)=> header.findIndex(h => h === name);

    const iDate = idx("날짜");
    const iCat = idx("대분류");
    const iSub = idx("소분류");
    const iDetail = idx("설명");
    const iDol = idx("돌프");
    const iAng = idx("천사");
    const iCom = idx("공통");

    const need = [iDate,iCat,iSub,iDetail,iDol,iAng,iCom];
    if(need.some(i => i < 0)) { skippedSheets++; continue; }

    scannedSheets++;

    for(let r=headerRow+1; r<rows.length; r++){
      const row = rows[r] || [];

      const dateCell = row[iDate];
      const hasDate = String(dateCell ?? "").trim() !== "";
      if(!hasDate){ skippedNoDate++; continue; } // ✅ 날짜가 없으면 업로드 안 함

      const entry_date = normalizeDate(dateCell, defaultYm);
      if(!entry_date){
        throw new Error(`날짜 형식을 읽을 수 없어: 시트 '${sheetName}' ${r+1}행. (권장: YYYY-MM-DD 또는 엑셀 날짜 형식)`);
      }

      const category = String(row[iCat] ?? "").trim();
      const subcategory = String(row[iSub] ?? "").trim();
      const detail = String(row[iDetail] ?? "").trim();

      // 완전 공란 라인 스킵
      const dolRaw = row[iDol];
      const angRaw = row[iAng];
      const comRaw = row[iCom];
      const hasAny = [dateCell,category,subcategory,detail,dolRaw,angRaw,comRaw].some(v => String(v??"").trim() !== "");
      if(!hasAny) continue;

      if(!category && !subcategory && !detail) continue;

      const flow_type = flowFromCategory(category);

      const pushIfAmount = (member_id, amtRaw)=>{
        const s = String(amtRaw ?? "").trim();
        if(s === "") return; // 공란 스킵
        const amount = Number(s.replaceAll(",",""));
        if(!Number.isFinite(amount) || amount < 0) return;

        toUpsert.push({
          ledger_id: currentLedgerId,
          entry_date,
          member_id,
          flow_type,
          amount,
          detail: detail || "",
          category: category || "",
          subcategory: subcategory || "",
          created_by: session.user.id
        });
      };

      pushIfAmount(dolId, dolRaw);
      pushIfAmount(angId, angRaw);
      pushIfAmount(comId, comRaw);
    }
  }

  if(!scannedSheets){
    throw new Error("업로드할 시트를 찾지 못했어. (헤더: 날짜/대분류/소분류/설명/돌프/천사/공통 이 있는 시트가 필요)");
  }

  if(!toUpsert.length){
    setStatus(`업로드할 유효 행이 없어(금액이 전부 공란이면 스킵됨). 확인한 시트 ${scannedSheets}개 / 무시한 시트 ${skippedSheets}개`);
    return;
  }

  // ✅ 같은 키가 요청 배열에 2번 들어가면 Postgres가 터져서, 업로드 전에 dedupe(마지막 값 우선)
  const onConflict = "ledger_id,entry_date,member_id,flow_type,category,subcategory,detail";
  const makeKey = (x)=> [x.ledger_id,x.entry_date,x.member_id,x.flow_type,x.category||"",x.subcategory||"",x.detail||""].join("|");
  const dedup = new Map();
  for(const row of toUpsert) dedup.set(makeKey(row), row);
  const toUpsertUnique = [...dedup.values()];

  setStatus(`업로드 중... (${toUpsertUnique.length}건 / 인식 시트 ${scannedSheets}개 · 무시 시트 ${skippedSheets}개 · 날짜없음 스킵 ${skippedNoDate}행)`);

  const chunk = 500;
  for(let i=0;i<toUpsertUnique.length;i+=chunk){
    const part = toUpsertUnique.slice(i, i+chunk);
    await apiFetch("/rest/v1/entries", {
      method:"POST",
      query:{ on_conflict: onConflict },
      body: part,
      preferReturn:false,
      extraHeaders:{ "Prefer":"resolution=merge-duplicates" }
    });
    await sleep(80);
  }

  setStatus("업로드 완료!");
  await refreshEverything();
}

function pad2(n){ return String(n).padStart(2,"0"); }

function normalizeDate(v, ym){
  // ✅ 1) Date 객체면 로컬 기준으로 YYYY-MM-DD 만들기 (타임존 보정 X)
  if(v instanceof Date && !isNaN(v.getTime())){
    const y = v.getFullYear();
    const m = pad2(v.getMonth() + 1);
    const d = pad2(v.getDate());
    return `${y}-${m}-${d}`;
  }

  // 2) Excel serial number
  if(typeof v === "number" && Number.isFinite(v)){
    const d = XLSX.SSF.parse_date_code(v);
    if(d) return `${d.y}-${pad2(d.m)}-${pad2(d.d)}`;
  }

  const s = String(v ?? "").trim();
  if(!s) return "";

  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

  if(/^\d{2}-\d{2}$/.test(s)){
    if(!ym) return "";
    return `${ym.split("-")[0]}-${s}`;
  }

  if(/^\d{1,2}\/\d{1,2}$/.test(s)){
    if(!ym) return "";
    const [m,d] = s.split("/").map(x=>pad2(x));
    return `${ym.split("-")[0]}-${m}-${d}`;
  }

  const m1 = s.match(/^(\d{4})[\.\/-](\d{1,2})[\.\/-](\d{1,2})$/);
  if(m1){
    const y = m1[1];
    const m = pad2(m1[2]);
    const d = pad2(m1[3]);
    return `${y}-${m}-${d}`;
  }

  return "";
}


/** =========================
 * 7) Dashboard (instant multi-filter buttons)
 * ========================= */
let chartCategory = null;
let chartTop10 = null;
let chartMonthly = null;
let chartFlowShare = null;
let chartMonthlyStack = null;

let dashRowsCache = [];
const dashState = {
  members: new Set(),
  years: new Set(),
  months: new Set(),
  categories: new Set(),
  subcategories: new Set(),
};

function clearDashState(){
  dashState.members.clear();
  dashState.years.clear();
  dashState.months.clear();
  dashState.categories.clear();
  dashState.subcategories.clear();
}

function isAllSelected(set){ return set.size === 0; }

function buildDashPredicate(){
  const mem = dashState.members;
  const yrs = dashState.years;
  const mos = dashState.months;
  const cats = dashState.categories;
  const subs = dashState.subcategories;

  return (r)=>{
    const d = r.entry_date;
    const y = d.slice(0,4);
    const m = d.slice(5,7);

    if(mem.size && !mem.has(r.member_id)) return false;
    if(yrs.size && !yrs.has(y)) return false;
    if(mos.size && !mos.has(m)) return false;
    if(cats.size && !cats.has((r.category||""))) return false;
    if(subs.size && !subs.has((r.subcategory||""))) return false;
    return true;
  };
}

function mkBtn(label, { active=false, onClick, title="" } = {}){
  const b = document.createElement("button");
  b.type = "button";
  b.className = "chip px-3 py-2 text-xs";
  b.dataset.active = active ? "true" : "false";
  b.textContent = label;
  if(title) b.title = title;
  b.addEventListener("click", onClick);
  return b;
}

function renderDashButtons(){
  // member buttons (from membersCache)
  const wrapM = byId("dashBtnsMember");
  wrapM.innerHTML = "";
  // "전체" means no filter => empty set
  wrapM.appendChild(mkBtn("전체", {
    active: dashState.members.size === 0,
    onClick: ()=>{ dashState.members.clear(); refreshDashboardFromCache(); renderDashButtons(); },
    title:"구분 전체"
  }));
  for(const m of membersCache){
    const active = dashState.members.has(m.id);
    wrapM.appendChild(mkBtn(m.name, {
      active,
      onClick: ()=>{
        if(dashState.members.size===0){ /* from all -> start selecting */ }
        if(active) dashState.members.delete(m.id); else dashState.members.add(m.id);
        // if all removed => treat as 전체
        if(dashState.members.size===0){ /* ok */ }
        refreshDashboardFromCache(); renderDashButtons();
      }
    }));
  }

  // years from data
  const years = [...new Set(dashRowsCache.map(r=>r.entry_date.slice(0,4)))].sort();
  const wrapY = byId("dashBtnsYear");
  wrapY.innerHTML = "";
  wrapY.appendChild(mkBtn("전체", {
    active: dashState.years.size === 0,
    onClick: ()=>{ dashState.years.clear(); refreshDashboardFromCache(); renderDashButtons(); },
  }));
  for(const y of years){
    const active = dashState.years.has(y);
    wrapY.appendChild(mkBtn(`${y}년`, {
      active,
      onClick: ()=>{
        if(active) dashState.years.delete(y); else dashState.years.add(y);
        refreshDashboardFromCache(); renderDashButtons();
      }
    }));
  }

  // months fixed
  const wrapMo = byId("dashBtnsMonth");
  wrapMo.innerHTML = "";
  wrapMo.appendChild(mkBtn("전체", {
    active: dashState.months.size === 0,
    onClick: ()=>{ dashState.months.clear(); refreshDashboardFromCache(); renderDashButtons(); },
  }));
  for(let i=1;i<=12;i++){
    const mm = String(i).padStart(2,"0");
    const active = dashState.months.has(mm);
    wrapMo.appendChild(mkBtn(`${i}월`, {
      active,
      onClick: ()=>{
        if(active) dashState.months.delete(mm); else dashState.months.add(mm);
        refreshDashboardFromCache(); renderDashButtons();
      }
    }));
  }

  // categories/subcategories from data
  const cats = [...new Set(dashRowsCache.map(r=>(r.category||"").trim()))].filter(Boolean).sort();
  const wrapC = byId("dashBtnsCategory");
  wrapC.innerHTML = "";
  wrapC.appendChild(mkBtn("전체", {
    active: dashState.categories.size === 0,
    onClick: ()=>{ dashState.categories.clear(); refreshDashboardFromCache(); renderDashButtons(); },
  }));
  for(const c of cats){
    const active = dashState.categories.has(c);
    wrapC.appendChild(mkBtn(c, {
      active,
      onClick: ()=>{
        if(active) dashState.categories.delete(c); else dashState.categories.add(c);
        refreshDashboardFromCache(); renderDashButtons();
      }
    }));
  }

  const subs = [...new Set(dashRowsCache.map(r=>(r.subcategory||"").trim()))].filter(Boolean).sort();
  const wrapS = byId("dashBtnsSubcategory");
  wrapS.innerHTML = "";
  wrapS.appendChild(mkBtn("전체", {
    active: dashState.subcategories.size === 0,
    onClick: ()=>{ dashState.subcategories.clear(); refreshDashboardFromCache(); renderDashButtons(); },
  }));
  for(const s of subs){
    const active = dashState.subcategories.has(s);
    wrapS.appendChild(mkBtn(s, {
      active,
      onClick: ()=>{
        if(active) dashState.subcategories.delete(s); else dashState.subcategories.add(s);
        refreshDashboardFromCache(); renderDashButtons();
      }
    }));
  }

  // hint text
  const parts = [];
  if(dashState.members.size) parts.push(`구분 ${dashState.members.size}개`);
  if(dashState.years.size) parts.push(`연도 ${dashState.years.size}개`);
  if(dashState.months.size) parts.push(`월 ${dashState.months.size}개`);
  if(dashState.categories.size) parts.push(`대분류 ${dashState.categories.size}개`);
  if(dashState.subcategories.size) parts.push(`소분류 ${dashState.subcategories.size}개`);
  byId("dashSelectionHint").textContent = parts.length ? `선택됨: ${parts.join(" · ")}` : "* 버튼을 누르면 즉시 반영돼. (중복 선택은 합산)";
}

async function fetchAllEntriesForDash(){
  const url = new URL(SUPABASE_URL + "/rest/v1/entries");
  url.searchParams.set("select", "entry_date,flow_type,amount,category,subcategory,detail,member_id");
  url.searchParams.set("ledger_id", `eq.${currentLedgerId}`);
  url.searchParams.set("order", "entry_date.asc");
  url.searchParams.set("limit", "8000");

  const headers = { "apikey": SUPABASE_KEY, "Authorization": "Bearer " + session.access_token };
  const res = await fetch(url.toString(), { headers });
  const data = await res.json();
  if(!res.ok) throw new Error(data?.message || JSON.stringify(data));
  return data || [];
}

function computeMonthlyBuckets(rows, pred){
  const map = new Map();
  for(const r of rows){
    if(!pred(r)) continue;
    const mk = r.entry_date.slice(0,7);
    const o = map.get(mk) || { expense:0, income:0, saving:0 };
    o[r.flow_type] = (o[r.flow_type] || 0) + Number(r.amount||0);
    map.set(mk, o);
  }
  const keys = [...map.keys()].sort();
  return { keys, map };
}

function computeKpis(rows, pred){
  let expense=0,income=0,saving=0;
  const monthsSet = new Set();
  for(const r of rows){
    if(!pred(r)) continue;
    monthsSet.add(r.entry_date.slice(0,7));
    if(r.flow_type==="expense") expense += Number(r.amount||0);
    else if(r.flow_type==="income") income += Number(r.amount||0);
    else if(r.flow_type==="saving") saving += Number(r.amount||0);
  }
  const months = Math.max(1, monthsSet.size);
  const net = income - expense - saving;
  const savingRate = income > 0 ? Math.round((saving/income)*100) : 0;
  return {
    expense, income, saving, net, savingRate,
    expenseAvg: Math.round(expense/months),
    incomeAvg: Math.round(income/months),
    savingAvg: Math.round(saving/months),
  };
}

function computeCategoryExpense(rows, pred){
  const map = new Map();
  for(const r of rows){
    if(!pred(r)) continue;
    if(r.flow_type !== "expense") continue;
    const k = (r.category || "미분류");
    map.set(k, (map.get(k)||0) + Number(r.amount||0));
  }
  return [...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,12);
}

function computeTop10(rows, pred){
  const map = new Map();
  for(const r of rows){
    if(!pred(r)) continue;
    if(r.flow_type !== "expense") continue;
    const k = (r.subcategory || "미분류") + (r.detail ? ` · ${r.detail}` : "");
    map.set(k, (map.get(k)||0) + Number(r.amount||0));
  }
  return [...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
}

function computeFlowShare(rows, pred){
  let e=0,i=0,s=0;
  for(const r of rows){
    if(!pred(r)) continue;
    if(r.flow_type==="expense") e += Number(r.amount||0);
    else if(r.flow_type==="income") i += Number(r.amount||0);
    else if(r.flow_type==="saving") s += Number(r.amount||0);
  }
  return { e,i,s };
}

function refreshDashboardFromCache(){
  const pred = buildDashPredicate();

  const k = computeKpis(dashRowsCache, pred);
  byId("kpiExpense").textContent = fmt(k.expense);
  byId("kpiIncome").textContent = fmt(k.income);
  byId("kpiSaving").textContent = fmt(k.saving);
  byId("kpiExpenseAvg").textContent = fmt(k.expenseAvg);
  byId("kpiIncomeAvg").textContent = fmt(k.incomeAvg);
  byId("kpiSavingAvg").textContent = fmt(k.savingAvg);

  // Category
  const catArr = computeCategoryExpense(dashRowsCache, pred);
  const catLabels = catArr.map(x=>x[0]);
  const catVals = catArr.map(x=>x[1]);
  if(chartCategory) chartCategory.destroy();
  chartCategory = new Chart(byId("chartCategory"), {
    type:"bar",
    data:{ labels: catLabels, datasets:[{ label:"지출", data: catVals }] },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(ctx)=> `${fmt(ctx.raw)} 원` } } },
      scales:{ x:{ ticks:{ color:"rgba(0,0,0,.7)" }, grid:{ color:"rgba(0,0,0,.06)" } },
               y:{ ticks:{ color:"rgba(0,0,0,.7)", callback:(v)=> fmt(v) }, grid:{ color:"rgba(0,0,0,.06)" } } }
    }
  });

  // Top10
  const topArr = computeTop10(dashRowsCache, pred);
  const topLabels = topArr.map(x=>x[0]).reverse();
  const topVals = topArr.map(x=>x[1]).reverse();
  if(chartTop10) chartTop10.destroy();
  chartTop10 = new Chart(byId("chartTop10"), {
    type:"bar",
    data:{ labels: topLabels, datasets:[{ label:"지출", data: topVals }] },
    options:{
      indexAxis:"y",
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(ctx)=> `${fmt(ctx.raw)} 원` } } },
      scales:{ x:{ ticks:{ color:"rgba(0,0,0,.7)", callback:(v)=> fmt(v) }, grid:{ color:"rgba(0,0,0,.06)" } },
               y:{ ticks:{ color:"rgba(0,0,0,.7)" }, grid:{ color:"rgba(0,0,0,.06)" } } }
    }
  });

  // Monthly line (3 series)
  const { keys, map } = computeMonthlyBuckets(dashRowsCache, pred);
  const exp = keys.map(k=> (map.get(k)?.expense)||0);
  const inc = keys.map(k=> (map.get(k)?.income)||0);
  const sav = keys.map(k=> (map.get(k)?.saving)||0);
  if(chartMonthly) chartMonthly.destroy();
  chartMonthly = new Chart(byId("chartMonthly"), {
    type:"line",
    data:{ labels: keys, datasets:[
      { label:"지출", data: exp, tension:.25 },
      { label:"수입", data: inc, tension:.25 },
      { label:"저축", data: sav, tension:.25 },
    ]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ labels:{ color:"rgba(0,0,0,.7)" } }, tooltip:{ callbacks:{ label:(ctx)=> `${ctx.dataset.label}: ${fmt(ctx.raw)} 원` } } },
      scales:{ x:{ ticks:{ color:"rgba(0,0,0,.7)" }, grid:{ color:"rgba(0,0,0,.06)" } },
               y:{ ticks:{ color:"rgba(0,0,0,.7)", callback:(v)=> fmt(v) }, grid:{ color:"rgba(0,0,0,.06)" } } }
    }
  });

  // Flow share doughnut
  const share = computeFlowShare(dashRowsCache, pred);
  if(chartFlowShare) chartFlowShare.destroy();
  chartFlowShare = new Chart(byId("chartFlowShare"), {
    type:"doughnut",
    data:{ labels:["지출","수입","저축"], datasets:[{ data:[share.e, share.i, share.s] }] },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{ position:"bottom", labels:{ color:"rgba(0,0,0,.7)" } },
        tooltip:{ callbacks:{ label:(ctx)=> `${ctx.label}: ${fmt(ctx.raw)} 원` } }
      }
    }
  });

  // Monthly stacked bar
  if(chartMonthlyStack) chartMonthlyStack.destroy();
  chartMonthlyStack = new Chart(byId("chartMonthlyStack"), {
    type:"bar",
    data:{ labels: keys, datasets:[
      { label:"지출", data: exp, stack:"sum" },
      { label:"수입", data: inc, stack:"sum" },
      { label:"저축", data: sav, stack:"sum" },
    ]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ labels:{ color:"rgba(0,0,0,.7)" } }, tooltip:{ callbacks:{ label:(ctx)=> `${ctx.dataset.label}: ${fmt(ctx.raw)} 원` } } },
      scales:{
        x:{ stacked:true, ticks:{ color:"rgba(0,0,0,.7)" }, grid:{ color:"rgba(0,0,0,.06)" } },
        y:{ stacked:true, ticks:{ color:"rgba(0,0,0,.7)", callback:(v)=> fmt(v) }, grid:{ color:"rgba(0,0,0,.06)" } }
      }
    }
  });
}

async function refreshDashboard(){
  dashRowsCache = await fetchAllEntriesForDash();
  renderDashButtons();
  refreshDashboardFromCache();
}

/** =========================
 * 8) Tabs
 * ========================= */
function switchTab(tab){
  for(const b of document.querySelectorAll(".tab-btn")){
    const on = b.dataset.tab === tab;
    b.dataset.active = on ? "true" : "false";
  }
  for(const sec of ["dash","edit","bulk","all"]){
    byId(`tab-${sec}`).classList.toggle("hidden", sec !== tab);
  }
}

document.addEventListener("click", (e)=>{
  const btn = e.target.closest(".tab-btn");
  if(!btn) return;
  switchTab(btn.dataset.tab);
});

/** =========================
 * 9) Refresh all
 * ========================= */
async function refreshEverything(){
  await loadMembers();
  await loadEntries();
  await refreshDashboard();
  await refreshMatrix();
}

async function refreshUI(){
  const authed = !!(session?.access_token && session?.user?.id);

  byId("authBox").classList.toggle("hidden", authed);
  byId("appWrap").classList.toggle("hidden", !authed);
  byId("btnLogout").classList.toggle("hidden", !authed);
  byId("whoPill").classList.toggle("hidden", !authed);

  if(!authed){
    byId("ledgerName").textContent = "";
    byId("whoPill").textContent = "";
    setStatus("로그인 상태가 아니야.");
    return;
  }

  byId("whoPill").textContent = `로그인: ${session.user.email}`;

  // defaults
  if(!byId("filterFrom").value) byId("filterFrom").value = DEFAULT_START_DATE;
  if(!byId("filterTo").value) byId("filterTo").value = todayISO();
  if(!byId("entryDate").value) byId("entryDate").value = todayISO();
  if(!byId("bulkYm").value) byId("bulkYm").value = new Date().toISOString().slice(0,7);

  setStatus("로그인됨. 장부 확인 중...");
  await ensureDefaultLedger();
  setStatus("데이터 로딩 중...");
  await refreshEverything();
  setStatus("준비 완료!");
}

/** =========================
 * 10) Boot
 * ========================= */
window.addEventListener("DOMContentLoaded", async ()=>{
  try{
    const s = loadSession();
    if(s) session = s;

    // if token exists but user missing, fetch user
    if(session?.access_token && !session.user){
      try{
        const user = await fetchUser();
        saveSession({ ...session, user });
      }catch(e){
        // expired token etc
        saveSession(null);
      }
    }

    // bind auth
    byId("btnLogin").addEventListener("click", async ()=>{
      try{
        setError("");
        setStatus("로그인 중...");
        const email = (byId("email").value||"").trim();
        const pw = (byId("password").value||"").trim();
        if(!email || !pw) throw new Error("이메일/비밀번호를 입력해줘");
        await loginWithPassword(email, pw);
        await refreshUI();
      }catch(e){
        setError(e?.message || String(e));
        setStatus("");
      }
    });

    byId("btnSignUp").addEventListener("click", async ()=>{
      try{
        setError("");
        setStatus("회원가입 중...");
        const email = (byId("email").value||"").trim();
        const pw = (byId("password").value||"").trim();
        if(!email || !pw) throw new Error("이메일/비밀번호를 입력해줘");
        await signUp(email, pw);
        await refreshUI();
      }catch(e){
        setError(e?.message || String(e));
        setStatus("");
      }
    });

    byId("btnLogout").addEventListener("click", async ()=>{
      await logout();
      await refreshUI();
    });

    // edit form
    byId("entryForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      try{
        setError("");
        setStatus("저장 중...");
        await upsertEntryFromForm();
        await refreshEverything();
        setStatus("저장 완료!");
      }catch(err){
        setError(err?.message || String(err));
        setStatus("");
      }
    });
    byId("btnCancelEdit").addEventListener("click", ()=> cancelEdit());

    // list filters
    byId("btnReload").addEventListener("click", async ()=>{ try{ setError(""); await loadEntries(); }catch(e){ setError(e.message); } });
    byId("btnApplyFilter").addEventListener("click", async ()=>{ try{ setError(""); await loadEntries(); }catch(e){ setError(e.message); } });

    // dashboard actions (즉시 반영)
    byId("btnDashClear").addEventListener("click", ()=>{
      clearDashState();
      refreshDashboardFromCache();
      renderDashButtons();
    });

    byId("btnDashRefetch").addEventListener("click", async ()=>{
      try{
        setError("");
        setStatus("대시보드 데이터 새로고침...");
        await refreshDashboard(); // refetch + render
        setStatus("준비 완료!");
      }catch(e){
        setError(e?.message || String(e));
        setStatus("");
      }
    });

// bulk
    byId("btnDownloadTemplate").addEventListener("click", ()=>{
      try{ downloadMonthlyTemplate(); }catch(e){ setError(e.message); }
    });
    byId("btnBulkUpload").addEventListener("click", async ()=>{
      try{
        setError("");
        await bulkUpload();
      }catch(e){
        setError(e?.message || String(e));
      }
    });

    // matrix tab (월별 매트릭스)
    byId("btnMxReload").addEventListener("click", async ()=>{
      try{ setError(""); await refreshMatrix(); }catch(e){ setError(e.message); setStatus(""); }
    });
    byId("mxYear").addEventListener("change", async ()=>{ try{ setError(""); await refreshMatrix(); }catch(e){ setError(e.message); } });
    byId("mxFlow").addEventListener("change", async ()=>{ try{ setError(""); await refreshMatrix(); }catch(e){ setError(e.message); } });
byId("btnRenameApply").addEventListener("click", async ()=>{
  try{
    setError("");
    await renameCategoryBatch();
  }catch(e){
    setError(e?.message || String(e));
    setStatus("");
  }
});

byId("btnRenameClear").addEventListener("click", ()=>{
  byId("renameOldCategory").value = "";
  byId("renameOldSubcategory").value = "";
  byId("renameOldDetail").value = "";
  byId("renameNewCategory").value = "";
  byId("renameNewSubcategory").value = "";
  byId("renameNewDetail").value = "";
  byId("renameHint").textContent = "";
});

    // sync across tabs
    window.addEventListener("storage", async (e)=>{
      if(e.key !== SS_KEY) return;
      session = loadSession();
      try{
        if(session?.access_token && !session.user){
          const user = await fetchUser();
          saveSession({ ...session, user });
        }
      }catch(_){}
      await refreshUI();
    });

    await refreshUI();
  }catch(e){
    console.error(e);
    setError(e?.message || String(e));
  }
});
</script>
</body>
</html>
