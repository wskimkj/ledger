<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>가계부 (Supabase · No SDK)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
    h1 { margin: 0 0 8px; }
    .muted { color:#666; font-size:12px; }
    .card { border:1px solid #e7e7e7; border-radius:16px; padding:14px; margin:12px 0; }
    input, select, button { padding:10px; border:1px solid #ccc; border-radius:12px; font-size:14px; }
    button { cursor:pointer; background:#f6f6f6; }
    button.primary { background:#111; color:#fff; border-color:#111; }
    button.danger { background:#fff1f1; border-color:#ffb3b3; }
    .toolbar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between; }
    .row { display:grid; grid-template-columns: repeat(6, 1fr); gap:8px; align-items:end; }
    .row > div { display:flex; flex-direction:column; gap:6px; }
    .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .hidden { display:none !important; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #eee; padding:10px; text-align:left; }
    td.right { text-align:right; }
    .pill { display:inline-flex; padding:6px 10px; border:1px solid #e5e5e5; border-radius:999px; font-size:13px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    @media (max-width: 900px){ .row{ grid-template-columns: repeat(2,1fr);} .grid2{grid-template-columns:1fr;} }
  </style>

  <script>
    // ✅ 너 프로젝트 값
    const SUPABASE_URL = "https://cqxpmfxwgrpdtxomxfiz.supabase.co";
    const SUPABASE_KEY = "sb_publishable_srN_e_EFhBbMEnPHSyu2Eg_03Mw37jS";

    const DEFAULT_LEDGER_NAME = "우리집";
    const DEFAULT_START_DATE = "2026-01-01";

    // 세션 저장 키 (localStorage)
    const SS_KEY = "ledger_session_v1";
    let session = null; // { access_token, refresh_token, user }

    let currentLedgerId = null;

    const byId = (id) => document.getElementById(id);
    const fmt = (n) => Number(n||0).toLocaleString("ko-KR");
    const todayISO = () => {
      const d = new Date();
      const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
      return z.toISOString().slice(0,10);
    };

    function setStatus(msg){ byId("status").textContent = msg || ""; }
    function setError(msg){ byId("error").textContent = msg || ""; }
    function show(el, yes){ el.classList.toggle("hidden", !yes); }

    function saveSession(s){
      session = s;
      if (s) localStorage.setItem(SS_KEY, JSON.stringify(s));
      else localStorage.removeItem(SS_KEY);
    }
    function loadSession(){
      const raw = localStorage.getItem(SS_KEY);
      if(!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    async function apiFetch(path, { method="GET", query=null, body=null, auth=true, preferReturn=true } = {}){
      const url = new URL(SUPABASE_URL + path);
      if(query){
        for(const [k,v] of Object.entries(query)){
          if(v === undefined || v === null) continue;
          url.searchParams.set(k, v);
        }
      }

      const headers = {
        "apikey": SUPABASE_KEY,
        "Content-Type": "application/json",
      };
      if(auth && session?.access_token){
        headers["Authorization"] = "Bearer " + session.access_token;
      }
      if(preferReturn && (method==="POST" || method==="PATCH")){
        headers["Prefer"] = "return=representation";
      }

      const res = await fetch(url.toString(), {
        method,
        headers,
        body: body ? JSON.stringify(body) : undefined
      });

      let data = null;
      const text = await res.text();
      try { data = text ? JSON.parse(text) : null; } catch { data = text || null; }

      if(!res.ok){
        const msg = typeof data === "object" && data ? (data.message || data.error_description || JSON.stringify(data)) : String(data);
        throw new Error(msg || `HTTP ${res.status}`);
      }
      return data;
    }

    // ---------- Auth (No SDK) ----------
    async function sendMagicLink(email){
      const redirectTo = window.location.origin + window.location.pathname; // 현재 페이지로
      await apiFetch("/auth/v1/otp", {
        method: "POST",
        auth: false,
        body: {
          email,
          create_user: true,
          options: { emailRedirectTo: redirectTo }
        },
        preferReturn: false
      });
    }

    function parseTokensFromUrl(){
      const hash = window.location.hash || "";
      if(!hash.startsWith("#")) return null;
      const params = new URLSearchParams(hash.slice(1));
      const access_token = params.get("access_token");
      const refresh_token = params.get("refresh_token");
      if(!access_token) return null;
      return { access_token, refresh_token };
    }

    async function fetchUser(){
      return await apiFetch("/auth/v1/user", { method:"GET", auth:true, preferReturn:false });
    }

    async function logout(){
      saveSession(null);
    }

    // ---------- App logic ----------
    async function refreshUI(){
      const authed = !!(session?.access_token);

      show(byId("authCard"), !authed);
      show(byId("appCard"), authed);
      show(byId("setupCard"), authed);

      byId("who").textContent = authed ? `로그인: ${session.user?.email || ""}` : "";
      byId("ledgerName").textContent = "";

      if(!authed){
        setStatus("로그인 상태가 아니야.");
        return;
      }

      setStatus("로그인됨. 장부 확인 중...");

      if(!byId("filterFrom").value) byId("filterFrom").value = DEFAULT_START_DATE;
      if(!byId("filterTo").value) byId("filterTo").value = todayISO();
      if(!byId("entryDate").value) byId("entryDate").value = todayISO();

      await ensureDefaultLedger();
      await loadMembers();
      await loadEntries();
      await refreshSummary();

      setStatus("준비 완료!");
    }

    async function ensureDefaultLedger(){
      const ledgers = await apiFetch("/rest/v1/ledgers", {
        query: { select:"id,name,created_at", order:"created_at.asc" }
      });

      if(ledgers?.length){
        currentLedgerId = ledgers[0].id;
        byId("ledgerName").textContent = ledgers[0].name;
        return;
      }

      const createdArr = await apiFetch("/rest/v1/ledgers", {
        method:"POST",
        body: { name: DEFAULT_LEDGER_NAME, created_by: session.user.id }
      });
      const created = createdArr?.[0];
      if(!created?.id) throw new Error("장부 생성 실패");

      currentLedgerId = created.id;
      byId("ledgerName").textContent = DEFAULT_LEDGER_NAME;

      await apiFetch("/rest/v1/ledger_members", {
        method:"POST",
        body: { ledger_id: currentLedgerId, user_id: session.user.id, role:"owner" }
      });

      await apiFetch("/rest/v1/members", {
        method:"POST",
        body: { ledger_id: currentLedgerId, name:"공통", kind:"common" }
      });
    }

    async function loadMembers(){
      const members = await apiFetch("/rest/v1/members", {
        query: {
          select:"id,name,kind,is_active",
          ledger_id:`eq.${currentLedgerId}`,
          is_active:"eq.true",
          order:"kind.desc,name.asc"
        }
      });

      const sel = byId("memberSelect");
      sel.innerHTML = "";
      for(const m of members){
        const opt = document.createElement("option");
        opt.value = m.id;
        opt.textContent = `${m.name}${m.kind==="common" ? " (공통)" : ""}`;
        sel.appendChild(opt);
      }

      const filterMember = byId("filterMember");
      const prev = filterMember.value || "all";
      filterMember.innerHTML = `<option value="all">전체 멤버</option>`;
      for(const m of members){
        const opt = document.createElement("option");
        opt.value = m.id;
        opt.textContent = `${m.name}${m.kind==="common" ? " (공통)" : ""}`;
        filterMember.appendChild(opt);
      }
      filterMember.value = prev;

      const list = byId("memberList");
      list.innerHTML = "";
      for(const m of members){
        const row = document.createElement("div");
        row.className = "toolbar";
        row.innerHTML = `
          <span class="pill">${m.name} <span class="muted">${m.kind}</span></span>
          <button class="danger">비활성화</button>
        `;
        row.querySelector("button").addEventListener("click", async () => {
          if(!confirm("비활성화 할까?")) return;
          await apiFetch("/rest/v1/members", {
            method:"PATCH",
            query: { id:`eq.${m.id}` },
            body: { is_active:false }
          });
          await loadMembers();
        });
        list.appendChild(row);
      }
    }

    async function addMember(name, kind){
      await apiFetch("/rest/v1/members", {
        method:"POST",
        body: { ledger_id: currentLedgerId, name, kind }
      });
      await loadMembers();
    }

    function getFilters(){
      return {
        from: byId("filterFrom").value || DEFAULT_START_DATE,
        to: byId("filterTo").value || todayISO(),
        flow: byId("filterFlow").value,
        memberId: byId("filterMember").value,
        q: (byId("filterQ").value || "").trim(),
      };
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function loadEntries(){
      const f = getFilters();

      const url = new URL(SUPABASE_URL + "/rest/v1/entries");
      url.searchParams.set("select", "id,entry_date,flow_type,amount,detail,subcategory,category,memo,member_id");
      url.searchParams.set("ledger_id", `eq.${currentLedgerId}`);
      url.searchParams.set("entry_date", `gte.${f.from}`);
      url.searchParams.append("entry_date", `lte.${f.to}`);
      if(f.flow !== "all") url.searchParams.set("flow_type", `eq.${f.flow}`);
      if(f.memberId !== "all") url.searchParams.set("member_id", `eq.${f.memberId}`);
      url.searchParams.set("order", "entry_date.desc,created_at.desc");

      const headers = {
        "apikey": SUPABASE_KEY,
        "Authorization": "Bearer " + session.access_token,
      };

      const res = await fetch(url.toString(), { headers });
      const data = await res.json();
      if(!res.ok) throw new Error(data?.message || JSON.stringify(data));

      const rows = (f.q)
        ? data.filter(r => (r.detail||"").includes(f.q) || (r.memo||"").includes(f.q))
        : data;

      renderEntries(rows);
      byId("count").textContent = `${rows.length}건`;
    }

    function renderEntries(rows){
      const tbody = byId("entriesTbody");
      tbody.innerHTML = "";
      for(const r of rows){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${r.entry_date}</td>
          <td class="mono">${r.flow_type}</td>
          <td>${escapeHtml(r.detail || "")}</td>
          <td>${escapeHtml(r.category || "")} <span class="muted">${escapeHtml(r.subcategory || "")}</span></td>
          <td class="right mono">${fmt(r.amount)}</td>
          <td>${escapeHtml(r.memo || "")}</td>
          <td style="white-space:nowrap;">
            <button data-act="edit">수정</button>
            <button class="danger" data-act="del">삭제</button>
          </td>
        `;
        tr.querySelector('[data-act="edit"]').addEventListener("click", () => startEdit(r));
        tr.querySelector('[data-act="del"]').addEventListener("click", async () => {
          if(!confirm("삭제할까?")) return;
          await apiFetch("/rest/v1/entries", {
            method:"DELETE",
            query: { id:`eq.${r.id}` },
            preferReturn:false
          });
          await loadEntries();
          await refreshSummary();
        });
        tbody.appendChild(tr);
      }
    }

    function startEdit(r){
      byId("editId").value = r.id;
      byId("entryDate").value = r.entry_date;
      byId("flowType").value = r.flow_type;
      byId("amount").value = r.amount;
      byId("detail").value = r.detail || "";
      byId("memo").value = r.memo || "";
      byId("memberSelect").value = r.member_id;
      byId("btnSubmit").textContent = "수정 저장";
      show(byId("btnCancelEdit"), true);
    }

    function cancelEdit(){
      byId("editId").value = "";
      byId("btnSubmit").textContent = "추가";
      show(byId("btnCancelEdit"), false);
    }

    async function upsertEntry(){
      const id = byId("editId").value || null;
      const entry_date = byId("entryDate").value;
      const member_id = byId("memberSelect").value;
      const flow_type = byId("flowType").value;
      const amount = Number(byId("amount").value || 0);
      const detail = (byId("detail").value || "").trim();
      const memo = (byId("memo").value || "").trim();

      if(!entry_date) throw new Error("날짜를 선택해줘");
      if(!member_id) throw new Error("멤버를 선택해줘");
      if(!detail) throw new Error("상세항목을 입력해줘");
      if(!Number.isFinite(amount) || amount < 0) throw new Error("금액을 확인해줘");

      const payload = {
        ledger_id: currentLedgerId,
        entry_date,
        member_id,
        flow_type,
        amount,
        detail,
        memo,
        created_by: session.user.id
      };

      if(!id){
        await apiFetch("/rest/v1/entries", { method:"POST", body: payload });
      }else{
        await apiFetch("/rest/v1/entries", {
          method:"PATCH",
          query: { id:`eq.${id}` },
          body: payload
        });
      }

      byId("entryForm").reset();
      byId("entryDate").value = todayISO();
      cancelEdit();

      await loadEntries();
      await refreshSummary();
    }
// ✅ 앱 시작 (이 블록은 딱 1개만 있어야 함)
window.addEventListener("DOMContentLoaded", async () => {
  try {
    // 1) 매직링크로 돌아온 경우 토큰 파싱
    const tokens = parseTokensFromUrl();
    if (tokens) {
      saveSession({ ...tokens, user: null });
      // 토큰이 URL에 남지 않게 해시 제거
      history.replaceState({}, document.title, window.location.pathname + window.location.search);
    } else {
      // 기존 세션 로드
      const s = loadSession();
      if (s) session = s;
    }

    // 2) 토큰이 있으면 user 가져오기
    if (session?.access_token && !session.user) {
      const user = await fetchUser();
      saveSession({ ...session, user });
    }

    // ✅ 다른 탭(메일 탭)에서 로그인되면 이 탭도 자동 갱신
    window.addEventListener("storage", async (e) => {
      if (e.key !== SS_KEY) return;

      session = loadSession();

      if (session?.access_token && !session.user) {
        try {
          const user = await fetchUser();
          saveSession({ ...session, user });
        } catch (err) {
          setError(err?.message || String(err));
        }
      }

      try {
        await refreshUI();
      } catch (err) {
        setError(err?.message || String(err));
      }
    });

    // 이벤트 바인딩 (전부 DOMContentLoaded 안에서만!)
    byId("btnSendLink").addEventListener("click", async () => {
      const email = (byId("email").value || "").trim();
      if (!email) return setError("이메일을 입력해줘");
      setError("");
      setStatus("메일 보내는 중...");
      await sendMagicLink(email);
      setStatus("로그인 링크를 이메일로 보냈어. 메일에서 링크를 눌러줘!");
    });

    byId("btnLogout").addEventListener("click", async () => {
      await logout();
      await refreshUI();
    });

    byId("entryForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      setError("");
      await upsertEntry();
    });

    byId("btnCancelEdit").addEventListener("click", () => cancelEdit());
    byId("btnReload").addEventListener("click", async () => {
      await loadEntries();
      await refreshSummary();
    });
    byId("btnApplyFilter").addEventListener("click", async () => {
      await loadEntries();
      await refreshSummary();
    });

    byId("btnAddMember").addEventListener("click", async () => {
      const name = (byId("newMemberName").value || "").trim();
      const kind = byId("newMemberKind").value;
      if (!name) return setError("멤버 이름을 입력해줘");
      await addMember(name, kind);
      byId("newMemberName").value = "";
    });

    await refreshUI();
  } catch (e) {
    console.error(e);
    setError(e?.message || String(e));
  }
});

    
</head>

<body>
  <h1>가계부</h1>
  <div class="muted">Supabase 동기화 · 지출/수입/저축(saving) 분리 집계 · (SDK 없이 fetch로만 동작)</div>

  <div class="card">
    <div class="toolbar">
      <div id="who" class="muted"></div>
      <button id="btnLogout">로그아웃</button>
    </div>
    <div class="muted">현재 장부: <span id="ledgerName" class="mono"></span></div>
    <div id="status" class="muted"></div>
    <div id="error" class="muted" style="color:#b00020;"></div>
  </div>

  <!-- 로그인 -->
  <div id="authCard" class="card hidden">
    <div class="toolbar" style="justify-content:flex-start;">
      <span class="pill">1) 로그인</span>
      <input id="email" type="email" placeholder="이메일" style="min-width:260px;">
      <button class="primary" id="btnSendLink">로그인 링크 보내기(메일)</button>
    </div>
    <div class="muted">메일로 온 링크를 누르면 로그인돼.</div>
  </div>

  <!-- 앱 -->
  <div id="appCard" class="card hidden">
    <div class="toolbar" style="justify-content:flex-start;">
      <span class="pill">2) 필터</span>
      <label class="muted">From</label>
      <input id="filterFrom" type="date" value="2026-01-01" />
      <label class="muted">To</label>
      <input id="filterTo" type="date" />
      <select id="filterFlow">
        <option value="all">전체 흐름</option>
        <option value="expense">지출</option>
        <option value="income">수입</option>
        <option value="saving">저축</option>
      </select>
      <select id="filterMember">
        <option value="all">전체 멤버</option>
      </select>
      <input id="filterQ" placeholder="검색(상세/메모)" />
      <button id="btnApplyFilter" class="primary">적용</button>
      <button id="btnReload">새로고침</button>
      <span class="muted" id="count"></span>
    </div>

    <div class="grid2" style="margin-top:10px;">
      <div class="card" style="margin:0;">
        <div class="muted">지출 합계</div>
        <div class="mono" style="font-size:22px;"><span id="sumExpense">0</span> 원</div>
      </div>
      <div class="card" style="margin:0;">
        <div class="muted">수입 합계</div>
        <div class="mono" style="font-size:22px;"><span id="sumIncome">0</span> 원</div>
      </div>
      <div class="card" style="margin:0;">
        <div class="muted">저축 합계</div>
        <div class="mono" style="font-size:22px;"><span id="sumSaving">0</span> 원</div>
      </div>
      <div class="card" style="margin:0;">
        <div class="muted">순현금흐름 (수입-지출)</div>
        <div class="mono" style="font-size:22px;"><span id="sumNet">0</span> 원</div>
      </div>
    </div>

    <div class="card">
      <div class="toolbar" style="justify-content:flex-start;">
        <span class="pill">3) 거래 입력/수정</span>
      </div>

      <form id="entryForm" class="row">
        <input type="hidden" id="editId" value="" />

        <div>
          <label class="muted">날짜</label>
          <input id="entryDate" type="date" required />
        </div>

        <div>
          <label class="muted">멤버(구분)</label>
          <select id="memberSelect" required></select>
        </div>

        <div>
          <label class="muted">흐름</label>
          <select id="flowType" required>
            <option value="expense">지출</option>
            <option value="income">수입</option>
            <option value="saving">저축</option>
          </select>
        </div>

        <div>
          <label class="muted">금액</label>
          <input id="amount" type="number" min="0" step="1" inputmode="numeric" required />
        </div>

        <div>
          <label class="muted">상세항목</label>
          <input id="detail" placeholder="예: 마트, 교통카드" required />
        </div>

        <div>
          <label class="muted">메모</label>
          <input id="memo" placeholder="선택" />
        </div>

        <div style="display:flex; gap:8px;">
          <button id="btnSubmit" class="primary" type="submit">추가</button>
          <button id="btnCancelEdit" type="button" class="hidden">수정 취소</button>
        </div>
      </form>
    </div>

    <div class="card">
      <div class="toolbar" style="justify-content:flex-start;">
        <span class="pill">4) 거래 목록</span>
      </div>
      <table>
        <thead>
          <tr>
            <th>날짜</th>
            <th>흐름</th>
            <th>상세</th>
            <th>분류</th>
            <th class="right">금액</th>
            <th>메모</th>
            <th>관리</th>
          </tr>
        </thead>
        <tbody id="entriesTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- 설정/관리 -->
  <div id="setupCard" class="card hidden">
    <div class="toolbar" style="justify-content:flex-start;">
      <span class="pill">5) 멤버 관리</span>
      <input id="newMemberName" placeholder="멤버 이름(예: 돌프, 천사, 엄마)" />
      <select id="newMemberKind">
        <option value="person">person</option>
        <option value="common">common</option>
      </select>
      <button id="btnAddMember" class="primary">멤버 추가</button>
    </div>
    <div id="memberList" style="display:flex; flex-direction:column; gap:8px;"></div>
  </div>
</body>
</html>
